{% extends "public/base.html" %}

{% block title %}首页 - 五市信息平台{% endblock %}

{% block extra_css %}
<style>
    /* 页面整体动画 */
    /* .fade-in {
        animation: fadeInUp 0.6s ease-out;
    } */

    @keyframes fadeInUp {
        from {
            /* opacity: 0; */
            /* transform: translateY(10px); */
        }
        to {
            /* opacity: 1; */
            /* transform: translateY(0); */
        }
    }

    /* 主要指数卡片 */
    .major-index-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, rgba(59, 130, 246, 0.8) 90%);
        /* background: var(--primary-color); */
        color: white;
        border: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    /* .major-index-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        /* background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); */
        /* background: yellow; */
        /* transition: left 0.5s; */
    /* } */

    /* .major-index-card:hover::before {
        left: 100%;
    } */

    .major-index-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* 普通市场卡片 */
    .market-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        background: white;
        position: relative;
        overflow: hidden;
    }

    /* .market-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    } */

    .market-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: var(--primary-color);
    }

    .market-card:hover::after {
        transform: scaleX(1);
    }

    /* 数值动画 */
    .index-value {
        font-size: 1.4rem;
        font-weight: 700;
        font-family: 'Segoe UI', system-ui, sans-serif;
        position: relative;
    }

    .major-index-card .index-value {
        font-size: 1.8rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* 涨跌幅样式优化 */
    .change-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.8em;
        border-radius: 20px;
        font-weight: 600;
    }

    .bg-success {
        background: linear-gradient(45deg, #10b981, #34d399) !important;
    }

    .bg-danger {
        background: linear-gradient(45deg, #ef4444, #f87171) !important;
    }

    /* 新闻区域 */
    .news-section {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .section-title {
        margin-bottom: 1.5rem;
    }

    .news-item {
        transition: all 0.2s ease;
        border-radius: 10px;
        margin-bottom: 0.5rem;
    }

    /* .news-item:hover {
        background: linear-gradient(50deg, var(--primary-color) 20%, rgba(59, 130, 246, 0.8) 80%);;
        color: white;
        transform: translateX(5px);
    } */
    .news-item:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(5px);
    }

    .news-item:hover * {
        color: white !important;
    }

    .news-item:hover .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    /* AI 研判区域 */
    .ai-insight-container {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .ai-insight-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }

    .ai-insight {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 10px;
        padding: 1.25rem;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
    }

    /* 加载动画 */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        height: 1.2em;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    /* 数据更新指示器 */
    .update-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    /* 趋势图标 */
    .trend-icon {
        font-size: 0.8rem;
        margin-left: 0.25rem;
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
        .major-index-card .index-value {
            font-size: 1.4rem;
        }
        
        .index-value {
            font-size: 1.2rem;
        }
        
        .ai-insight-container {
            margin-top: 2rem;
        }
    }

    /* 数值更新动画 */
    /* .value-update {
        animation: valueChange 0.5s ease-in-out;
    }

    @keyframes valueChange {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); color: var(--accent-color); }
        100% { transform: scale(1); }
    } */
    /* 数值更新动画 - 翻页效果 */
    .value-update {
        position: relative;
        animation: flipValue 0.6s ease-in-out;
        transform-style: preserve-3d;
    }

    @keyframes flipValue {
        0% { 
            transform: rotateX(0deg);
        }
        50% { 
            transform: rotateX(90deg);
            /* color: var(--accent-color); */
        }
        100% { 
            transform: rotateX(0deg);
        }
    }

    /* 增强翻页效果的阴影 */
    .value-update::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
        opacity: 0;
        animation: flipShadow 0.6s ease-in-out;
        pointer-events: none;
        border-radius: 4px;
    }

    @keyframes flipShadow {
        0%, 100% { 
            opacity: 0; 
        }
        50% { 
            opacity: 1; 
        }
    }

    /* 分组标题 */
    .section-title {
        position: relative;
        padding-left: 1rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: var(--primary-gradient);
        border-radius: 2px;
    }


        /* 趋势图标动态效果 */
    .trend-icon {
        font-size: 1rem;
        margin-left: 0.5rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    /* 上涨图标动画 */
/* 更炫酷的动画版本 */
    .trend-icon-up {
        color: #dc3545 !important;
        animation: trendUpGlow 2.5s infinite;
    }

    @keyframes trendUpGlow {
        0%, 100% {
            transform: translateY(0) rotate(0deg) scale(1);
            /*box-shadow: 0 0 0 rgba(220, 53, 69, 0);*/
            filter: brightness(1);
        }
        25% {
            transform: translateY(-1px) rotate(5deg) scale(1.05);
        }
        50% {
            transform: translateY(-2px) rotate(0deg) scale(1.1);
            /*box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);*/
            filter: brightness(1.2);
        }
        75% {
            transform: translateY(-1px) rotate(-5deg) scale(1.05);
        }
    }

    .trend-icon-down {
        color: #28a745 !important;
        animation: trendDownGlow 2.5s infinite;
    }

    @keyframes trendDownGlow {
        0%, 100% {
            transform: translateY(0) rotate(0deg) scale(1);
            /*box-shadow: 0 0 0 rgba(40, 167, 69, 0);*/
            filter: brightness(1);
        }
        25% {
            transform: translateY(1px) rotate(-5deg) scale(1.05);
        }
        50% {
            transform: translateY(2px) rotate(0deg) scale(1.1);
            /*box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);*/
            filter: brightness(1.2);
        }
        75% {
            transform: translateY(1px) rotate(5deg) scale(1.05);
        }
    }


    /* 悬停时暂停动画 */
    .trend-icon:hover {
        animation-play-state: paused;
        transform: scale(1.2);
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
        .major-index-card .index-value {
            font-size: 1.4rem;
        }

        .index-value {
            font-size: 1.2rem;
        }

        .ai-insight-container {
            margin-top: 2rem;
        }

        .trend-icon {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 欢迎信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show border-0" role="alert" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                <i class="bi bi-graph-up-arrow me-2"></i>
                <strong>欢迎访问五市信息平台！</strong> 实时掌握全球市场动态
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- 主要指数 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="section-title mb-0">主要指数</h5>
        <small class="text-muted d-flex align-items-center">
            <span class="update-indicator"></span>
            实时更新：<span id="updateTime">2025-09-29 16:45</span>
        </small>
    </div>

    <div class="row g-3 mb-4">
        <!-- 上证指数 - 主要指数 -->
        {% for item in data.main_market.values() %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card major-index-card">
                <div class="card-body p-3 text-center">
                    <div class="small opacity-75 mb-1">{{ item.name }}</div>
                    <div class="index-value">{{ item.price | round(2) }}</div>
                    <div class="change-indicator justify-content-center">
                        {% if item.change <= 0 %}
                            <span class="badge bg-light text-success">{{ item.change_percent | round(2) }}%</span>
                            <span class="small opacity-70">{{ item.change | round(2) }}</span>
                            <i class="bi bi-caret-down-fill trend-icon trend-icon-down"></i>
                        {% else %}
                            <span class="badge bg-light text-danger">{{ item.change_percent | round(2) }}%</span>
                            <span class="small opacity-70">{{ item.change | round(2) }}</span>
                            <i class="bi bi-trending-down trend-icon"></i>
                            <i class="bi bi-house"></i>
                            <i class="bi bi-caret-up-fill trend-icon trend-icon-up"></i>

                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 其他市场数据 -->
    <h6 class="section-title mb-3">其他市场</h6>
    <div class="row g-3 mb-5">
        <!-- 创业板指 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">创业板指</div>
                        <i class="bi bi-graph-down text-danger"></i>
                    </div>
                    <div class="index-value text-dark">1,987.45</div>
                    <div class="change-indicator">
                        <span class="badge bg-danger">-0.34%</span>
                        <small class="text-muted">-6.78</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 标普500 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">标普500</div>
                        <i class="bi bi-graph-up text-success"></i>
                    </div>
                    <div class="index-value text-dark">5,342.18</div>
                    <div class="change-indicator">
                        <span class="badge bg-success">+0.15%</span>
                        <small class="text-muted">+8.02</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 纳斯达克 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">纳斯达克</div>
                        <i class="bi bi-graph-up text-success"></i>
                    </div>
                    <div class="index-value text-dark">16,890.33</div>
                    <div class="change-indicator">
                        <span class="badge bg-success">+0.45%</span>
                        <small class="text-muted">+75.21</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 美元/人民币 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">USD/CNY</div>
                        <i class="bi bi-currency-exchange text-primary"></i>
                    </div>
                    <div class="index-value text-dark">7.2150</div>
                    <div class="change-indicator">
                        <span class="badge bg-secondary">中间价 7.2100</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 黄金 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">黄金 XAU</div>
                        <i class="bi bi-gem text-warning"></i>
                    </div>
                    <div class="index-value text-dark">$2,345.60</div>
                    <div class="change-indicator">
                        <span class="badge bg-success">+0.80%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 白银 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">白银 XAG</div>
                        <i class="bi bi-circle text-secondary"></i>
                    </div>
                    <div class="index-value text-dark">$28.75</div>
                    <div class="change-indicator">
                        <span class="badge bg-success">+1.20%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 原油 (WTI) -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">WTI 原油</div>
                        <i class="bi bi-droplet text-dark"></i>
                    </div>
                    <div class="index-value text-dark">$78.40</div>
                    <div class="change-indicator">
                        <span class="badge bg-danger">-0.60%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 贵州茅台 -->
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">贵州茅台</div>
                        <i class="bi bi-star-fill text-warning"></i>
                    </div>
                    <div class="index-value text-dark">¥1,720.00</div>
                    <div class="change-indicator">
                        <span class="badge bg-success">+2.10%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新闻 + AI 研判 -->
    <div class="row g-4">
        <!-- 最新财经新闻 -->
        <div class="col-lg-7">
            <div class="news-section">
                <h5 class="section-title mb-3">最新财经新闻</h5>
                <div class="list-group list-group-flush">
                    <a href="/news/1" class="list-group-item list-group-item-action news-item border-0 py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">央行今日开展1000亿元逆回购操作</h6>
                                <p class="mb-1 small text-muted">维护银行体系流动性合理充裕，利率持平于1.80%。</p>
                            </div>
                            <small class="text-muted ms-3">10:30</small>
                        </div>
                    </a>
                    <a href="/news/2" class="list-group-item list-group-item-action news-item border-0 py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">美联储主席暗示年内或降息</h6>
                                <p class="mb-1 small text-muted">称通胀压力缓解，市场预期9月或启动降息周期。</p>
                            </div>
                            <small class="text-muted ms-3">09:15</small>
                        </div>
                    </a>
                    <a href="/news/3" class="list-group-item list-group-item-action news-item border-0 py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">A股半导体板块集体大涨</h6>
                                <p class="mb-1 small text-muted">受国产替代政策利好刺激，多只个股涨停。</p>
                            </div>
                            <small class="text-muted ms-3">08:45</small>
                        </div>
                    </a>
                </div>
                <div class="text-center mt-3">
                    <a href="/news" class="btn btn-outline-primary btn-sm">查看更多新闻</a>
                </div>
            </div>
        </div>

        <!-- AI 市场研判 -->
        <div class="col-lg-5">
            <div class="ai-insight-container">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-robot me-2" style="font-size: 1.5rem;"></i>
                    <h5 class="mb-0">AI 市场研判</h5>
                    <small class="ms-auto opacity-75">DeepSeek</small>
                </div>
                
                <div class="ai-insight">
                    <p class="mb-3">
                        当前全球市场呈现分化走势：美股在科技股带动下企稳反弹，A股受政策预期提振温和放量。
                        人民币汇率保持稳定，黄金因地缘风险溢价维持高位。
                    </p>
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="badge bg-success me-2">看多</span>
                            <small>高股息蓝筹 + AI产业链</small>
                        </div>
                        <div class="text-end">
                            <div class="small opacity-75">风险等级</div>
                            <div class="text-warning">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-half"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 text-end">
                    <small class="opacity-75">更新于：2025-09-29 16:30</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const dataMappring = {
        'sh000001': {selector: '[data-index="sh000001"]', name: '上证指数'},
        'sz399001': {selector: '[data-index="sz399001"]', name: '深证成指'},
        'sz399006': {selector: '[data-index="sz399006"]', name: '创业板指'},
        'hsi': {selector: '[data-index="hsi"]', name: '恒生指数'},
        'djia': {selector: '[data-index="djia"]', name: '道琼斯'},
        'spx': {selector: '[data-index="spx"]', name: '标普500'},
        'ndx': {selector: '[data-index="ndx"]', name: '纳斯达克'},
    }

    let currentData = {};

    // 数据更新动画
    function animateValueUpdate(element) {
        element.classList.add('value-update');
        setTimeout(() => {
            element.classList.remove('value-update');
        }, 600);
    }

    // 更新指数卡片数据
    function updateIndexCard(cardElement, data, animate = false) {
        if (!data || !cardElement) return;

        const priceElement = cardElement.querySelector('.index-price');
        if (priceElement && data.price !== undefiend) {
            if (animate) animateValueUpdate(priceElement)
            priceElement.textContent = parseFloat(data.price).toFixed(2);
        }

        const changeIndicator = cardElement.querySelector('.change-indicator');
        if (changeIndicator && data.change_percent !== undifiend && data.change !== undefiend) {
            const isPositive = data.change > 0;
            const isNegative = data.change < 0;

            changeIndicator.innerHTML = '';
            // 百分比
            const badge = document.createElement('span');
            badge.className = `badge ${isNegative ? 'bg-light text-success' : 'bg-light text-danger' }`
            badge.textContent = `${isPositive ? '+' : ''}${parseFloat(data.change_percent).toFixed(2)}%`
            // 涨跌额
            const changeAmount = document.createElement('span');
            changeAmount.className = 'small opacity-70'
            changeAmount.textContent = `(${isPositive ? '+' : ''}${parseFloat(data.change).toFixed(2)})`

            const trendIcon = document.createElement('i');
            if (isPositive) {
                trendIcon.className = 'bi bi-caret-up-fill trend-icon trend-icon-up';
            } else if (isNegative) {
                trendIcon.className = '\'bi bi-caret-down-fill trend-icon trend-icon-down';
            }

        }

    }

    // 模拟实时数据更新
    function simulateDataUpdate() {
        const values = document.querySelectorAll('.index-value[data-value]');
        values.forEach((element, index) => {
            setTimeout(() => {
                animateValueUpdate(element);
            }, index * 200);
        });
        
        // 更新时间
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('updateTime').textContent = timeString;
    }

    // 每30秒模拟一次数据更新
    setInterval(simulateDataUpdate, 30000);

    // 卡片进入视图动画
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationDelay = Math.random() * 0.3 + 's';
                entry.target.classList.add('fade-in');
            }
        });
    }, observerOptions);

    // 观察所有卡片
    document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
    });
});
</script>
{% endblock %}