{% extends "public/base.html" %}
{% block title %}æ¦œå•ä¸­å¿ƒ - äº”å¸‚ä¿¡æ¯å¹³å°{% endblock %}

{% block extra_css %}
<style>
    /* é¡µé¢æ•´ä½“åŠ¨ç”» */
    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* éšè—åŸæœ‰çš„Tabå¯¼èˆª */
    #rankingTabs {
        display: none;
    }

    /* é€‰é¡¹å¡å®¹å™¨æ ·å¼ - å•è¡Œå¸ƒå±€ */
    .ranking-tabs-container {
        margin-bottom: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    /* é€‰é¡¹å¡ç½‘æ ¼ - å•è¡Œå¸ƒå±€ */
    .ranking-tabs-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    /* é€‰é¡¹å¡å¡ç‰‡æ ·å¼ */
    .ranking-tab {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        white-space: nowrap;
    }

    /* å¸‚åœºæ•°æ®ç±»é€‰é¡¹å¡æ ·å¼ */
    .ranking-tab[data-tab="industry"],
    .ranking-tab[data-tab="stock"],
    .ranking-tab[data-tab="concept"],
    .ranking-tab[data-tab="hot"] {
        background-color: rgba(59, 130, 246, 0.1); /* è“è‰²èƒŒæ™¯ */
        border-color: rgba(59, 130, 246, 0.3);
    }

    /* æ¦œå•ç±»é€‰é¡¹å¡æ ·å¼ */
    .ranking-tab[data-tab="lhb"],
    .ranking-tab[data-tab="zt"],
    .ranking-tab[data-tab="hotup"],
    .ranking-tab[data-tab="hotsearch"] {
        background-color: rgba(16, 185, 129, 0.1); /* ç»¿è‰²èƒŒæ™¯ */
        border-color: rgba(16, 185, 129, 0.3);
    }

    .ranking-tab:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* å¸‚åœºæ•°æ®ç±»é€‰é¡¹å¡æ‚¬åœæ•ˆæœ */
    .ranking-tab[data-tab="industry"]:hover,
    .ranking-tab[data-tab="stock"]:hover,
    .ranking-tab[data-tab="concept"]:hover,
    .ranking-tab[data-tab="hot"]:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    /* æ¦œå•ç±»é€‰é¡¹å¡æ‚¬åœæ•ˆæœ */
    .ranking-tab[data-tab="lhb"]:hover,
    .ranking-tab[data-tab="zt"]:hover,
    .ranking-tab[data-tab="hotup"]:hover,
    .ranking-tab[data-tab="hotsearch"]:hover {
        border-color: #10b981;
        color: #10b981;
    }

    /* å¸‚åœºæ•°æ®ç±»é€‰é¡¹å¡æ¿€æ´»çŠ¶æ€ */
    .ranking-tab[data-tab="industry"].active,
    .ranking-tab[data-tab="stock"].active,
    .ranking-tab[data-tab="concept"].active,
    .ranking-tab[data-tab="hot"].active {
        background: linear-gradient(to right, #3b82f6, #2563eb);
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    /* æ¦œå•ç±»é€‰é¡¹å¡æ¿€æ´»çŠ¶æ€ */
    .ranking-tab[data-tab="lhb"].active,
    .ranking-tab[data-tab="zt"].active,
    .ranking-tab[data-tab="hotup"].active,
    .ranking-tab[data-tab="hotsearch"].active {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        border-color: #10b981;
        box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);
    }

    .ranking-tab i {
        font-size: 0.9rem;
    }

    /* åˆ†éš”ç¬¦æ ·å¼ */
    .ranking-separator {
        width: 1px;
        height: 24px;
        background-color: #e2e8f0;
        margin: 0 0.5rem;
    }

    /* å‘¨æœŸ/æ± æŒ‰é’®ç»„ */
    .period-btn, .zt-pool-btn, .market-btn {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 0.875rem;
        padding: 0.35rem 0.75rem;
        transition: all 0.2s ease;
        border-radius: 6px;
    }

    .period-btn:hover, .zt-pool-btn:hover, .market-btn:hover {
        background-color: #e9ecef;
        color: #0d6efd;
    }

    .period-btn.active, .zt-pool-btn.active, .market-btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
    }

    /* è¡¨æ ¼ä¼˜åŒ– */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    table.table {
        margin-bottom: 0;
        table-layout: fixed;
        width: 100%;
    }

    table.table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    table.table tbody tr {
        transition: background-color 0.2s ease;
    }

    table.table tbody tr:hover {
        background-color: #f1f5ff !important;
    }

    table.table td {
        padding: 0.7rem 1rem;
        vertical-align: middle;
        word-wrap: break-word;
        white-space: normal;
        overflow: hidden;
    }

    /* å†…å®¹åŒºåŸŸç»Ÿä¸€é«˜åº¦ */
    .industry-content,
    .stock-content,
    .concept-content,
    .lhb-content,
    .hot-content,
    .zt-content,
    .hotup-content,
    .hotsearch-content {
        min-height: 400px;
        position: relative;
    }

    /* åŠ è½½çŠ¶æ€ */
    .text-center.py-3 {
        padding: 2rem !important;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }

    /* åŠ è½½çŠ¶æ€å±…ä¸­ä¸”ä¸æ”¹å˜å¸ƒå±€ */
    .industry-content > div.text-center,
    .stock-content > div.text-center,
    .concept-content > div.text-center,
    .lhb-content > div.text-center,
    .hot-content > div.text-center,
    .zt-content > div.text-center,
    .hotup-content > div.text-center,
    .hotsearch-content > div.text-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        text-align: center;
        padding: 0;
    }

    /* æŒ‰é’®ç»„é—´è·ä¼˜åŒ– */
    .d-flex.gap-2 {
        flex-wrap: wrap;
    }

    /* Tab å†…å®¹åˆ‡æ¢åŠ¨ç”» */
    .tab-content {
        position: relative;
        min-height: 500px;
    }

    .tab-pane {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .tab-pane.active {
        display: block;
        opacity: 1;
    }

    /* ç¡®ä¿åªæœ‰ä¸€ä¸ªpaneå¯è§ */
    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    /* æ’åºè¡¨å¤´ä¼˜åŒ– */
    th.sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    th.sortable i {
        vertical-align: middle;
        margin-left: 0.3rem;
        transition: opacity 0.2s;
    }

    th.sortable:hover i {
        opacity: 0.8;
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
        .container.py-4 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        h2.mb-4 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .ranking-tabs-container {
            padding: 0.5rem 0.75rem;
        }

        .ranking-tab {
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
        }

        .ranking-tab i {
            font-size: 0.8rem;
        }

        .tab-content {
            min-height: 400px;
        }

        .industry-content,
        .stock-content,
        .concept-content,
        .lhb-content,
        .hot-content,
        .zt-content,
        .hotup-content,
        .hotsearch-content {
            min-height: 300px;
        }
    }

    /* åˆ—å®½ä¼˜åŒ– */
    table.table th:nth-child(1), table.table td:nth-child(1) {
        width: 8%;
    }

    table.table th:nth-child(2), table.table td:nth-child(2) {
        width: 12%;
    }

    table.table th:nth-child(3), table.table td:nth-child(3) {
        width: 15%;
    }

    table.table th:nth-child(4), table.table td:nth-child(4) {
        width: 10%;
    }

    table.table th:nth-child(5), table.table td:nth-child(5) {
        width: 10%;
    }

    table.table th:nth-child(6), table.table td:nth-child(6) {
        width: 12%;
    }

    table.table th:nth-child(7), table.table td:nth-child(7) {
        width: 12%;
    }

    table.table th:nth-child(8), table.table td:nth-child(8) {
        width: 10%;
    }

    table.table th:nth-child(9), table.table td:nth-child(9) {
        width: 11%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <h2 class="mb-4">ğŸ“Š æ¦œå•ä¸­å¿ƒ</h2>

    <!-- æ–°çš„é€‰é¡¹å¡å¸ƒå±€ - å•è¡Œå¸ƒå±€ï¼Œç”¨èƒŒæ™¯è‰²åŒºåˆ†ç»„åˆ« -->
    <div class="ranking-tabs-container">
        <div class="ranking-tabs-grid">
            <!-- å¸‚åœºæ•°æ®ç±» -->
            <div class="ranking-tab active" data-tab="industry" data-bs-toggle="tab" data-bs-target="#industry">
                <i class="bi bi-building"></i>
                <span>è¡Œä¸š</span>
            </div>
            <div class="ranking-tab" data-tab="stock" data-bs-toggle="tab" data-bs-target="#stock">
                <i class="bi bi-graph-up"></i>
                <span>ä¸ªè‚¡</span>
            </div>
            <div class="ranking-tab" data-tab="concept" data-bs-toggle="tab" data-bs-target="#concept">
                <i class="bi bi-lightbulb"></i>
                <span>æ¦‚å¿µ</span>
            </div>
            <div class="ranking-tab" data-tab="hot" data-bs-toggle="tab" data-bs-target="#hot">
                <i class="bi bi-fire"></i>
                <span>çƒ­é—¨è‚¡</span>
            </div>

            <!-- åˆ†éš”ç¬¦ -->
            <div class="ranking-separator"></div>

            <!-- æ¦œå•ç±» -->
            <div class="ranking-tab" data-tab="lhb" data-bs-toggle="tab" data-bs-target="#lhb">
                <i class="bi bi-trophy"></i>
                <span>é¾™è™æ¦œ</span>
            </div>
            <div class="ranking-tab" data-tab="zt" data-bs-toggle="tab" data-bs-target="#zt">
                <i class="bi bi-arrow-up-circle"></i>
                <span>æ¶¨åœè‚¡æ± </span>
            </div>
            <div class="ranking-tab" data-tab="hotup" data-bs-toggle="tab" data-bs-target="#hotup">
                <i class="bi bi-rocket"></i>
                <span>é£™å‡æ¦œ</span>
            </div>
            <div class="ranking-tab" data-tab="hotsearch" data-bs-toggle="tab" data-bs-target="#hotsearch">
                <i class="bi bi-search"></i>
                <span>çƒ­æœæ¦œ</span>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content mt-3" id="rankingTabContent">
        <!-- è¡Œä¸š -->
        <div class="tab-pane fade show active" id="industry" role="tabpanel">
            <div class="d-flex gap-2 mb-3">
                {% for period in ['latest', '3d', '5d', '10d', '20d'] %}
                <button class="btn btn-outline-secondary btn-sm period-btn {% if period=='latest' %}active{% endif %}"
                        data-period="{{ period }}">
                    {{
                    period|replace('latest','æœ€æ–°')|replace('3d','3æ—¥')|replace('5d','5æ—¥')|replace('10d','10æ—¥')|replace('20d','20æ—¥')
                    }}
                </button>
                {% endfor %}
            </div>
            <div class="industry-content">ç‚¹å‡»åŠ è½½æ•°æ®...</div>
        </div>

        <!-- ä¸ªè‚¡ -->
        <div class="tab-pane fade" id="stock" role="tabpanel">
            <div class="d-flex gap-2 mb-3">
                {% for period in ['latest', '3d', '5d', '10d', '20d'] %}
                <button class="btn btn-outline-secondary btn-sm period-btn {% if period=='latest' %}active{% endif %}"
                        data-period="{{ period }}">
                    {{
                    period|replace('latest','æœ€æ–°')|replace('3d','3æ—¥')|replace('5d','5æ—¥')|replace('10d','10æ—¥')|replace('20d','20æ—¥')
                    }}
                </button>
                {% endfor %}
            </div>
            <div class="stock-content">ç‚¹å‡»åŠ è½½æ•°æ®...</div>
        </div>

        <!-- æ¦‚å¿µ -->
        <div class="tab-pane fade" id="concept" role="tabpanel">
            <div class="d-flex gap-2 mb-3">
                {% for period in ['latest', '3d', '5d', '10d', '20d'] %}
                <button class="btn btn-outline-secondary btn-sm period-btn {% if period=='latest' %}active{% endif %}"
                        data-period="{{ period }}">
                    {{
                    period|replace('latest','æœ€æ–°')|replace('3d','3æ—¥')|replace('5d','5æ—¥')|replace('10d','10æ—¥')|replace('20d','20æ—¥')
                    }}
                </button>
                {% endfor %}
            </div>
            <div class="concept-content">ç‚¹å‡»åŠ è½½æ•°æ®...</div>
        </div>

        <!-- é¾™è™æ¦œ -->
        <div class="tab-pane fade" id="lhb" role="tabpanel">
            <div class="lhb-content">åŠ è½½ä¸­...</div>
        </div>

        <!-- çƒ­é—¨è‚¡ -->
        <div class="tab-pane fade" id="hot" role="tabpanel">
            <div class="hot-content">åŠ è½½ä¸­...</div>
        </div>

        <!-- æ¶¨åœè‚¡æ±  -->
        <div class="tab-pane fade" id="zt" role="tabpanel">
            <div class="d-flex gap-2 mb-3">
                {% for pool in ['today', 'yesterday', 'strong', 'down'] %}
                <button class="btn btn-outline-secondary btn-sm zt-pool-btn {% if pool=='today' %}active{% endif %}"
                        data-pool="{{ pool }}">
                    {{
                    pool|replace('today','ä»Šæ—¥æ¶¨åœ')|replace('yesterday','æ˜¨æ—¥æ¶¨åœ')|replace('strong','å¼ºåŠ¿è‚¡')|replace('down','è·Œåœè‚¡')
                    }}
                </button>
                {% endfor %}
            </div>
            <div class="zt-content">åŠ è½½ä¸­...</div>
        </div>

        <!-- é£™å‡æ¦œ -->
        <div class="tab-pane fade" id="hotup" role="tabpanel">
            <div class="hotup-content">åŠ è½½ä¸­...</div>
        </div>

        <!-- çƒ­æœæ¦œ -->
        <div class="tab-pane fade" id="hotsearch" role="tabpanel">
            <div class="d-flex gap-2 mb-3">
                {% for market in ['ag', 'hk', 'us'] %}
                <button class="btn btn-outline-secondary btn-sm market-btn {% if market=='ag' %}active{% endif %}"
                        data-market="{{ market }}">
                    {{
                    market|replace('ag','Aè‚¡')|replace('hk','æ¸¯è‚¡')|replace('us','ç¾è‚¡')
                    }}
                </button>
                {% endfor %}
            </div>
            <div class="hotsearch-content">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // æ›´æ–°é€‰æ‹©å™¨ä»¥åŒ¹é…æ–°çš„é€‰é¡¹å¡ç»“æ„
        const tabs = document.querySelectorAll('.ranking-tab[data-bs-toggle="tab"]');
        const periodBtns = document.querySelectorAll('.period-btn');
        const ztPoolBtns = document.querySelectorAll('.zt-pool-btn');
        const marketBtns = document.querySelectorAll('.market-btn');

        // å­˜å‚¨å½“å‰æ’åºçŠ¶æ€
        let currentSort = {
            field: null,
            direction: 'asc' // 'asc' æˆ– 'desc'
        };

        // å­˜å‚¨å½“å‰æ•°æ®
        let currentData = null;
        let currentType = null;

        marketBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const market = this.dataset.market;
                const tabPane = document.getElementById('hotsearch');
                tabPane.querySelectorAll('.market-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadBoardData('hotsearch', market, tabPane.querySelector('.hotsearch-content'));
            });
        });

        periodBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const period = this.dataset.period;
                const tabPane = this.closest('.tab-pane');
                const type = tabPane.id;

                tabPane.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                loadBoardData(type, period, tabPane.querySelector(`.${type}-content`));
            });
        });

        ztPoolBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const pool = this.dataset.pool;
                const tabPane = document.getElementById('zt');
                tabPane.querySelectorAll('.zt-pool-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                loadBoardData('zt', pool, tabPane.querySelector('.zt-content'));
            });
        });

        function smoothTabSwitch(targetTab) {
            const allPanes = document.querySelectorAll('.tab-pane');
            const targetPane = document.querySelector(targetTab);

            allPanes.forEach(pane => {
                pane.classList.remove('active', 'show');
            });

            setTimeout(() => {
                targetPane.classList.add('active', 'show');
            }, 50);
        }

        // æ›¿æ¢ä½ ç°æœ‰çš„tabs.forEach(tab => {...})éƒ¨åˆ†
        tabs.forEach(tab => {
            tab.addEventListener('click', function (e) {
                e.preventDefault();

                // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„activeç±»
                tabs.forEach(t => t.classList.remove('active'));
                // æ·»åŠ å½“å‰é€‰é¡¹å¡çš„activeç±»
                this.classList.add('active');

                // è·å–ç›®æ ‡é¢æ¿
                const target = this.getAttribute('data-bs-target');
                const targetPane = document.querySelector(target);

                // éšè—æ‰€æœ‰é¢æ¿
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active', 'show');
                });

                // æ˜¾ç¤ºç›®æ ‡é¢æ¿
                targetPane.classList.add('active', 'show');

                const type = target.replace('#', '');
                const contentEl = document.querySelector(`${target} .${type}-content`);

                if (contentEl && (contentEl.innerText.includes('åŠ è½½ä¸­') || contentEl.innerText.includes('ç‚¹å‡»åŠ è½½'))) {
                    let period = null;

                    if (type === 'industry' || type === 'stock' || type === 'concept') {
                        const activePeriodBtn = document.querySelector(`${target} .period-btn.active`);
                        period = activePeriodBtn ? activePeriodBtn.dataset.period : 'latest';
                    } else if (type === 'zt') {
                        const activePoolBtn = document.querySelector(`${target} .zt-pool-btn.active`);
                        period = activePoolBtn ? activePoolBtn.dataset.pool : 'today';
                    } else if (type === 'hotsearch') {
                        const activeMarketBtn = document.querySelector(`${target} .market-btn.active`);
                        period = activeMarketBtn ? activeMarketBtn.dataset.market : 'ag';
                    }

                    loadBoardData(type, period, contentEl);
                }
            });
        });

        // é¦–æ¬¡åŠ è½½è¡Œä¸šæœ€æ–°æ•°æ®
        loadBoardData('industry', 'latest', document.querySelector('.industry-content'));

        function loadBoardData(type, period, container) {
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm" role="status"></div> åŠ è½½ä¸­...</div>';

            let url = `/api/board/${type}/`;
            if (period) {
                url += `${period}/`;
            }

            console.log('Loading data from:', url);

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    currentData = data;
                    currentType = type;
                    currentSort = {field: null, direction: 'asc'};
                    container.innerHTML = renderRankingTable(type, data);
                })
                .catch(err => {
                    console.error('åŠ è½½å¤±è´¥:', err);
                    container.innerHTML = `<div class="alert alert-warning">åŠ è½½å¤±è´¥ï¼š${err.message}</div>`;
                });
        }

        // æ’åºå‡½æ•°
        function sortData(data, field, direction) {
            return [...data].sort((a, b) => {
                let aValue = a[field];
                let bValue = b[field];

                // å¤„ç†ç©ºå€¼
                if (aValue === null || aValue === undefined) aValue = direction === 'asc' ? Infinity : -Infinity;
                if (bValue === null || bValue === undefined) bValue = direction === 'asc' ? Infinity : -Infinity;

                // å¤„ç†å­—ç¬¦ä¸²å’Œæ•°å­—
                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // è¡¨å¤´ç‚¹å‡»æ’åºäº‹ä»¶
        function handleHeaderClick(field, container, type) {
            return function () {
                if (!currentData) return;

                // åˆ‡æ¢æ’åºæ–¹å‘
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }

                // æ’åºæ•°æ®
                const sortedData = sortData(currentData, field, currentSort.direction);

                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                container.innerHTML = renderRankingTable(type, sortedData);
            };
        }

        function renderRankingTable(type, data) {
            if (!data || data.length === 0) {
                return '<div class="text-muted">æš‚æ— æ•°æ®</div>';
            }

            let html = `<div class="table-responsive"><table class="table table-hover table-sm align-middle mb-0">`;

            // è¡¨å¤´æ ¹æ®ç±»å‹åŠ¨æ€ç”Ÿæˆï¼Œæ·»åŠ æ’åºåŠŸèƒ½
            if (type === 'industry') {
                html += `<thead><tr>
            <th class="sortable" data-field="industry_name">è¡Œä¸šåç§° ${getSortIcon('industry_name')}</th>
            <th class="sortable" data-field="industry_index">è¡Œä¸šæŒ‡æ•° ${getSortIcon('industry_index')}</th>
            <th class="sortable" data-field="industry_index_change_rate">æ¶¨è·Œå¹… ${getSortIcon('industry_index_change_rate')}</th>
            <th class="sortable" data-field="net_amount">å‡€é¢(äº¿) ${getSortIcon('net_amount')}</th>
            <th class="sortable" data-field="inflow_volume">æµå…¥èµ„é‡‘ ${getSortIcon('inflow_volume')}</th>
            <th class="sortable" data-field="outflow_volume">æµå‡ºèµ„é‡‘ ${getSortIcon('outflow_volume')}</th>
            <th class="sortable" data-field="company_num">å…¬å¸æ•°é‡ ${getSortIcon('company_num')}</th>
            <th>é¾™å¤´è‚¡</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.industry_index_change_rate > 0 ? 'text-danger' : 'text-success';
                    const net = (item.net_amount / 1e8).toFixed(2);
                    html += `<tr>
                <td>${item.industry_name}</td>
                <td>${item.industry_index?.toFixed(2) || '--'}</td>
                <td class="${changeClass}">${(item.industry_index_change_rate || 0).toFixed(2)}%</td>
                <td>${item.net_amount?.toFixed(2)}</td>
                <td>${item.inflow_volume}</td>
                <td>${item.outflow_volume}</td>
                <td>${item.company_num || '--'}</td>
                <td>${item.leading_stock || '--'}</td>
            </tr>`;
                });
            } else if (type === 'stock') {
                const sampleItem = data[0];
                const isLatest = sampleItem && (
                    sampleItem.inflow_volume !== undefined ||
                    sampleItem.outflow_volume !== undefined
                );

                html += `<thead><tr>
            <th class="sortable" data-field="stock_code">ä»£ç  ${getSortIcon('stock_code')}</th>
            <th class="sortable" data-field="stock_name">åç§° ${getSortIcon('stock_name')}</th>
            <th class="sortable" data-field="current_price">æœ€æ–°ä»· ${getSortIcon('current_price')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
            ${isLatest ?
                    `<th class="sortable" data-field="inflow_volume">æµå…¥èµ„é‡‘(äº¿) ${getSortIcon('inflow_volume')}</th>
                 <th class="sortable" data-field="outflow_volume">æµå‡ºèµ„é‡‘(äº¿) ${getSortIcon('outflow_volume')}</th>` : ''}
            <th class="sortable" data-field="net_amount">å‡€é¢(äº¿) ${getSortIcon('net_amount')}</th>
            <th class="sortable" data-field="turnover_rate">æ¢æ‰‹ç‡ ${getSortIcon('turnover_rate')}</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    const net = (item.net_amount / 1e8).toFixed(2);

                    const formatAmount = (amount) => {
                        if (!amount && amount !== 0) return '--';
                        return (amount / 1e8).toFixed(2);
                    };

                    const inflow = formatAmount(item.inflow_volume);
                    const outflow = formatAmount(item.outflow_volume);

                    html += `<tr>
                <td>${item.stock_code}</td>
                <td>${item.stock_name}</td>
                <td>${item.current_price?.toFixed(2) || '--'}</td>
                <td class="${changeClass}">${(item.change_rate || 0).toFixed(2)}%</td>
                ${isLatest ? `<td>${inflow}</td><td>${outflow}</td>` : ''}
                <td>${net}</td>
                <td>${item.turnover_rate ? item.turnover_rate.toFixed(2) + '%' : item.continuous_turnover_rate.toFixed(2) + '%'}</td>
            </tr>`;
                });
            } else if (type === 'concept') {
                html += `<thead><tr>
            <th class="sortable" data-field="concept_name">æ¦‚å¿µåç§° ${getSortIcon('concept_name')}</th>
            <th class="sortable" data-field="concept_index">æ¦‚å¿µæŒ‡æ•° ${getSortIcon('concept_index')}</th>
            <th class="sortable" data-field="concept_index_change_rate">æ¶¨è·Œå¹… ${getSortIcon('concept_index_change_rate')}</th>
            <th class="sortable" data-field="net_amount">å‡€é¢(äº¿) ${getSortIcon('net_amount')}</th>
            <th class="sortable" data-field="inflow_volume">æµå…¥èµ„é‡‘ ${getSortIcon('inflow_volume')}</th>
            <th class="sortable" data-field="outflow_volume">æµå‡ºèµ„é‡‘ ${getSortIcon('outflow_volume')}</th>
            <th class="sortable" data-field="company_num">å…¬å¸æ•°é‡ ${getSortIcon('company_num')}</th>
            <th>é¢†æ¶¨è‚¡</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = (item.concept_index_change_rate || item.change_rate) > 0 ? 'text-danger' : 'text-success';
                    html += `<tr>
                <td>${item.concept_name}</td>
                <td>${item.concept_index ? item.concept_index.toFixed(2) : '--'}</td>
                <td class="${changeClass}">${(item.concept_index_change_rate || item.change_rate || 0).toFixed(2)}%</td>
                <td>${item.net_amount}</td>
                <td>${item.inflow_volume}</td>
                <td>${item.outflow_volume}</td>
                <td>${item.company_num || '--'}</td>
                <td>${item.leading_stock || '--'}</td>
            </tr>`;
                });
            } else if (type === 'lhb') {
                html += `<thead><tr>
            <th class="sortable" data-field="stock_code">ä»£ç  ${getSortIcon('stock_code')}</th>
            <th class="sortable" data-field="stock_name">åç§° ${getSortIcon('stock_name')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
            <th class="sortable" data-field="lhb_net_buy_amount">å‡€ä¹°é¢(äº¿) ${getSortIcon('lhb_net_buy_amount')}</th>
            <th>ä¸Šæ¦œåŸå› </th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    const net = (item.lhb_net_buy_amount / 1e8).toFixed(2);
                    html += `<tr>
                <td>${item.stock_code}</td>
                <td>${item.stock_name}</td>
                <td class="${changeClass}">${(item.change_rate || 0).toFixed(2)}%</td>
                <td>${net}</td>
                <td class="small">${item.listing_reason || '--'}</td>
            </tr>`;
                });
            } else if (type === 'hot') {
                html += `<thead><tr>
            <th class="sortable" data-field="stock_code">ä»£ç  ${getSortIcon('stock_code')}</th>
            <th class="sortable" data-field="stock_name">åç§° ${getSortIcon('stock_name')}</th>
            <th class="sortable" data-field="latest_price">æœ€æ–°ä»· ${getSortIcon('latest_price')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    html += `<tr>
                <td>${item.stock_code}</td>
                <td>${item.stock_name}</td>
                <td>${item.latest_price?.toFixed(2) || '--'}</td>
                <td class="${changeClass}">${(item.change_rate || 0).toFixed(2)}%</td>
            </tr>`;
                });
            } else if (type === 'zt') {
                html += `<thead><tr>
            <th class="sortable" data-field="stock_code">ä»£ç  ${getSortIcon('stock_code')}</th>
            <th class="sortable" data-field="stock_name">åç§° ${getSortIcon('stock_name')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
            <th class="sortable" data-field="latest_price">æœ€æ–°ä»· ${getSortIcon('latest_price')}</th>
            <th class="sortable" data-field="consecutive_boards">è¿æ¿æ•° ${getSortIcon('consecutive_boards')}</th>
            <th class="sortable" data-field="industry">æ‰€å±è¡Œä¸š ${getSortIcon('industry')}</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    html += `<tr>
                <td>${item.stock_code}</td>
                <td>${item.stock_name}</td>
                <td class="${changeClass}">${(item.change_rate || 0).toFixed(2)}%</td>
                <td>${item.latest_price?.toFixed(2) || '--'}</td>
                <td>${item.consecutive_boards || item.previous_consecutive_boards || '--'}</td>
                <td>${item.industry || '--'}</td>
            </tr>`;
                });
            } else if (type === 'hotup') {
                html += `<thead><tr>
            <th class="sortable" data-field="stock_code">ä»£ç  ${getSortIcon('stock_code')}</th>
            <th class="sortable" data-field="stock_name">åç§° ${getSortIcon('stock_name')}</th>
            <th class="sortable" data-field="latest_price">æœ€æ–°ä»· ${getSortIcon('latest_price')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
            <th class="sortable" data-field="change_amount">æ¶¨è·Œé¢ ${getSortIcon('change_amount')}</th>
            <th class="sortable" data-field="rank_change">æ’åå˜åŒ– ${getSortIcon('rank_change')}</th>
            <th class="sortable" data-field="update_time">æ›´æ–°æ—¶é—´ ${getSortIcon('update_time')}</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const changeClass = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    const rankChange = item.rank_change > 0 ?
                        `<span class="text-danger">â†‘${item.rank_change}</span>` :
                        item.rank_change < 0 ?
                            `<span class="text-success">â†“${Math.abs(item.rank_change)}</span>` :
                            '<span class="text-muted">-</span>';

                    html += `<tr>
                <td>${item.stock_code}</td>
                <td>${item.stock_name}</td>
                <td>${item.latest_price?.toFixed(2) || '--'}</td>
                <td class="${changeClass}">${(item.change_rate || 0).toFixed(2)}%</td>
                <td>${item.change_amount?.toFixed(2) || '--'}</td>
                <td>${rankChange}</td>
                <td class="small text-muted">${item.update_time ? new Date(item.update_time).toLocaleString() : '--'}</td>
            </tr>`;
                });
            } else if (type === 'hotsearch') {
                html += `<thead><tr>
            <th class="sortable" data-field="stock_name_code">åç§° ${getSortIcon('stock_name_code')}</th>
            <th class="sortable" data-field="comprehensive_heat">ç»¼åˆçƒ­åº¦ ${getSortIcon('comprehensive_heat')}</th>
            <th class="sortable" data-field="change_rate">æ¶¨è·Œå¹… ${getSortIcon('change_rate')}</th>
            <th class="sortable" data-field="update_time">æ›´æ–°æ—¶é—´ ${getSortIcon('update_time')}</th>
        </tr></thead>`;
                html += '<tbody>';
                data.forEach((item, index) => {
                    const change_rate_class = item.change_rate > 0 ? 'text-danger' : 'text-success';
                    html += `<tr>
                <td>${item.stock_name_code || '--'}</td>
                <td class="text-danger"><i class="bi bi-caret-up-fill"></i>${item.comprehensive_heat || '--'}</td>
                <td class="${change_rate_class}">${item.change_rate || '--'}</td>
                <td class="small text-muted">${item.update_time ? new Date(item.update_time).toLocaleString() : '--'}</td>
            </tr>`;
                });
            }

            html += '</tbody></table></div>';

            // æ·»åŠ æ’åºäº‹ä»¶ç›‘å¬
            setTimeout(() => {
                const container = document.querySelector(`.${type}-content`);
                const sortableHeaders = container.querySelectorAll('th.sortable');
                sortableHeaders.forEach(header => {
                    header.addEventListener('click', handleHeaderClick(
                        header.dataset.field,
                        container,
                        type
                    ));
                });
            }, 0);

            return html;
        }

        function getSortIcon(field) {
            if (currentSort.field === field) {
                if (currentSort.direction === 'asc') {
                    return '<i class="bi bi-arrow-up-short text-muted"></i>';
                } else {
                    return '<i class="bi bi-arrow-down-short text-muted"></i>';
                }
            }
            // æœªæ’åºæ—¶æ˜¾ç¤ºä¸­æ€§å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
            return '<i class="bi bi-arrow-down-up text-secondary" style="font-size:0.8em; opacity:0.4;"></i>';
        }
    });
</script>

{% endblock %}