{% extends "public/base.html" %}

{% block title %}财经新闻 - 五市信息平台{% endblock %}

{% block extra_css %}
<style>
    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 区域标题 */
    .region-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 1.5rem 0 0.75rem;
        padding-bottom: 0.5rem;
        /*border-bottom: 2px solid var(--primary-color);*/
    }

    /* 自定义表格容器 */
    .market-table {
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-secondary);
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* 表头 */
    .market-table thead th {
        /*background: var(--primary-gradient);*/
        background-color: #397ff1;
        color: white;
        font-weight: 600;
        padding: 12px 16px;
        text-align: center;
        font-size: 0.95rem;
    }

    /* 表格行 */
    .market-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .market-table tbody tr:hover {
        background-color: rgba(248, 250, 252, 0.7);
    }

    .market-table tbody td,
    .market-table tbody th {
        padding: 12px 16px;
        text-align: center;
        border: none;
        font-size: 0.95rem;
        color: #334155;
    }

    /* 指数名称加粗 */
    .market-table tbody th {
        font-weight: 600;
        text-align: left;
    }

    /* 涨跌幅颜色 */
    .change-up {
        color: #047857 !important; /* 绿色上涨 */
        font-weight: 600;
    }

    .change-down {
        color: #dc2626 !important; /* 红色下跌 */
        font-weight: 600;
    }

    /* 响应式：小屏时缩小内边距 */
    @media (max-width: 768px) {
        .market-table thead th,
        .market-table tbody td,
        .market-table tbody th {
            padding: 10px 8px;
            font-size: 0.875rem;
        }

        .region-title {
            font-size: 1.1rem;
            margin-top: 1.25rem;
        }
    }

    .text-success {
        color: #047857 !important;
    }

    .text-danger {
        color: #dc2626 !important;
    }

    /* 自定义开关样式 */
    .form-check-input:checked {
        background-color: #397ff1;
        border-color: #397ff1;
    }

    .form-check-input:focus {
        border-color: #397ff1;
        box-shadow: 0 0 0 0.25rem rgba(57, 127, 241, 0.25);
    }

    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 fade-in">
    <div class="col-md-8">
        <!-- 添加控制按钮 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">全球股指行情</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggleAllBtn">
                <label class="form-check-label" for="toggleAllBtn">全部展开</label>
            </div>
        </div>

        <div class="accordion" id="stockIndexAccordion">
            {% for region, indexes in ordered_result.items() %}
            {% if indexes %}
            {% set collapse_id = "collapse-" + loop.index|string %}
            {% set heading_id = "heading-" + loop.index|string %}
            {% set is_expanded = loop.index0 < 2 %}  <!-- 前两个项目展开 (索引0和1) -->

            <div class="accordion-item">
                <h2 class="accordion-header" id="{{ heading_id }}">
                    <button
                            class="accordion-button{% if not is_expanded %} collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#{{ collapse_id }}"
                            aria-expanded="{{ 'true' if is_expanded else 'false' }}"
                            aria-controls="{{ collapse_id }}">
                        {{ region }}
                    </button>
                </h2>
                <div
                        id="{{ collapse_id }}"
                        class="accordion-collapse collapse{% if is_expanded %} show{% endif %}"
                        aria-labelledby="{{ heading_id }}">
                    <div class="accordion-body">
                        <div class="market-table">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>指数名称</th>
                                    <th>最新价</th>
                                    <th>涨跌幅</th>
                                    <th>涨跌额</th>
                                    <th>更新时间</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for index in indexes %}
                                <tr>
                                    <th scope="row">{{ index.name }}</th>
                                    <td>{{ index.price }}</td>
                                    <td class="{% if index.change_percent|float >= 0 %}change-down{% else %}change-up{% endif %}">
                                        {{ '%+.2f'|format(index.change_percent|float) }}%
                                    </td>
                                    <td class="{% if index.change|float >= 0 %}change-down{% else %}change-up{% endif %}">
                                        {{ '%+.2f'|format(index.change|float) }}
                                    </td>
                                    <td>{{ index.timestamp }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>


    <div class="col-md-4">
        <div class="card market-table" style="height: fit-content; box-shadow: var(--shadow-secondary);">
            <div class="card-header py-2" style="background-color: #303b4e; color: white;">
                <h6 class="mb-0 text-center" style="font-weight: 600; font-size: 0.95rem;">国债收益率（%）</h6>
            </div>
            <div class="card-body p-3">
                <div class="row g-5 align-items-center"> <!-- 使用 g-3 增加列间距 -->
                    <!-- 中国 -->
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <small class="fw-bold" style="color: #dc2626;">🇨🇳 中国</small>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between py-1">
                                <span>2年</span>
                                <span class="fw-bold">{{ cn_bond.cn_2y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>5年</span>
                                <span class="fw-bold">{{ cn_bond.cn_5y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>10年</span>
                                <span class="fw-bold">{{ cn_bond.cn_10y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>30年</span>
                                <span class="fw-bold">{{ cn_bond.cn_30y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1 mt-2 border-top"
                                 style="border-color: rgba(0,0,0,0.08);">
                                <span>利差</span>
                                <span class="fw-bold {% if cn_bond.cn_spread_10y_2y|float > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ cn_bond.cn_spread_10y_2y }}
              </span>
                            </div>
                        </div>
                    </div>

                    <!-- 美国 -->
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <small class="fw-bold" style="color: #397ff1;">🇺🇸 美国</small>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between py-1">
                                <span>2年</span>
                                <span class="fw-bold">{{ us_bond.us_2y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>5年</span>
                                <span class="fw-bold">{{ us_bond.us_5y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>10年</span>
                                <span class="fw-bold">{{ us_bond.us_10y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>30年</span>
                                <span class="fw-bold">{{ us_bond.us_30y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1 mt-2 border-top"
                                 style="border-color: rgba(0,0,0,0.08);">
                                <span>利差</span>
                                <span class="fw-bold {% if us_bond.us_spread_10y_2y|float > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ us_bond.us_spread_10y_2y }}
              </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === 新增：解读文字 === -->
                <div class="mt-3 pt-2 border-top" style="border-color: rgba(0,0,0,0.06);">
                    <p class="small text-muted mb-0" style="line-height: 1.5;">
                        中美利率呈现“东边日出西边雨”的格局：美国为抗通胀维持高利率，中国为稳增长处于低利率周期。
                        巨大的利差给人民币带来贬值压力，并制约了中国央行的降息空间。
                    </p>
                </div>

            </div>
        </div>

        <!-- === 商品期货行情 === -->
        <div class="mt-4">
            <h6 class="fw-bold text-muted mb-3">商品期货</h6>
            <div class="small">
                {% for item in commodities %}
                <div class="d-flex justify-content-between py-1 align-items-center border-bottom"
                     style="border-color: rgba(0,0,0,0.06);">
                    <div>
                        <span class="me-2">{{ item.name }}</span>
                        <small class="text-muted">{{ item.symbol }}</small>
                    </div>
                    <div class="text-end">
                        <div>
                            <span class="fw-bold">{{ item.rmb_price | round(2) }}</span>
                            <span class="ms-1 {% if item.change_amount|float > 0 %}text-danger{% else %}text-success{% endif %}">
                        {% if item.change_amount|float > 0 %}+{% endif %}{{ item.change_amount | round(2) }}
                    </span>
                        </div>
                        <div class="text-muted small">
                            ({{ item.change_percent }}%)
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleAllBtn = document.getElementById('toggleAllBtn');
        const toggleLabel = document.querySelector('.form-check-label');

        // 初始化状态
        updateToggleLabel(toggleAllBtn.checked);

        toggleAllBtn.addEventListener('change', function () {
            updateToggleLabel(this.checked);

            if (this.checked) {
                // 展开所有
                const collapses = document.querySelectorAll('.accordion-collapse');
                collapses.forEach(collapse => {
                    const bsCollapse = new bootstrap.Collapse(collapse, {
                        toggle: false
                    });
                    bsCollapse.show();
                });
            } else {
                // 收起所有
                const collapses = document.querySelectorAll('.accordion-collapse');
                collapses.forEach(collapse => {
                    const bsCollapse = new bootstrap.Collapse(collapse, {
                        toggle: false
                    });
                    bsCollapse.hide();
                });
            }
        });

        function updateToggleLabel(isExpanded) {
            if (toggleLabel) {
                toggleLabel.textContent = isExpanded ? '全部收起' : '全部展开';
            }
        }
    });
</script>

{% endblock %}