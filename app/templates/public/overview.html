{% extends "public/base.html" %}

{% block title %}è´¢ç»æ–°é—» - äº”å¸‚ä¿¡æ¯å¹³å°{% endblock %}

{% block extra_css %}
<style>
    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* åŒºåŸŸæ ‡é¢˜ */
    .region-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 1.5rem 0 0.75rem;
        padding-bottom: 0.5rem;
        /*border-bottom: 2px solid var(--primary-color);*/
    }

    /* è‡ªå®šä¹‰è¡¨æ ¼å®¹å™¨ */
    .market-table {
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-secondary);
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* è¡¨å¤´ */
    .market-table thead th {
        /*background: var(--primary-gradient);*/
        background-color: #397ff1;
        color: white;
        font-weight: 600;
        padding: 12px 16px;
        text-align: center;
        font-size: 0.95rem;
    }

    /* è¡¨æ ¼è¡Œ */
    .market-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .market-table tbody tr:hover {
        background-color: rgba(248, 250, 252, 0.7);
    }

    .market-table tbody td,
    .market-table tbody th {
        padding: 12px 16px;
        text-align: center;
        border: none;
        font-size: 0.95rem;
        color: #334155;
    }

    /* æŒ‡æ•°åç§°åŠ ç²— */
    .market-table tbody th {
        font-weight: 600;
        text-align: left;
    }

    /* æ¶¨è·Œå¹…é¢œè‰² */
    .change-up {
        color: #047857 !important; /* ç»¿è‰²ä¸Šæ¶¨ */
        font-weight: 600;
    }

    .change-down {
        color: #dc2626 !important; /* çº¢è‰²ä¸‹è·Œ */
        font-weight: 600;
    }

    /* å“åº”å¼ï¼šå°å±æ—¶ç¼©å°å†…è¾¹è· */
    @media (max-width: 768px) {
        .market-table thead th,
        .market-table tbody td,
        .market-table tbody th {
            padding: 10px 8px;
            font-size: 0.875rem;
        }

        .region-title {
            font-size: 1.1rem;
            margin-top: 1.25rem;
        }
    }

    .text-success {
        color: #047857 !important;
    }

    .text-danger {
        color: #dc2626 !important;
    }

    /* è‡ªå®šä¹‰å¼€å…³æ ·å¼ */
    .form-check-input:checked {
        background-color: #397ff1;
        border-color: #397ff1;
    }

    .form-check-input:focus {
        border-color: #397ff1;
        box-shadow: 0 0 0 0.25rem rgba(57, 127, 241, 0.25);
    }

    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 fade-in">
    <div class="col-md-8">
        <!-- æ·»åŠ æ§åˆ¶æŒ‰é’® -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">å…¨çƒè‚¡æŒ‡è¡Œæƒ…</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggleAllBtn">
                <label class="form-check-label" for="toggleAllBtn">å…¨éƒ¨å±•å¼€</label>
            </div>
        </div>

        <div class="accordion" id="stockIndexAccordion">
            {% for region, indexes in ordered_result.items() %}
            {% if indexes %}
            {% set collapse_id = "collapse-" + loop.index|string %}
            {% set heading_id = "heading-" + loop.index|string %}
            {% set is_expanded = loop.index0 < 2 %}  <!-- å‰ä¸¤ä¸ªé¡¹ç›®å±•å¼€ (ç´¢å¼•0å’Œ1) -->

            <div class="accordion-item">
                <h2 class="accordion-header" id="{{ heading_id }}">
                    <button
                            class="accordion-button{% if not is_expanded %} collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#{{ collapse_id }}"
                            aria-expanded="{{ 'true' if is_expanded else 'false' }}"
                            aria-controls="{{ collapse_id }}">
                        {{ region }}
                    </button>
                </h2>
                <div
                        id="{{ collapse_id }}"
                        class="accordion-collapse collapse{% if is_expanded %} show{% endif %}"
                        aria-labelledby="{{ heading_id }}">
                    <div class="accordion-body">
                        <div class="market-table">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>æŒ‡æ•°åç§°</th>
                                    <th>æœ€æ–°ä»·</th>
                                    <th>æ¶¨è·Œå¹…</th>
                                    <th>æ¶¨è·Œé¢</th>
                                    <th>æ›´æ–°æ—¶é—´</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for index in indexes %}
                                <tr>
                                    <th scope="row">{{ index.name }}</th>
                                    <td>{{ index.price }}</td>
                                    <td class="{% if index.change_percent|float >= 0 %}change-down{% else %}change-up{% endif %}">
                                        {{ '%+.2f'|format(index.change_percent|float) }}%
                                    </td>
                                    <td class="{% if index.change|float >= 0 %}change-down{% else %}change-up{% endif %}">
                                        {{ '%+.2f'|format(index.change|float) }}
                                    </td>
                                    <td>{{ index.timestamp }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>


    <div class="col-md-4">
        <div class="card market-table" style="height: fit-content; box-shadow: var(--shadow-secondary);">
            <div class="card-header py-2" style="background-color: #303b4e; color: white;">
                <h6 class="mb-0 text-center" style="font-weight: 600; font-size: 0.95rem;">å›½å€ºæ”¶ç›Šç‡ï¼ˆ%ï¼‰</h6>
            </div>
            <div class="card-body p-3">
                <div class="row g-5 align-items-center"> <!-- ä½¿ç”¨ g-3 å¢åŠ åˆ—é—´è· -->
                    <!-- ä¸­å›½ -->
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <small class="fw-bold" style="color: #dc2626;">ğŸ‡¨ğŸ‡³ ä¸­å›½</small>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between py-1">
                                <span>2å¹´</span>
                                <span class="fw-bold">{{ cn_bond.cn_2y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>5å¹´</span>
                                <span class="fw-bold">{{ cn_bond.cn_5y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>10å¹´</span>
                                <span class="fw-bold">{{ cn_bond.cn_10y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>30å¹´</span>
                                <span class="fw-bold">{{ cn_bond.cn_30y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1 mt-2 border-top"
                                 style="border-color: rgba(0,0,0,0.08);">
                                <span>åˆ©å·®</span>
                                <span class="fw-bold {% if cn_bond.cn_spread_10y_2y|float > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ cn_bond.cn_spread_10y_2y }}
              </span>
                            </div>
                        </div>
                    </div>

                    <!-- ç¾å›½ -->
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <small class="fw-bold" style="color: #397ff1;">ğŸ‡ºğŸ‡¸ ç¾å›½</small>
                        </div>
                        <div class="small">
                            <div class="d-flex justify-content-between py-1">
                                <span>2å¹´</span>
                                <span class="fw-bold">{{ us_bond.us_2y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>5å¹´</span>
                                <span class="fw-bold">{{ us_bond.us_5y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>10å¹´</span>
                                <span class="fw-bold">{{ us_bond.us_10y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span>30å¹´</span>
                                <span class="fw-bold">{{ us_bond.us_30y }}</span>
                            </div>
                            <div class="d-flex justify-content-between py-1 mt-2 border-top"
                                 style="border-color: rgba(0,0,0,0.08);">
                                <span>åˆ©å·®</span>
                                <span class="fw-bold {% if us_bond.us_spread_10y_2y|float > 0 %}text-success{% else %}text-danger{% endif %}">
                {{ us_bond.us_spread_10y_2y }}
              </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === æ–°å¢ï¼šè§£è¯»æ–‡å­— === -->
                <div class="mt-3 pt-2 border-top" style="border-color: rgba(0,0,0,0.06);">
                    <p class="small text-muted mb-0" style="line-height: 1.5;">
                        ä¸­ç¾åˆ©ç‡å‘ˆç°â€œä¸œè¾¹æ—¥å‡ºè¥¿è¾¹é›¨â€çš„æ ¼å±€ï¼šç¾å›½ä¸ºæŠ—é€šèƒ€ç»´æŒé«˜åˆ©ç‡ï¼Œä¸­å›½ä¸ºç¨³å¢é•¿å¤„äºä½åˆ©ç‡å‘¨æœŸã€‚
                        å·¨å¤§çš„åˆ©å·®ç»™äººæ°‘å¸å¸¦æ¥è´¬å€¼å‹åŠ›ï¼Œå¹¶åˆ¶çº¦äº†ä¸­å›½å¤®è¡Œçš„é™æ¯ç©ºé—´ã€‚
                    </p>
                </div>

            </div>
        </div>

        <!-- === å•†å“æœŸè´§è¡Œæƒ… === -->
        <div class="mt-4">
            <h6 class="fw-bold text-muted mb-3">å•†å“æœŸè´§</h6>
            <div class="small">
                {% for item in commodities %}
                <div class="d-flex justify-content-between py-1 align-items-center border-bottom"
                     style="border-color: rgba(0,0,0,0.06);">
                    <div>
                        <span class="me-2">{{ item.name }}</span>
                        <small class="text-muted">{{ item.symbol }}</small>
                    </div>
                    <div class="text-end">
                        <div>
                            <span class="fw-bold">{{ item.rmb_price | round(2) }}</span>
                            <span class="ms-1 {% if item.change_amount|float > 0 %}text-danger{% else %}text-success{% endif %}">
                        {% if item.change_amount|float > 0 %}+{% endif %}{{ item.change_amount | round(2) }}
                    </span>
                        </div>
                        <div class="text-muted small">
                            ({{ item.change_percent }}%)
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleAllBtn = document.getElementById('toggleAllBtn');
        const toggleLabel = document.querySelector('.form-check-label');

        // åˆå§‹åŒ–çŠ¶æ€
        updateToggleLabel(toggleAllBtn.checked);

        toggleAllBtn.addEventListener('change', function () {
            updateToggleLabel(this.checked);

            if (this.checked) {
                // å±•å¼€æ‰€æœ‰
                const collapses = document.querySelectorAll('.accordion-collapse');
                collapses.forEach(collapse => {
                    const bsCollapse = new bootstrap.Collapse(collapse, {
                        toggle: false
                    });
                    bsCollapse.show();
                });
            } else {
                // æ”¶èµ·æ‰€æœ‰
                const collapses = document.querySelectorAll('.accordion-collapse');
                collapses.forEach(collapse => {
                    const bsCollapse = new bootstrap.Collapse(collapse, {
                        toggle: false
                    });
                    bsCollapse.hide();
                });
            }
        });

        function updateToggleLabel(isExpanded) {
            if (toggleLabel) {
                toggleLabel.textContent = isExpanded ? 'å…¨éƒ¨æ”¶èµ·' : 'å…¨éƒ¨å±•å¼€';
            }
        }
    });
</script>

{% endblock %}