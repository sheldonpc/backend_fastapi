{% extends "public/base.html" %}

{% block title %}首页 - 五市信息平台{% endblock %}

{% block extra_css %}
<style>
    /* 页面整体动画 */
    /* .fade-in {
        animation: fadeInUp 0.6s ease-out;
    } */

    @keyframes fadeInUp {
        from {
            /* opacity: 0; */
            /* transform: translateY(10px); */
        }
        to {
            /* opacity: 1; */
            /* transform: translateY(0); */
        }
    }

    /* 主要指数卡片 */
    .major-index-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, rgba(59, 130, 246, 0.8) 90%);
        /* background: var(--primary-color); */
        color: white;
        border: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    /* .major-index-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        /* background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); */
    /* background: yellow; */
    /* transition: left 0.5s; */
    /* } */

    /* .major-index-card:hover::before {
        left: 100%;
    } */

    .major-index-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* 普通市场卡片 */
    .market-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        background: white;
        position: relative;
        overflow: hidden;
    }

    /* .market-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    } */

    .market-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .market-card:hover::after {
        transform: scaleX(1);
    }

    /* 数值动画 */
    .index-value {
        font-size: 1.4rem;
        font-weight: 700;
        font-family: 'Segoe UI', system-ui, sans-serif;
        position: relative;
    }

    .major-index-card .index-value {
        font-size: 1.8rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* 涨跌幅样式优化 */
    .change-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.8em;
        border-radius: 20px;
        font-weight: 600;
    }

    .bg-success {
        background: linear-gradient(45deg, #10b981, #34d399) !important;
    }

    .bg-danger {
        background: linear-gradient(45deg, #ef4444, #f87171) !important;
    }

    /* 新闻区域 */
    .news-section {
        background: linear-gradient(135deg, #F8FAF8 0%, #ffffff 80%);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        margin-bottom: 1.5rem;
    }

    .news-item {
        transition: all 0.2s ease;
        border-radius: 10px;
        margin-bottom: 0.5rem;
    }

    /* .news-item:hover {
        background: linear-gradient(50deg, var(--primary-color) 20%, rgba(59, 130, 246, 0.8) 80%);;
        color: white;
        transform: translateX(5px);
    } */
    .news-item:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(5px);
    }

    .news-item:hover * {
        color: white !important;
    }

    .news-item:hover .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    /* AI 研判区域 */
    .ai-insight-container {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .ai-insight-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }

    .ai-insight {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1.25rem;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
    }

    /* 加载动画 */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        height: 1.2em;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    /* 数据更新指示器 */
    .update-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        margin-right: 0.5rem;
        animation: pulse_indicator 2s infinite;
    }

    @keyframes pulse_indicator {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    /* 趋势图标动态效果 */
    .trend-icon-up {
        color: #dc3545 !important;
        animation: moveUpward 2s ease-in-out infinite;
    }

    /* 绿色下降箭头 - 自上而下运动 */
    .trend-icon-down {
        color: #28a745 !important;
        animation: moveDownward 2s ease-in-out infinite;
    }

    /* 为不同位置的图标添加延迟 */
    .col-6:nth-child(1) .trend-icon {
        animation-delay: 0s;
    }

    .col-6:nth-child(2) .trend-icon {
        animation-delay: 0.3s;
    }

    .col-6:nth-child(3) .trend-icon {
        animation-delay: 0.6s;
    }

    .col-6:nth-child(4) .trend-icon {
        animation-delay: 0.9s;
    }

    .col-6:nth-child(5) .trend-icon {
        animation-delay: 1.2s;
    }

    .col-6:nth-child(6) .trend-icon {
        animation-delay: 0.15s;
    }

    .col-6:nth-child(7) .trend-icon {
        animation-delay: 0.45s;
    }

    .col-6:nth-child(8) .trend-icon {
        animation-delay: 0.75s;
    }

    /* 或者根据卡片类型添加不同延迟 */
    .major-index-card:nth-of-type(1) .trend-icon {
        animation-delay: 0s;
    }

    .major-index-card:nth-of-type(2) .trend-icon {
        animation-delay: 0.4s;
    }

    .major-index-card:nth-of-type(3) .trend-icon {
        animation-delay: 0.8s;
    }

    .major-index-card:nth-of-type(4) .trend-icon {
        animation-delay: 1.2s;
    }

    .market-card:nth-of-type(1) .trend-icon {
        animation-delay: 0.2s;
    }

    .market-card:nth-of-type(2) .trend-icon {
        animation-delay: 0.6s;
    }

    .market-card:nth-of-type(3) .trend-icon {
        animation-delay: 1.0s;
    }

    .market-card:nth-of-type(4) .trend-icon {
        animation-delay: 0.3s;
    }

    .market-card:nth-of-type(5) .trend-icon {
        animation-delay: 0.7s;
    }

    .market-card:nth-of-type(6) .trend-icon {
        animation-delay: 1.1s;
    }

    .market-card:nth-of-type(7) .trend-icon {
        animation-delay: 0.5s;
    }

    .market-card:nth-of-type(8) .trend-icon {
        animation-delay: 0.9s;
    }

    /* 上升箭头动画：自下而上运动 */
    @keyframes moveUpward {
        0% {
            transform: translateY(4px) scale(1);
            opacity: 0.6;
        }
        50% {
            transform: translateY(0px) scale(1.1);
            opacity: 1;
            text-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
            filter: brightness(1.2);
        }
        100% {
            transform: translateY(-4px) scale(1);
            opacity: 0.7;
        }
    }

    /* 下降箭头动画：自上而下运动 */
    @keyframes moveDownward {
        0% {
            transform: translateY(-4px) scale(1);
            opacity: 0.6;
        }
        50% {
            transform: translateY(0px) scale(1.1);
            opacity: 1;
            text-shadow: 0 -2px 6px rgba(40, 167, 69, 0.3);
            filter: brightness(1.2);
        }
        100% {
            transform: translateY(4px) scale(1);
            opacity: 0.7;
        }
    }

    /* 持平图标 - 轻微脉冲 */
    .trend-icon-flat {
        color: #6c757d !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* 悬停时暂停动画并放大 */
    .trend-icon:hover {
        animation-play-state: paused;
        transform: scale(1.3) !important;
        filter: brightness(1.2);
    }


    /* 分组标题 */
    .section-title {
        position: relative;
        padding-left: 1rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: var(--primary-gradient);
        border-radius: 2px;
    }


    /* 趋势图标动态效果 */
    .trend-icon {
        font-size: 1rem;
        margin-left: 0.5rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    /* 市场分析标签页样式 */
    .market-analysis-tabs .nav-pills {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 0.25rem;
    }

    .market-analysis-tabs .market-tab {
        color: rgba(255, 255, 255, 0.7);
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
        transition: all 0.3s ease;
        background: transparent;
    }

    .market-analysis-tabs .market-tab:hover {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-1px);
    }

    .market-analysis-tabs .market-tab.active {
        color: white;
        background: var(--primary-color);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* 标签页内容动画 */
    .tab-content .tab-pane {
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
    }

    .tab-content .tab-pane.active {
        opacity: 1;
        transform: translateY(0);
    }

    /* 市场分析卡片 */
    .market-analysis-tabs .ai-insight {
        min-height: 140px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .market-analysis-tabs .ai-insight:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
    }

    /* AI 研判区域 */
    .ai-insight-container {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .ai-insight-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }

    .ai-insight {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1rem;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
    }

    .ai-insight:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    /* AI分析要点动画 */
    .ai-insight p {
        opacity: 0;
        animation: fadeInLeft 0.6s ease forwards;
    }

    .ai-insight p:nth-child(3) {
        animation-delay: 0.1s;
    }

    .ai-insight p:nth-child(4) {
        animation-delay: 0.2s;
    }

    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* 情绪指标数值动画 */
    .ai-insight .h6 {
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .ai-insight .h6:hover {
        transform: scale(1.1);
        filter: brightness(1.2);
    }

    /* 标签动画效果 */
    .ai-insight .badge {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .ai-insight .badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* 刷新按钮动画 */
    .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-1px);
    }

    .btn-outline-light:hover .bi-arrow-clockwise {
        animation: rotate 0.5s ease-in-out;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    .scrolling-notice-wrapper {
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        height: 100%;
    }

    .scrolling-notice-content {
        display: inline-block;
        animation: scroll-left 20s linear infinite;
        padding-left: 100%; /* 从右侧开始 */
    }

    .notice-item {
        display: inline-block;
        padding: 12px 16px;
        font-size: 1rem;
    }

    /* 滚动动画：匀速从右向左 */
    @keyframes scroll-left {
        0% {
            transform: translateX(0);
        }
        100% {
            transform: translateX(-100%);
        }
    }

    /* 悬停暂停（可选） */
    .scrolling-notice-wrapper:hover .scrolling-notice-content {
        animation-play-state: paused;
    }

</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 欢迎信息 -->
    <!--    <div class="row mb-4">-->
    <!--        <div class="col-12">-->
    <!--            <div class="alert alert-info alert-dismissible fade show border-0" role="alert" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">-->
    <!--                <i class="bi bi-graph-up-arrow me-2"></i>-->
    <!--                <strong>欢迎访问五市信息平台！</strong> 实时掌握全球市场动态-->
    <!--                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <!-- 滚动欢迎信息 -->
    <!--    <div class="row mb-4">-->
    <!--        <div class="col-12">-->
    <!--            <div class="alert alert-info alert-dismissible fade show border-0 p-0 m-0" role="alert"-->
    <!--                 style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); overflow: hidden;">-->
    <!--                <div class="scrolling-welcome-text">-->
    <!--                    <i class="bi bi-graph-up-arrow me-2"></i>-->
    <!--                    <strong>欢迎访问五市信息平台！</strong> 实时掌握全球市场动态-->
    <!--                </div>-->
    <!--                <div class="scrolling-welcome-text">-->
    <!--                    <i class="bi bi-graph-up-arrow me-2"></i>-->
    <!--                    测试信息-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show border-0 p-0 m-0" role="alert"
                 style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); overflow: hidden; position: relative;">
                <!-- 滚动容器 -->
                <div class="scrolling-notice-wrapper">
                    <div class="scrolling-notice-content" id="noticeContent">
                        <span class="notice-item">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            <strong>{{ data.notice }}</strong>
                        </span>
                    </div>
                </div>

                <!-- 关闭按钮 -->
                <!--                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"-->
                <!--                        style="position: absolute; top: 8px; right: 8px; z-index: 10;"></button>-->
            </div>
        </div>
    </div>

    <!-- 主要指数 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="section-title mb-0">主要指数</h5>
        <small class="text-muted d-flex align-items-center">
            <span class="update-indicator"></span>
            更新时间：<span id="updateTime">{{ data.update_time }}</span>
        </small>
    </div>

    <div class="row g-3 mb-4">
        <!-- 上证指数 - 主要指数 -->
        {% for item in data.main_market.values() %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card major-index-card">
                <div class="card-body p-3 text-center">
                    <div class="small opacity-75 mb-1">{{ item.name }}</div>
                    <div class="index-value">{{ item.price | round(2) }}</div>
                    <div class="change-indicator justify-content-center">
                        {% if item.change <= 0 %}
                        <span class="badge bg-light text-success">{{ item.change_percent | round(2) }}%</span>
                        <span class="small opacity-70">{{ item.change | round(2) }}</span>
                        <i class="bi bi-caret-down-fill trend-icon trend-icon-down"></i>
                        {% else %}
                        <span class="badge bg-light text-danger">{{ item.change_percent | round(2) }}%</span>
                        <span class="small opacity-70">{{ item.change | round(2) }}</span>
                        <i class="bi bi-caret-up-fill trend-icon trend-icon-up"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 其他市场数据 -->
    <h6 class="section-title mb-3">其他市场</h6>
    <div class="row g-3 mb-5">
        <!-- 创业板指 -->
        {% for item in data.foreign_market.values() %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">{{ item.name }}</div>
                        {% if item.change <= 0 %}
                        <i class="bi bi-graph-down-arrow text-success"></i>
                        {% else %}
                        <i class="bi bi-graph-up-arrow text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="index-value text-dark">{{ item.price | round(2)}}</div>
                    <div class="change-indicator">
                        {% if item.change <= 0 %}
                        <span class="badge bg-success">{{ item.change_percent | round(2)}}%</span>
                        {% else %}
                        <span class="badge bg-danger">{{ item.change_percent | round(2)}}%</span>
                        {% endif %}
                        <small class="text-muted">{{ item.change | round(2)}}</small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for item in data.commodity.values() %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">{{ item.name }}</div>
                        {% if item.name == "布伦特原油" %}
                        <i class="bi bi-fuel-pump text-info"></i>
                        {% else %}
                        <i class="bi bi-minecart-loaded text-info"></i>
                        {% endif %}
                    </div>
                    <div class="index-value text-dark">{{ item.price | round(2)}}</div>
                    <div class="change-indicator">
                        {% if item.change <= 0 %}
                        <span class="badge bg-success">{{ item.change_percent | round(2)}}%</span>
                        {% else %}
                        <span class="badge bg-danger">{{ item.change_percent | round(2)}}%</span>
                        {% endif %}
                        <small class="text-muted">{{ item.change | round(2)}}</small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="col-6 col-md-4 col-lg-3">
            <div class="card market-card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="small text-muted">{{ data.fx.code }}</div>
                        <i class="bi bi-currency-dollar text-info"></i>
                    </div>
                    <div class="index-value text-dark">
                        {{ data.fx.buying_price | round(2)}}
                        <span class="text-muted fs-6">买入价</span>
                    </div>
                    <div class="change-indicator">
                        <span class="badge bg-info">卖出价{{ data.fx.selling_price | round(2)}}</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 新闻 + AI 研判 -->
    <div class="row g-4">
        <!-- 最新财经新闻 -->
        <div class="col-lg-7">
            <div class="news-section">
                <h5 class="section-title mb-3">最新新闻</h5>
                <div class="list-group list-group-flush">
                    {% for news in data.news_data %}
                    <a href="/news/1" class="list-group-item list-group-item-action news-item border-0 py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">{{ news.title }}</h6>
                                <p class="mb-1 small text-muted">{{ news.content | truncate(100)}}...</p>
                            </div>
                            <small class="text-muted ms-3">{{ news.publish_time }}</small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="/news" class="btn btn-outline-primary btn-sm">查看更多新闻</a>
                </div>
            </div>
        </div>

        <!-- AI 市场研判 -->
        <div class="col-lg-5">
            <div class="ai-insight-container">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-robot me-2" style="font-size: 1.5rem;"></i>
                    <h5 class="mb-0">AI 市场研判</h5>
                    <div class="ms-auto d-flex align-items-center">
                        <span class="badge bg-success me-2">
                            <i class="bi bi-lightning-fill me-1"></i>实时
                        </span>
                        <small class="opacity-75">DeepSeek V3.1</small>
                    </div>
                </div>

                <!-- 综合市场情绪 -->
                <div class="ai-insight mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-speedometer2 me-2"></i>综合情绪
                        </h6>
                        <span class="badge bg-warning">谨慎乐观</span>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small opacity-75">VIX指数</div>
                            <div class="h6 mb-0 text-warning">{{ data.vix | round(2) }}</div>
                        </div>
                        <div class="col-4">
                            <div class="small opacity-75">市场温度</div>
                            <div class="h6 mb-0 text-success">{{ data.market_data_activity }}</div>
                        </div>
                        <div class="col-4">
                            <div class="small opacity-75">AI信心度</div>
                            <div class="h6 mb-0 text-info">{{ data.average_confidence | round(2) }}%</div>
                        </div>
                    </div>
                </div>

                <!-- A股市场分析 -->
                {% for item in data.ai_insight %}
                {% if item.market_region == "cn_market" %}
                <div class="ai-insight mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-flag me-2"></i>A股判断
                        </h6>
                        {% if item.sentiment == "看好" %}
                        <span class="badge bg-success">{{ item.sentiment }}</span>
                        {% elif item.sentiment == "中性" %}
                        <span class="badge bg-warning">{{ item.sentiment }}</span>
                        {% else %}
                        <span class="badge bg-danger">{{ item.sentiment }}</span>
                        {% endif %}
                    </div>
                    {% for point in item.key_points %}
                    <p class="small mb-2">
                        {% if point.type == "positive" %}
                        <i class="bi bi-arrow-up-circle-fill text-success me-1"></i>
                        {% elif point.type == "negative" %}
                        <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i>
                        {% elif point.type == "warning" %}
                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                        {% else %}
                        <i class="bi bi-info-circle-fill text-info me-1"></i>
                        {% endif %}

                        {{ point.content }}
                    </p>
                    {% endfor %}
                    <div class="row">
                        <div class="col-12">
                            <div class="small opacity-75">重点关注</div>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                {% for keyword in item.focus_sectors %}
                                <span class="badge bg-success bg-opacity-75">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                        </div>
<!--                        <div class="col-6">-->
<!--                            <div class="small opacity-75">支撑位</div>-->
<!--                            <div class="text-info fw-bold mt-1">3150点</div>-->
<!--                        </div>-->
                    </div>
                </div>
                {% endif %}
                {% endfor %}

                {% for item in data.ai_insight %}
                {% if item.market_region == "usa_market" %}
                <div class="ai-insight mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-star"></i> 美股判断
                        </h6>
                        {% if item.sentiment == "看好" %}
                        <span class="badge bg-success">{{ item.sentiment }}</span>
                        {% elif item.sentiment == "中性" %}
                        <span class="badge bg-warning">{{ item.sentiment }}</span>
                        {% else %}
                        <span class="badge bg-danger">{{ item.sentiment }}</span>
                        {% endif %}
                    </div>
                    {% for point in item.key_points %}
                    <p class="small mb-2">
                        {% if point.type == "positive" %}
                        <i class="bi bi-arrow-up-circle-fill text-success me-1"></i>
                        {% elif point.type == "negative" %}
                        <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i>
                        {% elif point.type == "warning" %}
                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                        {% else %}
                        <i class="bi bi-info-circle-fill text-info me-1"></i>
                        {% endif %}

                        {{ point.content }}
                    </p>
                    {% endfor %}
                    <div class="row">
                        <div class="col-12">
                            <div class="small opacity-75">重点关注</div>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                {% for keyword in item.focus_sectors %}
                                <span class="badge bg-info bg-opacity-75">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                        </div>
<!--                        <div class="col-6">-->
<!--                            <div class="small opacity-75">支撑位</div>-->
<!--                            <div class="text-info fw-bold mt-1">3150点</div>-->
<!--                        </div>-->
                    </div>
                </div>
                {% endif %}
                {% endfor %}

                {% for item in data.ai_insight %}
                {% if item.market_region == "metal" %}
                <div class="ai-insight mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-gem me-2"></i>贵金属判断
                        </h6>
                        {% if item.sentiment == "看好" %}
                        <span class="badge bg-success">{{ item.sentiment }}</span>
                        {% elif item.sentiment == "中性" %}
                        <span class="badge bg-warning">{{ item.sentiment }}</span>
                        {% else %}
                        <span class="badge bg-danger">{{ item.sentiment }}</span>
                        {% endif %}
                    </div>
                    {% for point in item.key_points %}
                    <p class="small mb-2">
                        {% if point.type == "positive" %}
                        <i class="bi bi-arrow-up-circle-fill text-success me-1"></i>
                        {% elif point.type == "negative" %}
                        <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i>
                        {% elif point.type == "warning" %}
                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                        {% else %}
                        <i class="bi bi-info-circle-fill text-info me-1"></i>
                        {% endif %}

                        {{ point.content }}
                    </p>
                    {% endfor %}
                    <div class="row">
                        <div class="col-12">
                            <div class="small opacity-75">重点关注</div>
                            <div class="d-flex flex-wrap gap-1 mt-1">
                                {% for keyword in item.focus_sectors %}
                                <span class="badge bg-info bg-opacity-75">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                        </div>
<!--                        <div class="col-6">-->
<!--                            <div class="small opacity-75">支撑位</div>-->
<!--                            <div class="text-info fw-bold mt-1">3150点</div>-->
<!--                        </div>-->
                    </div>
                </div>
                {% endif %}
                {% endfor %}


                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="opacity-75">
                        <i class="bi bi-clock me-1"></i>更新于：{{ data.ai_update_time }}
                    </small>
                    <button class="btn btn-outline-light btn-sm" id="refreshAnalysis">
                        <i class="bi bi-arrow-clockwise me-1"></i>动态更新中
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // const content = document.getElementById('noticeContent');
        // 克隆一份内容，避免滚动到末尾出现空白
        // content.innerHTML += content.innerHTML;

        const trendIcons = document.querySelectorAll('.trend-icon');
        trendIcons.forEach((icon, index) => {
            // 生成0到1.5秒之间的随机延迟
            const randomDelay = Math.random() * 1.5;
            icon.style.animationDelay = `${randomDelay}s`;
        });

        const dataMappring = {
            'sh000001': {selector: '[data-index="sh000001"]', name: '上证指数'},
            'sz399001': {selector: '[data-index="sz399001"]', name: '深证成指'},
            'sz399006': {selector: '[data-index="sz399006"]', name: '创业板指'},
            'hsi': {selector: '[data-index="hsi"]', name: '恒生指数'},
            'djia': {selector: '[data-index="djia"]', name: '道琼斯'},
            'spx': {selector: '[data-index="spx"]', name: '标普500'},
            'ndx': {selector: '[data-index="ndx"]', name: '纳斯达克'},
        }

        let currentData = {};

        // 数据更新动画
        function animateValueUpdate(element) {
            element.classList.add('value-update');
            setTimeout(() => {
                element.classList.remove('value-update');
            }, 600);
        }

        // 更新指数卡片数据
        function updateIndexCard(cardElement, data, animate = false) {
            if (!data || !cardElement) return;

            const priceElement = cardElement.querySelector('.index-price');
            if (priceElement && data.price !== undefiend) {
                if (animate) animateValueUpdate(priceElement)
                priceElement.textContent = parseFloat(data.price).toFixed(2);
            }

            const changeIndicator = cardElement.querySelector('.change-indicator');
            if (changeIndicator && data.change_percent !== undifiend && data.change !== undefiend) {
                const isPositive = data.change > 0;
                const isNegative = data.change < 0;

                changeIndicator.innerHTML = '';
                // 百分比
                const badge = document.createElement('span');
                badge.className = `badge ${isNegative ? 'bg-light text-success' : 'bg-light text-danger'}`
                badge.textContent = `${isPositive ? '+' : ''}${parseFloat(data.change_percent).toFixed(2)}%`
                // 涨跌额
                const changeAmount = document.createElement('span');
                changeAmount.className = 'small opacity-70'
                changeAmount.textContent = `(${isPositive ? '+' : ''}${parseFloat(data.change).toFixed(2)})`

                const trendIcon = document.createElement('i');
                if (isPositive) {
                    trendIcon.className = 'bi bi-caret-up-fill trend-icon trend-icon-up';
                } else if (isNegative) {
                    trendIcon.className = '\'bi bi-caret-down-fill trend-icon trend-icon-down';
                }

            }

        }

        // 模拟实时数据更新
        function simulateDataUpdate() {
            const values = document.querySelectorAll('.index-value[data-value]');
            values.forEach((element, index) => {
                setTimeout(() => {
                    animateValueUpdate(element);
                }, index * 200);
            });

            // 更新时间
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('updateTime').textContent = timeString;
        }

        // 每30秒模拟一次数据更新
        setInterval(simulateDataUpdate, 30000);

        // 卡片进入视图动画
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationDelay = Math.random() * 0.3 + 's';
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);

        // 观察所有卡片
        document.querySelectorAll('.card').forEach(card => {
            observer.observe(card);
        });

        // AI研判刷新功能
        document.getElementById('refreshAnalysis')?.addEventListener('click', function () {
            const button = this;
            const insights = document.querySelectorAll('.ai-insight');

            // 添加加载状态
            button.disabled = true;
            insights.forEach(insight => insight.classList.add('loading'));

            // 模拟AI分析更新
            setTimeout(() => {
                // 移除加载状态
                insights.forEach(insight => insight.classList.remove('loading'));
                button.disabled = false;

                // 添加数据更新视觉反馈
                insights.forEach((insight, index) => {
                    setTimeout(() => {
                        insight.classList.add('data-updated');
                        setTimeout(() => {
                            insight.classList.remove('data-updated');
                        }, 600);
                    }, index * 150);
                });

                // 更新时间戳
                const timeElement = document.querySelector('.ai-insight-container small');
                if (timeElement) {
                    const now = new Date();
                    const timeString = now.toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    timeElement.innerHTML = `<i class="bi bi-clock me-1"></i>更新于：${timeString}`;
                }

                console.log('AI分析已刷新');
            }, 2000);
        });

        // 情绪指标交互效果
        const emotionIndicators = document.querySelectorAll('.ai-insight .h6');
        emotionIndicators.forEach(indicator => {
            indicator.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.05)';
                this.style.filter = 'brightness(1.1)';
            });

            indicator.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1)';
                this.style.filter = 'brightness(1)';
            });
        });

        // 标签hover效果增强
        const analysisbadges = document.querySelectorAll('.ai-insight .badge');
        analysisbadges.forEach(badge => {
            badge.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.1)';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            });

            badge.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = 'none';
            });
        });
    });
</script>
{% endblock %}