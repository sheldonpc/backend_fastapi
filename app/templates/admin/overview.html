<!-- overview.html -->
<div class="container-fluid">
    <!-- æ ‡é¢˜ -->
    <h2 class="mb-4">ğŸ–¥ï¸ ç³»ç»ŸçŠ¶æ€ç›‘æ§</h2>

    <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç³»ç»Ÿèµ„æºçŠ¶æ€å¡ç‰‡ï¼ˆ4åˆ—ï¼‰ -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">ğŸ’» CPU ä½¿ç”¨ç‡</h5>
                    <h2 class="card-text" id="cpu_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" id="cpu_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="cpu_cores">æ ¸å¿ƒæ•°: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">ğŸ§  å†…å­˜ä½¿ç”¨ç‡</h5>
                    <h2 class="card-text" id="memory_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="memory_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="memory_details">å·²ç”¨ / æ€»è®¡: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">ğŸ’¾ ç£ç›˜ä½¿ç”¨ç‡</h5>
                    <h2 class="card-text" id="disk_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-danger" id="disk_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="disk_details">å·²ç”¨ / æ€»è®¡: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">ğŸŒ ç½‘ç»œæµé‡</h5>
                    <h2 class="card-text" id="network_status">--</h2>
                    <p class="card-text mt-1"><small id="network_details">â†‘ -- â†“ --</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šç³»ç»ŸçŠ¶æ€å’Œæ¥å£çŠ¶æ€ï¼ˆ2åˆ—ï¼‰ -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-clock-history me-2"></i>å®šæ—¶ä»»åŠ¡ç®¡ç†
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshTaskStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="runAllTasks()">
                                <i class="bi bi-play-circle me-1"></i>å…¨éƒ¨æ‰§è¡Œ
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="stopAllTasks()">
                                <i class="bi bi-stop-circle me-1"></i>å…¨éƒ¨åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="taskControlPanel">
                        <div class="task-list">
                            <!-- ä»»åŠ¡1ï¼šè·å–ä¸œæ–¹è´¢å¯Œå†å²æ•°æ® -->
                            <div class="task-item border-bottom">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                                        <i class="bi bi-graph-up fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">1. è·å–ä¸œæ–¹è´¢å¯Œå†å²æ•°æ®</h6>
<!--?                                        <p class="mb-0 small text-muted">ä»ä¸œæ–¹è´¢å¯Œè·å–è‚¡ç¥¨å†å²æ•°æ®</p>-->
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-primary rounded-pill me-2" onclick="runTask('fetch_eastmoney_history_market_data')" id="task1_btn">
                                            <i class="bi bi-play-fill me-1"></i>æ‰§è¡Œ
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task1_status">ç­‰å¾…</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" id="task1_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä»»åŠ¡2ï¼šLLMæ´å¯Ÿåˆ†æ -->
                            <div class="task-item border-bottom">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-success bg-opacity-10 text-success rounded-circle p-2 me-3">
                                        <i class="bi bi-robot fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">2. LLMæ´å¯Ÿåˆ†æ</h6>
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-success rounded-pill me-2" onclick="runTask('crawl_llm_insight')" id="task2_btn">
                                            <i class="bi bi-play-fill me-1"></i>æ‰§è¡Œ
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task2_status">ç­‰å¾…</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" id="task2_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä»»åŠ¡3ï¼šæ–°é—»AIæ‘˜è¦ -->
                            <div class="task-item">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-info bg-opacity-10 text-info rounded-circle p-2 me-3">
                                        <i class="bi bi-newspaper fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">3. æ–°é—»AIæ‘˜è¦</h6>
<!--?                                        <p class="mb-0 small text-muted">ç”Ÿæˆæ–°é—»AIæ‘˜è¦</p>-->
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-success rounded-pill me-2" onclick="runTask('news_ai_summary')" id="task3_btn">
                                            <i class="bi bi-play-fill me-1"></i>æ‰§è¡Œ
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task3_status">ç­‰å¾…</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" id="task3_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ -->
                        <div class="task-stats bg-light rounded-bottom p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">ä»»åŠ¡çŠ¶æ€:</small>
                                    <span class="badge bg-success rounded-pill me-1" id="running_count">0 è¿è¡Œä¸­</span>
                                    <span class="text-muted">/</span>
                                    <span class="badge bg-secondary rounded-pill ms-1" id="total_count">3 æ€»è®¡</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">å»¶è¿Ÿ:</small>
                                    <span class="badge bg-info rounded-pill" id="delay_info">5-10s/30-60s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”Œ æ¥å£çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="apiStatus">
                        <div class="list-group-item">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šç³»ç»Ÿä¿¡æ¯å’Œå¿«æ·æ“ä½œ -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>æ“ä½œç³»ç»Ÿ</td>
                                <td id="os_info">--</td>
                            </tr>
                            <tr>
                                <td>Pythonç‰ˆæœ¬</td>
                                <td id="python_version">--</td>
                            </tr>
                            <tr>
                                <td>ç³»ç»Ÿå¯åŠ¨æ—¶é—´</td>
                                <td id="boot_time">--</td>
                            </tr>
                            <tr>
                                <td>å½“å‰æ—¶é—´</td>
                                <td id="current_time">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš¡ ç³»ç»Ÿæ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshSystemStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                        <button class="btn btn-outline-success" onclick="navigateTo('logs')">ğŸ“‹ æŸ¥çœ‹æ—¥å¿—</button>
                        <button class="btn btn-outline-warning" onclick="navigateTo('config')">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
                        <button class="btn btn-outline-info" onclick="exportSystemInfo()">ğŸ“¥ å¯¼å‡ºä¿¡æ¯</button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">æœ€åæ›´æ–°: <span id="last_update">--</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Chart.jsï¼ˆè½»é‡çº§å›¾è¡¨åº“ï¼‰ -->
<script src="/static/js/chart.js"></script>
<script>
// æ£€æŸ¥Chart.jsæ˜¯å¦æˆåŠŸåŠ è½½
if (typeof Chart === 'undefined') {
    console.error('Chart.js åŠ è½½å¤±è´¥ï¼Œå›¾è¡¨åŠŸèƒ½å°†ä¸å¯ç”¨');
}
</script>

<script>
// é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('overview').classList.contains('d-none') === false) {
        loadSystemStatus();
    }
});

// ç›‘å¬å¯¼èˆªåˆ‡æ¢ï¼Œå¦‚æœæ˜¯åˆ‡æ¢åˆ° overviewï¼Œåˆ™åŠ è½½æ•°æ®
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const overviewDiv = document.getElementById('overview');
            if (overviewDiv && !overviewDiv.classList.contains('d-none')) {
                loadSystemStatus();
            }
        }
    });
});

observer.observe(document.getElementById('overview'), { attributes: true });

// è®¾ç½®å®šæ—¶åˆ·æ–°
let refreshInterval;

function startAutoRefresh() {
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    refreshInterval = setInterval(loadSystemStatus, 30000);
}

// é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
document.addEventListener('DOMContentLoaded', startAutoRefresh);

// é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

async function loadSystemStatus() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸ");
        window.location.href = "/login?next=/admin/";
        return;
    }

    try {
        // 1. åŠ è½½ç³»ç»Ÿèµ„æºçŠ¶æ€
        const systemRes = await fetch("/admin/api/system-status", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (!systemRes.ok) throw new Error("åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥");
        const systemData = await systemRes.json();
        
        // æ£€æŸ¥APIæ˜¯å¦è¿”å›é”™è¯¯ä¿¡æ¯
        if (systemData.error) {
            throw new Error(systemData.error);
        }

        // æ›´æ–°CPUçŠ¶æ€
        if (systemData.cpu) {
            const cpuPercent = systemData.cpu.percent || 0;
            document.getElementById("cpu_usage").textContent = cpuPercent.toFixed(1) + "%";
            document.getElementById("cpu_progress").style.width = cpuPercent + "%";
            document.getElementById("cpu_cores").textContent = `æ ¸å¿ƒæ•°: ${systemData.cpu.cores || '--'}`;
            
            // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            const cpuBar = document.getElementById("cpu_progress");
            if (cpuPercent > 80) {
                cpuBar.className = "progress-bar bg-danger";
            } else if (cpuPercent > 60) {
                cpuBar.className = "progress-bar bg-warning";
            } else {
                cpuBar.className = "progress-bar";
            }
        }

        // æ›´æ–°å†…å­˜çŠ¶æ€
        if (systemData.memory) {
            const memoryPercent = systemData.memory.percent || 0;
            document.getElementById("memory_usage").textContent = memoryPercent.toFixed(1) + "%";
            document.getElementById("memory_progress").style.width = memoryPercent + "%";
            
            const usedGB = (systemData.memory.used / (1024 ** 3)).toFixed(2);
            const totalGB = (systemData.memory.total / (1024 ** 3)).toFixed(2);
            document.getElementById("memory_details").textContent = `å·²ç”¨ / æ€»è®¡: ${usedGB}GB / ${totalGB}GB`;
            
            // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            const memoryBar = document.getElementById("memory_progress");
            if (memoryPercent > 80) {
                memoryBar.className = "progress-bar bg-danger";
            } else if (memoryPercent > 60) {
                memoryBar.className = "progress-bar bg-warning";
            } else {
                memoryBar.className = "progress-bar";
            }
        }

        // æ›´æ–°ç£ç›˜çŠ¶æ€
        if (systemData.disk) {
            const diskPercent = systemData.disk.percent || 0;
            document.getElementById("disk_usage").textContent = diskPercent.toFixed(1) + "%";
            document.getElementById("disk_progress").style.width = diskPercent + "%";
            
            const usedGB = (systemData.disk.used / (1024 ** 3)).toFixed(2);
            const totalGB = (systemData.disk.total / (1024 ** 3)).toFixed(2);
            document.getElementById("disk_details").textContent = `å·²ç”¨ / æ€»è®¡: ${usedGB}GB / ${totalGB}GB`;
            
            // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            const diskBar = document.getElementById("disk_progress");
            if (diskPercent > 80) {
                diskBar.className = "progress-bar bg-danger";
            } else if (diskPercent > 60) {
                diskBar.className = "progress-bar bg-warning";
            } else {
                diskBar.className = "progress-bar";
            }
        }

        // æ›´æ–°ç½‘ç»œçŠ¶æ€
        if (systemData.network) {
            const uploadSpeed = formatBytes(systemData.network.bytes_sent_per_sec || 0) + "/s";
            const downloadSpeed = formatBytes(systemData.network.bytes_recv_per_sec || 0) + "/s";
            
            // å¦‚æœç½‘ç»œé€Ÿç‡ä¸º0ï¼Œæ˜¾ç¤º"ç©ºé—²"ï¼Œå¦åˆ™æ˜¾ç¤º"æ­£å¸¸"
            const networkStatus = (systemData.network.bytes_sent_per_sec === 0 && systemData.network.bytes_recv_per_sec === 0) ? "ç©ºé—²" : "æ­£å¸¸";
            document.getElementById("network_status").textContent = networkStatus;
            document.getElementById("network_details").innerHTML = `â†‘ ${uploadSpeed} â†“ ${downloadSpeed}`;
        }

        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
        if (systemData.system) {
            document.getElementById("os_info").textContent = systemData.system.os || '--';
            document.getElementById("python_version").textContent = systemData.system.python_version || '--';
            document.getElementById("boot_time").textContent = systemData.system.boot_time ? 
                new Date(systemData.system.boot_time * 1000).toLocaleString() : '--';
        }

        // æ›´æ–°å½“å‰æ—¶é—´
        document.getElementById("current_time").textContent = new Date().toLocaleString();
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        document.getElementById("last_update").textContent = new Date().toLocaleTimeString();

        // 2. åŠ è½½æ¥å£çŠ¶æ€
        const apiRes = await fetch("/admin/api/api-status", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (apiRes.ok) {
            const apiData = await apiRes.json();
            updateApiStatus(apiData.apis || []);
        }

        // 3. åŠ è½½ç³»ç»Ÿè´Ÿè½½æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
        const loadRes = await fetch("/admin/api/system-load?period=1h", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (loadRes.ok) {
            const loadData = await loadRes.json();
            try {
                updateSystemLoadChart(loadData);
            } catch (chartErr) {
                console.warn("å›¾è¡¨æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯Chart.jsåŠ è½½é—®é¢˜:", chartErr);
                // å›¾è¡¨å¤±è´¥ä¸å½±å“å…¶ä»–æ•°æ®æ˜¾ç¤º
            }
        }

    } catch (err) {
        console.error("åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:", err);
        
        // åªåœ¨æ•°æ®ç¡®å®æœªåŠ è½½æ—¶æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…è¦†ç›–å·²åŠ è½½çš„æ•°æ®
        if (document.getElementById("cpu_usage").textContent === "--") {
            document.getElementById("cpu_usage").textContent = "é”™è¯¯";
        }
        if (document.getElementById("memory_usage").textContent === "--") {
            document.getElementById("memory_usage").textContent = "é”™è¯¯";
        }
        if (document.getElementById("disk_usage").textContent === "--") {
            document.getElementById("disk_usage").textContent = "é”™è¯¯";
        }
        if (document.getElementById("network_status").textContent === "--") {
            document.getElementById("network_status").textContent = "é”™è¯¯";
        }
        
        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯åœ¨æ§åˆ¶å°
        console.error("é”™è¯¯è¯¦æƒ…:", err.message);
        if (err.response) {
            console.error("å“åº”çŠ¶æ€:", err.response.status);
            console.error("å“åº”æ•°æ®:", err.response.data);
        }
    }
}

// æ ¼å¼åŒ–å­—èŠ‚æ•°ä¸ºæ˜“è¯»çš„å•ä½
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 B';
    
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// æ›´æ–°æ¥å£çŠ¶æ€
function updateApiStatus(apiData) {
    const apiStatus = document.getElementById("apiStatus");
    apiStatus.innerHTML = "";
    
    if (!apiData || !Array.isArray(apiData)) {
        const item = document.createElement("div");
        item.className = "list-group-item text-center text-muted";
        item.textContent = "æ— æ¥å£çŠ¶æ€æ•°æ®";
        apiStatus.appendChild(item);
        return;
    }
    
    apiData.forEach(api => {
        const item = document.createElement("div");
        item.className = "list-group-item d-flex justify-content-between align-items-center";
        
        let statusBadge = "";
        if (api.status === "healthy") {
            statusBadge = '<span class="badge bg-success">æ­£å¸¸</span>';
        } else if (api.status === "warning") {
            statusBadge = '<span class="badge bg-warning text-dark">è­¦å‘Š</span>';
        } else {
            statusBadge = '<span class="badge bg-danger">å¼‚å¸¸</span>';
        }
        
        item.innerHTML = `
            <div>
                <strong>${api.name || api.path}</strong>
                <div class="small text-muted">${api.method || 'GET'} ${api.path}</div>
            </div>
            <div class="text-end">
                ${statusBadge}
                <div class="small text-muted">${api.response_time || '--'}ms</div>
            </div>
        `;
        apiStatus.appendChild(item);
    });
}

// æ›´æ–°ç³»ç»ŸæœåŠ¡çŠ¶æ€
function updateSystemLoadChart(data) {
    const container = document.getElementById('systemLoadChart');
    if (!container) {
        return;
    }

    // æ¸…ç©ºå®¹å™¨å†…å®¹
    container.innerHTML = '';

    // åˆ›å»ºæœåŠ¡çŠ¶æ€åˆ—è¡¨
    const serviceList = document.createElement('div');
    serviceList.className = 'list-group list-group-flush';
    
    // æ¨¡æ‹Ÿç³»ç»ŸæœåŠ¡æ•°æ®ï¼ˆå®é™…ä½¿ç”¨æ—¶åº”è¯¥ä»åå°APIè·å–ï¼‰
    const services = [
        { 
            name: 'WebæœåŠ¡å™¨', 
            status: 'running', 
            uptime: '3å¤© 12å°æ—¶', 
            port: '80/443',
            description: 'ä¸»WebæœåŠ¡'
        },
        { 
            name: 'æ•°æ®åº“æœåŠ¡', 
            status: 'running', 
            uptime: '7å¤© 8å°æ—¶', 
            port: '3306',
            description: 'MySQLæ•°æ®åº“'
        },
        { 
            name: 'Redisç¼“å­˜', 
            status: 'running', 
            uptime: '2å¤© 15å°æ—¶', 
            port: '6379',
            description: 'å†…å­˜ç¼“å­˜æœåŠ¡'
        },
        { 
            name: 'å®šæ—¶ä»»åŠ¡', 
            status: 'warning', 
            uptime: '1å¤© 3å°æ—¶', 
            port: '-',
            description: 'è°ƒåº¦å™¨æœåŠ¡'
        },
        { 
            name: 'æ—¥å¿—æœåŠ¡', 
            status: 'running', 
            uptime: '5å¤© 6å°æ—¶', 
            port: '-',
            description: 'æ—¥å¿—æ”¶é›†æœåŠ¡'
        }
    ];

    // å¦‚æœæœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„æœåŠ¡çŠ¶æ€
    if (data && Array.isArray(data) && data.length > 0) {
        const latestData = data[data.length - 1];
        if (latestData.services && Array.isArray(latestData.services)) {
            latestData.services.forEach(service => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                
                let statusBadge = '';
                let statusIcon = '';
                if (service.status === 'running') {
                    statusBadge = 'bg-success';
                    statusIcon = 'âœ…';
                } else if (service.status === 'warning') {
                    statusBadge = 'bg-warning';
                    statusIcon = 'âš ï¸';
                } else {
                    statusBadge = 'bg-danger';
                    statusIcon = 'âŒ';
                }
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h6 class="mb-1">${statusIcon} ${service.name || 'æœªçŸ¥æœåŠ¡'}</h6>
                            <p class="mb-1 small text-muted">${service.description || ''}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge ${statusBadge}">${service.status || 'æœªçŸ¥'}</span>
                            <div class="small text-muted mt-1">ç«¯å£: ${service.port || '--'}</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">è¿è¡Œæ—¶é—´: ${service.uptime || '--'}</small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="restartService('${service.name}')">é‡å¯</button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewServiceLog('${service.name}')">æ—¥å¿—</button>
                        </div>
                    </div>
                `;
                serviceList.appendChild(item);
            });
        }
    } else {
        // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
        services.forEach(service => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            
            let statusBadge = '';
            let statusIcon = '';
            if (service.status === 'running') {
                statusBadge = 'bg-success';
                statusIcon = 'âœ…';
            } else if (service.status === 'warning') {
                statusBadge = 'bg-warning';
                statusIcon = 'âš ï¸';
            } else {
                statusBadge = 'bg-danger';
                statusIcon = 'âŒ';
            }
            
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <h6 class="mb-1">${statusIcon} ${service.name}</h6>
                        <p class="mb-1 small text-muted">${service.description}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${statusBadge}">${service.status}</span>
                        <div class="small text-muted mt-1">ç«¯å£: ${service.port}</div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">è¿è¡Œæ—¶é—´: ${service.uptime}</small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="restartService('${service.name}')">é‡å¯</button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewServiceLog('${service.name}')">æ—¥å¿—</button>
                    </div>
                </div>
            `;
            serviceList.appendChild(item);
        });
    }

    container.appendChild(serviceList);

    // æ·»åŠ åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯
    const stats = document.createElement('div');
    stats.className = 'mt-3 text-center';
    const runningCount = services.filter(s => s.status === 'running').length;
    const totalCount = services.length;
    stats.innerHTML = `
        <small class="text-muted">
            æœåŠ¡çŠ¶æ€: <span class="badge bg-success">${runningCount} è¿è¡Œä¸­</span> 
            / <span class="badge bg-secondary">${totalCount} æ€»è®¡</span>
            | ç³»ç»Ÿå¥åº·åº¦: <span class="badge bg-info">${Math.round((runningCount/totalCount)*100)}%</span>
        </small>
    `;
    container.appendChild(stats);
}

// åˆ·æ–°ç³»ç»ŸçŠ¶æ€
function refreshSystemStatus() {
    loadSystemStatus();
}

// åˆ·æ–°æœåŠ¡çŠ¶æ€
function refreshServices() {
    loadSystemStatus();
    console.log("æœåŠ¡çŠ¶æ€å·²åˆ·æ–°");
}

// é‡å¯æ‰€æœ‰æœåŠ¡
function restartAllServices() {
    if (confirm("ç¡®å®šè¦é‡å¯æ‰€æœ‰æœåŠ¡å—ï¼Ÿè¿™å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚çš„æœåŠ¡ä¸­æ–­ã€‚")) {
        console.log("æ­£åœ¨é‡å¯æ‰€æœ‰æœåŠ¡...");
        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„APIè°ƒç”¨
        setTimeout(() => {
            alert("æœåŠ¡é‡å¯å‘½ä»¤å·²å‘é€");
            refreshServices();
        }, 1000);
    }
}

// æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
function checkServiceHealth() {
    console.log("æ­£åœ¨æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€...");
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„APIè°ƒç”¨
    setTimeout(() => {
        alert("æœåŠ¡å¥åº·æ£€æŸ¥å®Œæˆ");
        refreshServices();
    }, 1500);
}

// é‡å¯å•ä¸ªæœåŠ¡
function restartService(serviceName) {
    if (confirm(`ç¡®å®šè¦é‡å¯æœåŠ¡ "${serviceName}" å—ï¼Ÿ`)) {
        console.log(`æ­£åœ¨é‡å¯æœåŠ¡: ${serviceName}`);
        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„APIè°ƒç”¨
        setTimeout(() => {
            alert(`æœåŠ¡ "${serviceName}" é‡å¯å‘½ä»¤å·²å‘é€`);
            refreshServices();
        }, 800);
    }
}

// æŸ¥çœ‹æœåŠ¡æ—¥å¿—
function viewServiceLog(serviceName) {
    console.log(`æ­£åœ¨æŸ¥çœ‹æœåŠ¡æ—¥å¿—: ${serviceName}`);
    // è¿™é‡Œå¯ä»¥å¯¼èˆªåˆ°æ—¥å¿—é¡µé¢æˆ–æ˜¾ç¤ºæ—¥å¿—æ¨¡æ€æ¡†
    alert(`æœåŠ¡ "${serviceName}" çš„æ—¥å¿—åŠŸèƒ½å¼€å‘ä¸­...`);
}

// å¯¼å‡ºç³»ç»Ÿä¿¡æ¯
function exportSystemInfo() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸ");
        return;
    }
    
    // åˆ›å»ºå¯¼å‡ºå†…å®¹
    const exportData = {
        export_time: new Date().toISOString(),
        cpu_usage: document.getElementById("cpu_usage").textContent,
        memory_usage: document.getElementById("memory_usage").textContent,
        disk_usage: document.getElementById("disk_usage").textContent,
        network_status: document.getElementById("network_status").textContent,
        os_info: document.getElementById("os_info").textContent,
        python_version: document.getElementById("python_version").textContent,
        boot_time: document.getElementById("boot_time").textContent,
        current_time: document.getElementById("current_time").textContent
    };
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `system_info_${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// å¤„ç†è¿›ç¨‹æ“ä½œæŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const periodButtons = document.querySelectorAll('[data-period]');
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            periodButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // è·å–é€‰å®šçš„æ“ä½œç±»å‹
            const operation = this.getAttribute('data-period');
            
            if (operation === '1h') {
                // åˆ·æ–°è¿›ç¨‹åˆ—è¡¨
                loadSystemStatus();
                console.log("è¿›ç¨‹åˆ—è¡¨å·²åˆ·æ–°");
            } else if (operation === '6h') {
                // æ’åºè¿›ç¨‹ï¼ˆæŒ‰CPUä½¿ç”¨ç‡é™åºï¼‰
                sortProcessesByCPU();
                console.log("è¿›ç¨‹å·²æŒ‰CPUä½¿ç”¨ç‡æ’åº");
            } else if (operation === '24h') {
                // è¿‡æ»¤è¿›ç¨‹ï¼ˆåªæ˜¾ç¤ºCPUä½¿ç”¨ç‡>5%çš„è¿›ç¨‹ï¼‰
                filterHighCPUProcesses();
                console.log("å·²è¿‡æ»¤é«˜CPUä½¿ç”¨ç‡çš„è¿›ç¨‹");
            }
        });
    });
});

// æŒ‰CPUä½¿ç”¨ç‡æ’åºè¿›ç¨‹
function sortProcessesByCPU() {
    const container = document.getElementById('systemLoadChart');
    if (!container) return;
    
    const table = container.querySelector('table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const cpuA = parseFloat(a.cells[2].textContent.replace('%', '')) || 0;
        const cpuB = parseFloat(b.cells[2].textContent.replace('%', '')) || 0;
        return cpuB - cpuA; // é™åºæ’åˆ—
    });
    
    // æ¸…ç©ºtbodyå¹¶é‡æ–°æ·»åŠ æ’åºåçš„è¡Œ
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// è¿‡æ»¤é«˜CPUä½¿ç”¨ç‡çš„è¿›ç¨‹ï¼ˆCPU > 5%ï¼‰
function filterHighCPUProcesses() {
    const container = document.getElementById('systemLoadChart');
    if (!container) return;
    
    const table = container.querySelector('table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cpuUsage = parseFloat(row.cells[2].textContent.replace('%', '')) || 0;
        if (cpuUsage > 5) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const stats = container.querySelector('.text-center');
    if (stats) {
        stats.innerHTML = `
            <small class="text-muted">
                æ˜¾ç¤ºè¿›ç¨‹æ•°: <span class="badge bg-secondary">${visibleCount}</span> |
                è¿‡æ»¤æ¡ä»¶: <span class="badge bg-warning">CPU > 5%</span>
            </small>
        `;
    }
}

function navigateTo(target) {
    const menuLinks = document.querySelectorAll('#menu .nav-link');
    menuLinks.forEach(link => {
        if (link.getAttribute('data-target') === target) {
            link.click();
        }
    });
}

// ==================== æ‰‹åŠ¨å®šæ—¶ä»»åŠ¡åŠŸèƒ½ ====================

// ä»»åŠ¡çŠ¶æ€ç®¡ç†
let taskStatus = {
    'fetch_eastmoney_history_market_data': { status: 'waiting', progress: 0 },
    'crawl_llm_insight': { status: 'waiting', progress: 0 },
    'news_ai_summary': { status: 'waiting', progress: 0 }
};

// ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—
let taskQueue = [];
let isTaskRunning = false;

// åˆ·æ–°ä»»åŠ¡çŠ¶æ€
function refreshTaskStatus() {
    updateTaskStatusDisplay();
    console.log("ä»»åŠ¡çŠ¶æ€å·²åˆ·æ–°");
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
function updateTaskStatusDisplay() {
    let runningCount = 0;
    
    // æ›´æ–°æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€æ˜¾ç¤º
    Object.keys(taskStatus).forEach((taskName, index) => {
        const task = taskStatus[taskName];
        const taskId = index + 1;
        
        // æ›´æ–°çŠ¶æ€å¾½ç« 
        const statusElement = document.getElementById(`task${taskId}_status`);
        const progressElement = document.getElementById(`task${taskId}_progress`);
        const buttonElement = document.getElementById(`task${taskId}_btn`);
        const taskItem = document.querySelector(`#task${taskId}_btn`).closest('.task-item');
        
        if (statusElement && progressElement && buttonElement) {
            // è®¾ç½®çŠ¶æ€å¾½ç« 
            let badgeClass = 'bg-secondary';
            let statusText = 'ç­‰å¾…';
            
            switch(task.status) {
                case 'running':
                    badgeClass = 'bg-warning';
                    statusText = 'è¿è¡Œä¸­';
                    runningCount++;
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>æ‰§è¡Œä¸­';
                    
                    // æ·»åŠ è¿è¡Œä¸­çš„è§†è§‰æ•ˆæœ
                    if (taskItem) {
                        taskItem.classList.add('task-running');
                    }
                    break;
                case 'completed':
                    badgeClass = 'bg-success';
                    statusText = 'å·²å®Œæˆ';
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>æ‰§è¡Œ';
                    
                    // ç§»é™¤è¿è¡Œä¸­çš„è§†è§‰æ•ˆæœå¹¶æ·»åŠ æˆåŠŸæ•ˆæœ
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                        taskItem.classList.add('task-success');
                        // 3ç§’åç§»é™¤æˆåŠŸæ•ˆæœ
                        setTimeout(() => {
                            taskItem.classList.remove('task-success');
                        }, 3000);
                    }
                    break;
                case 'error':
                    badgeClass = 'bg-danger';
                    statusText = 'é”™è¯¯';
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>æ‰§è¡Œ';
                    
                    // ç§»é™¤è¿è¡Œä¸­çš„è§†è§‰æ•ˆæœå¹¶æ·»åŠ é”™è¯¯æ•ˆæœ
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                        taskItem.classList.add('task-error');
                        // 3ç§’åç§»é™¤é”™è¯¯æ•ˆæœ
                        setTimeout(() => {
                            taskItem.classList.remove('task-error');
                        }, 3000);
                    }
                    break;
                default:
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-play-fill me-1"></i>æ‰§è¡Œ';
                    
                    // ç§»é™¤è¿è¡Œä¸­çš„è§†è§‰æ•ˆæœ
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                    }
            }
            
            statusElement.className = `badge ${badgeClass} rounded-pill px-3 py-1`;
            statusElement.textContent = statusText;
            
            // æ›´æ–°è¿›åº¦æ¡
            progressElement.style.width = `${task.progress}%`;
            
            // è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            if (task.status === 'running') {
                progressElement.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
            } else if (task.status === 'completed') {
                progressElement.className = 'progress-bar bg-success';
            } else if (task.status === 'error') {
                progressElement.className = 'progress-bar bg-danger';
            } else {
                progressElement.className = 'progress-bar';
            }
        }
    });
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const runningCountElement = document.getElementById('running_count');
    if (runningCountElement) {
        runningCountElement.textContent = `${runningCount} è¿è¡Œä¸­`;
    }
}

// æ‰§è¡Œå•ä¸ªä»»åŠ¡
async function runTask(taskName) {
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­
    taskStatus[taskName] = { status: 'running', progress: 0 };
    updateTaskStatusDisplay();
    
    try {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸ");
            window.location.href = "/login?next=/admin/";
            return;
        }
        
        // è°ƒç”¨åç«¯API
        const response = await fetch(`/admin/api/tasks/run/${taskName}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            taskStatus[taskName] = { status: 'completed', progress: 100 };
            console.log(`ä»»åŠ¡ "${getTaskDisplayName(taskName)}" æ‰§è¡ŒæˆåŠŸ`);
        } else {
            taskStatus[taskName] = { status: 'error', progress: 100 };
            console.error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', result.message);
        }
    } catch (error) {
        taskStatus[taskName] = { status: 'error', progress: 100 };
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
    } finally {
        updateTaskStatusDisplay();
    }
}

// æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ï¼ˆæŒ‰é¡ºåºï¼Œå¸¦å»¶è¿Ÿï¼‰
async function runAllTasks() {
    if (isTaskRunning) {
        alert('æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†æ‰§è¡Œå…¨éƒ¨ä»»åŠ¡');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }
    
    isTaskRunning = true;
    
    try {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸ");
            window.location.href = "/login?next=/admin/";
            return;
        }
        
        // è°ƒç”¨åç«¯APIæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
        const response = await fetch('/admin/api/tasks/run-all', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ:', result);
            alert('æ‰€æœ‰å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼');
            
            // æ›´æ–°æ‰€æœ‰ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
            const tasks = ['fetch_eastmoney_history_market_data', 'crawl_llm_insight', 'news_ai_summary'];
            tasks.forEach(taskName => {
                taskStatus[taskName] = { status: 'completed', progress: 100 };
            });
            updateTaskStatusDisplay();
            
        } else {
            console.error('ä»»åŠ¡æ‰§è¡Œå¤±è´¥:', result.message);
            alert(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${result.message}`);
        }
        
    } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        alert('APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    } finally {
        isTaskRunning = false;
    }
}

// å¸¦è¿›åº¦æ˜¾ç¤ºçš„ä»»åŠ¡æ‰§è¡Œ
async function runTaskWithProgress(taskName, startProgress, endProgress) {
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­
    taskStatus[taskName] = { status: 'running', progress: startProgress };
    updateTaskStatusDisplay();
    
    try {
        await runTask(taskName);
        // ä»»åŠ¡å®Œæˆåè®¾ç½®è¿›åº¦åˆ°ç»“æŸä½ç½®
        taskStatus[taskName].progress = endProgress;
    } catch (error) {
        // ä»»åŠ¡å¤±è´¥ä¹Ÿè®¾ç½®è¿›åº¦åˆ°ç»“æŸä½ç½®
        taskStatus[taskName].progress = endProgress;
        throw error;
    }
    
    updateTaskStatusDisplay();
}

// å¸¦è¿›åº¦æ˜¾ç¤ºçš„å»¶è¿Ÿ
async function delayWithProgress(minSeconds, maxSeconds, startProgress, endProgress) {
    const delaySeconds = Math.floor(Math.random() * (maxSeconds - minSeconds + 1)) + minSeconds;
    const progressStep = (endProgress - startProgress) / delaySeconds;
    
    for (let i = 0; i < delaySeconds; i++) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        const currentProgress = startProgress + (i + 1) * progressStep;
        
        // æ›´æ–°æ‰€æœ‰ä»»åŠ¡çš„è¿›åº¦æ˜¾ç¤ºï¼ˆå»¶è¿ŸæœŸé—´ï¼‰
        Object.keys(taskStatus).forEach(taskName => {
            if (taskStatus[taskName].status === 'waiting') {
                taskStatus[taskName].progress = Math.min(currentProgress, endProgress);
            }
        });
        
        updateTaskStatusDisplay();
    }
}

// åœæ­¢æ‰€æœ‰ä»»åŠ¡
function stopAllTasks() {
    if (!isTaskRunning) {
        alert('å½“å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡');
        return;
    }
    
    if (confirm('ç¡®å®šè¦åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å—ï¼Ÿ')) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„åœæ­¢é€»è¾‘
        // ç›®å‰åªæ˜¯é‡ç½®çŠ¶æ€
        Object.keys(taskStatus).forEach(taskName => {
            if (taskStatus[taskName].status === 'running') {
                taskStatus[taskName] = { status: 'waiting', progress: 0 };
            }
        });
        
        isTaskRunning = false;
        updateTaskStatusDisplay();
        alert('æ‰€æœ‰ä»»åŠ¡å·²åœæ­¢');
    }
}

// è·å–ä»»åŠ¡æ˜¾ç¤ºåç§°
function getTaskDisplayName(taskName) {
    const displayNames = {
        'fetch_eastmoney_history_market_data': 'è·å–ä¸œæ–¹è´¢å¯Œå†å²æ•°æ®',
        'crawl_llm_insight': 'LLMæ´å¯Ÿåˆ†æ',
        'news_ai_summary': 'æ–°é—»AIæ‘˜è¦'
    };
    return displayNames[taskName] || taskName;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    updateTaskStatusDisplay();
});
</script>

<style>
/* è‡ªå®šä¹‰ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
.task-item {
    transition: all 0.3s ease;
    position: relative;
}

.task-item:hover {
    background-color: rgba(59, 130, 246, 0.05);
    transform: translateY(-2px);
}

.task-item:hover .task-icon {
    transform: scale(1.1);
    transition: transform 0.3s ease;
}

.task-icon {
    transition: all 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.task-controls .btn {
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.task-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.task-progress {
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

.task-item:hover .task-progress {
    opacity: 1;
}

.task-stats {
    border-top: 1px solid rgba(0,0,0,0.05);
    background: linear-gradient(to right, #f8f9fa, #e9ecef);
}

/* ä»»åŠ¡çŠ¶æ€å¾½ç« åŠ¨ç”» */
.badge {
    transition: all 0.3s ease;
}

/* è¿›åº¦æ¡åŠ¨ç”» */
.progress-bar {
    transition: width 0.6s ease;
}

/* ä»»åŠ¡æ‰§è¡Œä¸­çš„è„‰å†²æ•ˆæœ */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.task-running .task-icon {
    animation: pulse 1.5s infinite;
}

/* ä»»åŠ¡è¿è¡Œæ—¶çš„è¾¹æ¡†åŠ¨ç”» */
.task-running {
    border-left: 3px solid #ffc107 !important;
    background: linear-gradient(to right, rgba(255, 193, 7, 0.1), transparent);
}

/* ä»»åŠ¡å®Œæˆæ—¶çš„æˆåŠŸæ•ˆæœ */
@keyframes success-flash {
    0% { background-color: rgba(25, 135, 84, 0.2); }
    50% { background-color: rgba(25, 135, 84, 0.4); }
    100% { background-color: rgba(25, 135, 84, 0.2); }
}

.task-success {
    animation: success-flash 1s ease-in-out;
    border-left: 3px solid #198754 !important;
}

/* ä»»åŠ¡é”™è¯¯æ—¶çš„å¤±è´¥æ•ˆæœ */
@keyframes error-flash {
    0% { background-color: rgba(220, 53, 69, 0.2); }
    50% { background-color: rgba(220, 53, 69, 0.4); }
    100% { background-color: rgba(220, 53, 69, 0.2); }
}

.task-error {
    animation: error-flash 1s ease-in-out;
    border-left: 3px solid #dc3545 !important;
}

/* å¡ç‰‡å¤´éƒ¨æ ·å¼ä¼˜åŒ– */
.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* æŒ‰é’®ç»„æ ·å¼ä¼˜åŒ– */
.btn-group-sm > .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* ä»»åŠ¡åˆ—è¡¨åˆ†éš”çº¿ä¼˜åŒ– */
.task-item:not(:last-child) {
    border-bottom: 1px solid rgba(0,0,0,0.05) !important;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .task-controls {
        flex-direction: column;
        align-items: flex-end;
    }
    
    .task-controls .btn {
        margin-bottom: 0.5rem;
    }
    
    .task-stats .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .task-stats .d-flex > div {
        margin-bottom: 0.5rem;
    }
}
</style>