<!-- overview.html -->
<div class="container-fluid">
    <!-- Ê†áÈ¢ò -->
    <h2 class="mb-4">üñ•Ô∏è Á≥ªÁªüÁä∂ÊÄÅÁõëÊéß</h2>

    <!-- Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÁ≥ªÁªüËµÑÊ∫êÁä∂ÊÄÅÂç°ÁâáÔºà4ÂàóÔºâ -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">üíª CPU ‰ΩøÁî®Áéá</h5>
                    <h2 class="card-text" id="cpu_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" id="cpu_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="cpu_cores">Ê†∏ÂøÉÊï∞: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">üß† ÂÜÖÂ≠ò‰ΩøÁî®Áéá</h5>
                    <h2 class="card-text" id="memory_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="memory_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="memory_details">Â∑≤Áî® / ÊÄªËÆ°: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">üíæ Á£ÅÁõò‰ΩøÁî®Áéá</h5>
                    <h2 class="card-text" id="disk_usage">--</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-danger" id="disk_progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="card-text mt-1"><small id="disk_details">Â∑≤Áî® / ÊÄªËÆ°: --</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">üåê ÁΩëÁªúÊµÅÈáè</h5>
                    <h2 class="card-text" id="network_status">--</h2>
                    <p class="card-text mt-1"><small id="network_details">‚Üë -- ‚Üì --</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∫åÈÉ®ÂàÜÔºöÁ≥ªÁªüÁä∂ÊÄÅÂíåÊé•Âè£Áä∂ÊÄÅÔºà2ÂàóÔºâ -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-clock-history me-2"></i>ÂÆöÊó∂‰ªªÂä°ÁÆ°ÁêÜ
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshTaskStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Âà∑Êñ∞
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="runAllTasks()">
                                <i class="bi bi-play-circle me-1"></i>ÂÖ®ÈÉ®ÊâßË°å
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="stopAllTasks()">
                                <i class="bi bi-stop-circle me-1"></i>ÂÖ®ÈÉ®ÂÅúÊ≠¢
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="taskControlPanel">
                        <div class="task-list">
                            <!-- ‰ªªÂä°1ÔºöËé∑Âèñ‰∏úÊñπË¥¢ÂØåÂéÜÂè≤Êï∞ÊçÆ -->
                            <div class="task-item border-bottom">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                                        <i class="bi bi-graph-up fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">1. Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÂéÜÂè≤Êï∞ÊçÆ</h6>
<!--?                                        <p class="mb-0 small text-muted">‰ªé‰∏úÊñπË¥¢ÂØåËé∑ÂèñËÇ°Á•®ÂéÜÂè≤Êï∞ÊçÆ</p>-->
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-primary rounded-pill me-2" onclick="runTask('fetch_eastmoney_history_market_data')" id="task1_btn">
                                            <i class="bi bi-play-fill me-1"></i>ÊâßË°å
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task1_status">Á≠âÂæÖ</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" id="task1_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‰ªªÂä°2ÔºöLLMÊ¥ûÂØüÂàÜÊûê -->
                            <div class="task-item border-bottom">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-success bg-opacity-10 text-success rounded-circle p-2 me-3">
                                        <i class="bi bi-robot fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">2. LLMÊ¥ûÂØüÂàÜÊûê</h6>
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-success rounded-pill me-2" onclick="runTask('crawl_llm_insight')" id="task2_btn">
                                            <i class="bi bi-play-fill me-1"></i>ÊâßË°å
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task2_status">Á≠âÂæÖ</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" id="task2_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‰ªªÂä°3ÔºöÊñ∞ÈóªAIÊëòË¶Å -->
                            <div class="task-item">
                                <div class="d-flex align-items-center p-3">
                                    <div class="task-icon bg-info bg-opacity-10 text-info rounded-circle p-2 me-3">
                                        <i class="bi bi-newspaper fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold">3. Êñ∞ÈóªAIÊëòË¶Å</h6>
<!--?                                        <p class="mb-0 small text-muted">ÁîüÊàêÊñ∞ÈóªAIÊëòË¶Å</p>-->
                                    </div>
                                    <div class="task-controls d-flex align-items-center">
                                        <button class="btn btn-sm btn-success rounded-pill me-2" onclick="runTask('news_ai_summary')" id="task3_btn">
                                            <i class="bi bi-play-fill me-1"></i>ÊâßË°å
                                        </button>
                                        <span class="badge bg-light text-dark rounded-pill px-3 py-1" id="task3_status">Á≠âÂæÖ</span>
                                    </div>
                                </div>
                                <div class="task-progress px-3 pb-3">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" id="task3_progress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‰ªªÂä°ÊâßË°åÁªüËÆ° -->
                        <div class="task-stats bg-light rounded-bottom p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">‰ªªÂä°Áä∂ÊÄÅ:</small>
                                    <span class="badge bg-success rounded-pill me-1" id="running_count">0 ËøêË°å‰∏≠</span>
                                    <span class="text-muted">/</span>
                                    <span class="badge bg-secondary rounded-pill ms-1" id="total_count">3 ÊÄªËÆ°</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Âª∂Ëøü:</small>
                                    <span class="badge bg-info rounded-pill" id="delay_info">5-10s/30-60s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üîå Êé•Âè£Áä∂ÊÄÅ</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="apiStatus">
                        <div class="list-group-item">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∏âÈÉ®ÂàÜÔºöÁ≥ªÁªü‰ø°ÊÅØÂíåÂø´Êç∑Êìç‰Ωú -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ÑπÔ∏è Á≥ªÁªü‰ø°ÊÅØ</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Êìç‰ΩúÁ≥ªÁªü</td>
                                <td id="os_info">--</td>
                            </tr>
                            <tr>
                                <td>PythonÁâàÊú¨</td>
                                <td id="python_version">--</td>
                            </tr>
                            <tr>
                                <td>Á≥ªÁªüÂêØÂä®Êó∂Èó¥</td>
                                <td id="boot_time">--</td>
                            </tr>
                            <tr>
                                <td>ÂΩìÂâçÊó∂Èó¥</td>
                                <td id="current_time">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ö° Á≥ªÁªüÊìç‰Ωú</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshSystemStatus()">üîÑ Âà∑Êñ∞Áä∂ÊÄÅ</button>
                        <button class="btn btn-outline-success" onclick="navigateTo('logs')">üìã Êü•ÁúãÊó•Âøó</button>
                        <button class="btn btn-outline-warning" onclick="navigateTo('config')">‚öôÔ∏è Á≥ªÁªüÈÖçÁΩÆ</button>
                        <button class="btn btn-outline-info" onclick="exportSystemInfo()">üì• ÂØºÂá∫‰ø°ÊÅØ</button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">ÊúÄÂêéÊõ¥Êñ∞: <span id="last_update">--</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÂºïÂÖ• Chart.jsÔºàËΩªÈáèÁ∫ßÂõæË°®Â∫ìÔºâ -->
<script src="/static/js/chart.js"></script>
<script>
// Ê£ÄÊü•Chart.jsÊòØÂê¶ÊàêÂäüÂä†ËΩΩ
if (typeof Chart === 'undefined') {
    console.error('Chart.js Âä†ËΩΩÂ§±Ë¥•ÔºåÂõæË°®ÂäüËÉΩÂ∞Ü‰∏çÂèØÁî®');
}
</script>

<script>
// È°µÈù¢ÊøÄÊ¥ªÊó∂Âä†ËΩΩÊï∞ÊçÆ
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('overview').classList.contains('d-none') === false) {
        loadSystemStatus();
    }
});

// ÁõëÂê¨ÂØºËà™ÂàáÊç¢ÔºåÂ¶ÇÊûúÊòØÂàáÊç¢Âà∞ overviewÔºåÂàôÂä†ËΩΩÊï∞ÊçÆ
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const overviewDiv = document.getElementById('overview');
            if (overviewDiv && !overviewDiv.classList.contains('d-none')) {
                loadSystemStatus();
            }
        }
    });
});

observer.observe(document.getElementById('overview'), { attributes: true });

// ËÆæÁΩÆÂÆöÊó∂Âà∑Êñ∞
let refreshInterval;

function startAutoRefresh() {
    // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÂÆöÊó∂Âô®
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    // ÊØè30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    refreshInterval = setInterval(loadSystemStatus, 30000);
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®Ëá™Âä®Âà∑Êñ∞
document.addEventListener('DOMContentLoaded', startAutoRefresh);

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÈô§ÂÆöÊó∂Âô®
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

async function loadSystemStatus() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("Êú™ÁôªÂΩïÊàñ‰ºöËØùËøáÊúü");
        window.location.href = "/login?next=/admin/";
        return;
    }

    try {
        // 1. Âä†ËΩΩÁ≥ªÁªüËµÑÊ∫êÁä∂ÊÄÅ
        const systemRes = await fetch("/admin/api/system-status", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (!systemRes.ok) throw new Error("Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•");
        const systemData = await systemRes.json();
        
        // Ê£ÄÊü•APIÊòØÂê¶ËøîÂõûÈîôËØØ‰ø°ÊÅØ
        if (systemData.error) {
            throw new Error(systemData.error);
        }

        // Êõ¥Êñ∞CPUÁä∂ÊÄÅ
        if (systemData.cpu) {
            const cpuPercent = systemData.cpu.percent || 0;
            document.getElementById("cpu_usage").textContent = cpuPercent.toFixed(1) + "%";
            document.getElementById("cpu_progress").style.width = cpuPercent + "%";
            document.getElementById("cpu_cores").textContent = `Ê†∏ÂøÉÊï∞: ${systemData.cpu.cores || '--'}`;
            
            // Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆËøõÂ∫¶Êù°È¢úËâ≤
            const cpuBar = document.getElementById("cpu_progress");
            if (cpuPercent > 80) {
                cpuBar.className = "progress-bar bg-danger";
            } else if (cpuPercent > 60) {
                cpuBar.className = "progress-bar bg-warning";
            } else {
                cpuBar.className = "progress-bar";
            }
        }

        // Êõ¥Êñ∞ÂÜÖÂ≠òÁä∂ÊÄÅ
        if (systemData.memory) {
            const memoryPercent = systemData.memory.percent || 0;
            document.getElementById("memory_usage").textContent = memoryPercent.toFixed(1) + "%";
            document.getElementById("memory_progress").style.width = memoryPercent + "%";
            
            const usedGB = (systemData.memory.used / (1024 ** 3)).toFixed(2);
            const totalGB = (systemData.memory.total / (1024 ** 3)).toFixed(2);
            document.getElementById("memory_details").textContent = `Â∑≤Áî® / ÊÄªËÆ°: ${usedGB}GB / ${totalGB}GB`;
            
            // Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆËøõÂ∫¶Êù°È¢úËâ≤
            const memoryBar = document.getElementById("memory_progress");
            if (memoryPercent > 80) {
                memoryBar.className = "progress-bar bg-danger";
            } else if (memoryPercent > 60) {
                memoryBar.className = "progress-bar bg-warning";
            } else {
                memoryBar.className = "progress-bar";
            }
        }

        // Êõ¥Êñ∞Á£ÅÁõòÁä∂ÊÄÅ
        if (systemData.disk) {
            const diskPercent = systemData.disk.percent || 0;
            document.getElementById("disk_usage").textContent = diskPercent.toFixed(1) + "%";
            document.getElementById("disk_progress").style.width = diskPercent + "%";
            
            const usedGB = (systemData.disk.used / (1024 ** 3)).toFixed(2);
            const totalGB = (systemData.disk.total / (1024 ** 3)).toFixed(2);
            document.getElementById("disk_details").textContent = `Â∑≤Áî® / ÊÄªËÆ°: ${usedGB}GB / ${totalGB}GB`;
            
            // Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆËøõÂ∫¶Êù°È¢úËâ≤
            const diskBar = document.getElementById("disk_progress");
            if (diskPercent > 80) {
                diskBar.className = "progress-bar bg-danger";
            } else if (diskPercent > 60) {
                diskBar.className = "progress-bar bg-warning";
            } else {
                diskBar.className = "progress-bar";
            }
        }

        // Êõ¥Êñ∞ÁΩëÁªúÁä∂ÊÄÅ
        if (systemData.network) {
            const uploadSpeed = formatBytes(systemData.network.bytes_sent_per_sec || 0) + "/s";
            const downloadSpeed = formatBytes(systemData.network.bytes_recv_per_sec || 0) + "/s";
            
            // Â¶ÇÊûúÁΩëÁªúÈÄüÁéá‰∏∫0ÔºåÊòæÁ§∫"Á©∫Èó≤"ÔºåÂê¶ÂàôÊòæÁ§∫"Ê≠£Â∏∏"
            const networkStatus = (systemData.network.bytes_sent_per_sec === 0 && systemData.network.bytes_recv_per_sec === 0) ? "Á©∫Èó≤" : "Ê≠£Â∏∏";
            document.getElementById("network_status").textContent = networkStatus;
            document.getElementById("network_details").innerHTML = `‚Üë ${uploadSpeed} ‚Üì ${downloadSpeed}`;
        }

        // Êõ¥Êñ∞Á≥ªÁªü‰ø°ÊÅØ
        if (systemData.system) {
            document.getElementById("os_info").textContent = systemData.system.os || '--';
            document.getElementById("python_version").textContent = systemData.system.python_version || '--';
            document.getElementById("boot_time").textContent = systemData.system.boot_time ? 
                new Date(systemData.system.boot_time * 1000).toLocaleString() : '--';
        }

        // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
        document.getElementById("current_time").textContent = new Date().toLocaleString();
        
        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
        document.getElementById("last_update").textContent = new Date().toLocaleTimeString();

        // 2. Âä†ËΩΩÊé•Âè£Áä∂ÊÄÅ
        const apiRes = await fetch("/admin/api/api-status", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (apiRes.ok) {
            const apiData = await apiRes.json();
            updateApiStatus(apiData.apis || []);
        }

        // 3. Âä†ËΩΩÁ≥ªÁªüË¥üËΩΩÊï∞ÊçÆÂπ∂Êõ¥Êñ∞ÂõæË°®
        const loadRes = await fetch("/admin/api/system-load?period=1h", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (loadRes.ok) {
            const loadData = await loadRes.json();
            try {
                updateSystemLoadChart(loadData);
            } catch (chartErr) {
                console.warn("ÂõæË°®Êõ¥Êñ∞Â§±Ë¥•ÔºåÂèØËÉΩÊòØChart.jsÂä†ËΩΩÈóÆÈ¢ò:", chartErr);
                // ÂõæË°®Â§±Ë¥•‰∏çÂΩ±ÂìçÂÖ∂‰ªñÊï∞ÊçÆÊòæÁ§∫
            }
        }

    } catch (err) {
        console.error("Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:", err);
        
        // Âè™Âú®Êï∞ÊçÆÁ°ÆÂÆûÊú™Âä†ËΩΩÊó∂ÊòæÁ§∫ÈîôËØØÔºåÈÅøÂÖçË¶ÜÁõñÂ∑≤Âä†ËΩΩÁöÑÊï∞ÊçÆ
        if (document.getElementById("cpu_usage").textContent === "--") {
            document.getElementById("cpu_usage").textContent = "ÈîôËØØ";
        }
        if (document.getElementById("memory_usage").textContent === "--") {
            document.getElementById("memory_usage").textContent = "ÈîôËØØ";
        }
        if (document.getElementById("disk_usage").textContent === "--") {
            document.getElementById("disk_usage").textContent = "ÈîôËØØ";
        }
        if (document.getElementById("network_status").textContent === "--") {
            document.getElementById("network_status").textContent = "ÈîôËØØ";
        }
        
        // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÂú®ÊéßÂà∂Âè∞
        console.error("ÈîôËØØËØ¶ÊÉÖ:", err.message);
        if (err.response) {
            console.error("ÂìçÂ∫îÁä∂ÊÄÅ:", err.response.status);
            console.error("ÂìçÂ∫îÊï∞ÊçÆ:", err.response.data);
        }
    }
}

// Ê†ºÂºèÂåñÂ≠óËäÇÊï∞‰∏∫ÊòìËØªÁöÑÂçï‰Ωç
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 B';
    
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// Êõ¥Êñ∞Êé•Âè£Áä∂ÊÄÅ
function updateApiStatus(apiData) {
    const apiStatus = document.getElementById("apiStatus");
    apiStatus.innerHTML = "";
    
    if (!apiData || !Array.isArray(apiData)) {
        const item = document.createElement("div");
        item.className = "list-group-item text-center text-muted";
        item.textContent = "Êó†Êé•Âè£Áä∂ÊÄÅÊï∞ÊçÆ";
        apiStatus.appendChild(item);
        return;
    }
    
    apiData.forEach(api => {
        const item = document.createElement("div");
        item.className = "list-group-item d-flex justify-content-between align-items-center";
        
        let statusBadge = "";
        if (api.status === "healthy") {
            statusBadge = '<span class="badge bg-success">Ê≠£Â∏∏</span>';
        } else if (api.status === "warning") {
            statusBadge = '<span class="badge bg-warning text-dark">Ë≠¶Âëä</span>';
        } else {
            statusBadge = '<span class="badge bg-danger">ÂºÇÂ∏∏</span>';
        }
        
        item.innerHTML = `
            <div>
                <strong>${api.name || api.path}</strong>
                <div class="small text-muted">${api.method || 'GET'} ${api.path}</div>
            </div>
            <div class="text-end">
                ${statusBadge}
                <div class="small text-muted">${api.response_time || '--'}ms</div>
            </div>
        `;
        apiStatus.appendChild(item);
    });
}

// Êõ¥Êñ∞Á≥ªÁªüÊúçÂä°Áä∂ÊÄÅ
function updateSystemLoadChart(data) {
    const container = document.getElementById('systemLoadChart');
    if (!container) {
        return;
    }

    // Ê∏ÖÁ©∫ÂÆπÂô®ÂÜÖÂÆπ
    container.innerHTML = '';

    // ÂàõÂª∫ÊúçÂä°Áä∂ÊÄÅÂàóË°®
    const serviceList = document.createElement('div');
    serviceList.className = 'list-group list-group-flush';
    
    // Ê®°ÊãüÁ≥ªÁªüÊúçÂä°Êï∞ÊçÆÔºàÂÆûÈôÖ‰ΩøÁî®Êó∂Â∫îËØ•‰ªéÂêéÂè∞APIËé∑ÂèñÔºâ
    const services = [
        { 
            name: 'WebÊúçÂä°Âô®', 
            status: 'running', 
            uptime: '3Â§© 12Â∞èÊó∂', 
            port: '80/443',
            description: '‰∏ªWebÊúçÂä°'
        },
        { 
            name: 'Êï∞ÊçÆÂ∫ìÊúçÂä°', 
            status: 'running', 
            uptime: '7Â§© 8Â∞èÊó∂', 
            port: '3306',
            description: 'MySQLÊï∞ÊçÆÂ∫ì'
        },
        { 
            name: 'RedisÁºìÂ≠ò', 
            status: 'running', 
            uptime: '2Â§© 15Â∞èÊó∂', 
            port: '6379',
            description: 'ÂÜÖÂ≠òÁºìÂ≠òÊúçÂä°'
        },
        { 
            name: 'ÂÆöÊó∂‰ªªÂä°', 
            status: 'warning', 
            uptime: '1Â§© 3Â∞èÊó∂', 
            port: '-',
            description: 'Ë∞ÉÂ∫¶Âô®ÊúçÂä°'
        },
        { 
            name: 'Êó•ÂøóÊúçÂä°', 
            status: 'running', 
            uptime: '5Â§© 6Â∞èÊó∂', 
            port: '-',
            description: 'Êó•ÂøóÊî∂ÈõÜÊúçÂä°'
        }
    ];

    // Â¶ÇÊûúÊúâÂéÜÂè≤Êï∞ÊçÆÔºåÊòæÁ§∫ÊúÄËøëÁöÑÊúçÂä°Áä∂ÊÄÅ
    if (data && Array.isArray(data) && data.length > 0) {
        const latestData = data[data.length - 1];
        if (latestData.services && Array.isArray(latestData.services)) {
            latestData.services.forEach(service => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                
                let statusBadge = '';
                let statusIcon = '';
                if (service.status === 'running') {
                    statusBadge = 'bg-success';
                    statusIcon = '‚úÖ';
                } else if (service.status === 'warning') {
                    statusBadge = 'bg-warning';
                    statusIcon = '‚ö†Ô∏è';
                } else {
                    statusBadge = 'bg-danger';
                    statusIcon = '‚ùå';
                }
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h6 class="mb-1">${statusIcon} ${service.name || 'Êú™Áü•ÊúçÂä°'}</h6>
                            <p class="mb-1 small text-muted">${service.description || ''}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge ${statusBadge}">${service.status || 'Êú™Áü•'}</span>
                            <div class="small text-muted mt-1">Á´ØÂè£: ${service.port || '--'}</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">ËøêË°åÊó∂Èó¥: ${service.uptime || '--'}</small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="restartService('${service.name}')">ÈáçÂêØ</button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewServiceLog('${service.name}')">Êó•Âøó</button>
                        </div>
                    </div>
                `;
                serviceList.appendChild(item);
            });
        }
    } else {
        // ÊòæÁ§∫Ê®°ÊãüÊï∞ÊçÆ
        services.forEach(service => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            
            let statusBadge = '';
            let statusIcon = '';
            if (service.status === 'running') {
                statusBadge = 'bg-success';
                statusIcon = '‚úÖ';
            } else if (service.status === 'warning') {
                statusBadge = 'bg-warning';
                statusIcon = '‚ö†Ô∏è';
            } else {
                statusBadge = 'bg-danger';
                statusIcon = '‚ùå';
            }
            
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <h6 class="mb-1">${statusIcon} ${service.name}</h6>
                        <p class="mb-1 small text-muted">${service.description}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${statusBadge}">${service.status}</span>
                        <div class="small text-muted mt-1">Á´ØÂè£: ${service.port}</div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">ËøêË°åÊó∂Èó¥: ${service.uptime}</small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="restartService('${service.name}')">ÈáçÂêØ</button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewServiceLog('${service.name}')">Êó•Âøó</button>
                    </div>
                </div>
            `;
            serviceList.appendChild(item);
        });
    }

    container.appendChild(serviceList);

    // Ê∑ªÂä†Â∫ïÈÉ®ÁªüËÆ°‰ø°ÊÅØ
    const stats = document.createElement('div');
    stats.className = 'mt-3 text-center';
    const runningCount = services.filter(s => s.status === 'running').length;
    const totalCount = services.length;
    stats.innerHTML = `
        <small class="text-muted">
            ÊúçÂä°Áä∂ÊÄÅ: <span class="badge bg-success">${runningCount} ËøêË°å‰∏≠</span> 
            / <span class="badge bg-secondary">${totalCount} ÊÄªËÆ°</span>
            | Á≥ªÁªüÂÅ•Â∫∑Â∫¶: <span class="badge bg-info">${Math.round((runningCount/totalCount)*100)}%</span>
        </small>
    `;
    container.appendChild(stats);
}

// Âà∑Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
function refreshSystemStatus() {
    loadSystemStatus();
}

// Âà∑Êñ∞ÊúçÂä°Áä∂ÊÄÅ
function refreshServices() {
    loadSystemStatus();
    console.log("ÊúçÂä°Áä∂ÊÄÅÂ∑≤Âà∑Êñ∞");
}

// ÈáçÂêØÊâÄÊúâÊúçÂä°
function restartAllServices() {
    if (confirm("Á°ÆÂÆöË¶ÅÈáçÂêØÊâÄÊúâÊúçÂä°ÂêóÔºüËøôÂèØËÉΩ‰ºöÂØºËá¥Áü≠ÊöÇÁöÑÊúçÂä°‰∏≠Êñ≠„ÄÇ")) {
        console.log("Ê≠£Âú®ÈáçÂêØÊâÄÊúâÊúçÂä°...");
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑAPIË∞ÉÁî®
        setTimeout(() => {
            alert("ÊúçÂä°ÈáçÂêØÂëΩ‰ª§Â∑≤ÂèëÈÄÅ");
            refreshServices();
        }, 1000);
    }
}

// Ê£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
function checkServiceHealth() {
    console.log("Ê≠£Âú®Ê£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ...");
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑAPIË∞ÉÁî®
    setTimeout(() => {
        alert("ÊúçÂä°ÂÅ•Â∫∑Ê£ÄÊü•ÂÆåÊàê");
        refreshServices();
    }, 1500);
}

// ÈáçÂêØÂçï‰∏™ÊúçÂä°
function restartService(serviceName) {
    if (confirm(`Á°ÆÂÆöË¶ÅÈáçÂêØÊúçÂä° "${serviceName}" ÂêóÔºü`)) {
        console.log(`Ê≠£Âú®ÈáçÂêØÊúçÂä°: ${serviceName}`);
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑAPIË∞ÉÁî®
        setTimeout(() => {
            alert(`ÊúçÂä° "${serviceName}" ÈáçÂêØÂëΩ‰ª§Â∑≤ÂèëÈÄÅ`);
            refreshServices();
        }, 800);
    }
}

// Êü•ÁúãÊúçÂä°Êó•Âøó
function viewServiceLog(serviceName) {
    console.log(`Ê≠£Âú®Êü•ÁúãÊúçÂä°Êó•Âøó: ${serviceName}`);
    // ËøôÈáåÂèØ‰ª•ÂØºËà™Âà∞Êó•ÂøóÈ°µÈù¢ÊàñÊòæÁ§∫Êó•ÂøóÊ®°ÊÄÅÊ°Ü
    alert(`ÊúçÂä° "${serviceName}" ÁöÑÊó•ÂøóÂäüËÉΩÂºÄÂèë‰∏≠...`);
}

// ÂØºÂá∫Á≥ªÁªü‰ø°ÊÅØ
function exportSystemInfo() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("Êú™ÁôªÂΩïÊàñ‰ºöËØùËøáÊúü");
        return;
    }
    
    // ÂàõÂª∫ÂØºÂá∫ÂÜÖÂÆπ
    const exportData = {
        export_time: new Date().toISOString(),
        cpu_usage: document.getElementById("cpu_usage").textContent,
        memory_usage: document.getElementById("memory_usage").textContent,
        disk_usage: document.getElementById("disk_usage").textContent,
        network_status: document.getElementById("network_status").textContent,
        os_info: document.getElementById("os_info").textContent,
        python_version: document.getElementById("python_version").textContent,
        boot_time: document.getElementById("boot_time").textContent,
        current_time: document.getElementById("current_time").textContent
    };
    
    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `system_info_${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// Â§ÑÁêÜËøõÁ®ãÊìç‰ΩúÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
document.addEventListener('DOMContentLoaded', function() {
    const periodButtons = document.querySelectorAll('[data-period]');
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            periodButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Ëé∑ÂèñÈÄâÂÆöÁöÑÊìç‰ΩúÁ±ªÂûã
            const operation = this.getAttribute('data-period');
            
            if (operation === '1h') {
                // Âà∑Êñ∞ËøõÁ®ãÂàóË°®
                loadSystemStatus();
                console.log("ËøõÁ®ãÂàóË°®Â∑≤Âà∑Êñ∞");
            } else if (operation === '6h') {
                // ÊéíÂ∫èËøõÁ®ãÔºàÊåâCPU‰ΩøÁî®ÁéáÈôçÂ∫èÔºâ
                sortProcessesByCPU();
                console.log("ËøõÁ®ãÂ∑≤ÊåâCPU‰ΩøÁî®ÁéáÊéíÂ∫è");
            } else if (operation === '24h') {
                // ËøáÊª§ËøõÁ®ãÔºàÂè™ÊòæÁ§∫CPU‰ΩøÁî®Áéá>5%ÁöÑËøõÁ®ãÔºâ
                filterHighCPUProcesses();
                console.log("Â∑≤ËøáÊª§È´òCPU‰ΩøÁî®ÁéáÁöÑËøõÁ®ã");
            }
        });
    });
});

// ÊåâCPU‰ΩøÁî®ÁéáÊéíÂ∫èËøõÁ®ã
function sortProcessesByCPU() {
    const container = document.getElementById('systemLoadChart');
    if (!container) return;
    
    const table = container.querySelector('table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const cpuA = parseFloat(a.cells[2].textContent.replace('%', '')) || 0;
        const cpuB = parseFloat(b.cells[2].textContent.replace('%', '')) || 0;
        return cpuB - cpuA; // ÈôçÂ∫èÊéíÂàó
    });
    
    // Ê∏ÖÁ©∫tbodyÂπ∂ÈáçÊñ∞Ê∑ªÂä†ÊéíÂ∫èÂêéÁöÑË°å
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

// ËøáÊª§È´òCPU‰ΩøÁî®ÁéáÁöÑËøõÁ®ãÔºàCPU > 5%Ôºâ
function filterHighCPUProcesses() {
    const container = document.getElementById('systemLoadChart');
    if (!container) return;
    
    const table = container.querySelector('table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cpuUsage = parseFloat(row.cells[2].textContent.replace('%', '')) || 0;
        if (cpuUsage > 5) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
    const stats = container.querySelector('.text-center');
    if (stats) {
        stats.innerHTML = `
            <small class="text-muted">
                ÊòæÁ§∫ËøõÁ®ãÊï∞: <span class="badge bg-secondary">${visibleCount}</span> |
                ËøáÊª§Êù°‰ª∂: <span class="badge bg-warning">CPU > 5%</span>
            </small>
        `;
    }
}

function navigateTo(target) {
    const menuLinks = document.querySelectorAll('#menu .nav-link');
    menuLinks.forEach(link => {
        if (link.getAttribute('data-target') === target) {
            link.click();
        }
    });
}

// ==================== ÊâãÂä®ÂÆöÊó∂‰ªªÂä°ÂäüËÉΩ ====================

// ‰ªªÂä°Áä∂ÊÄÅÁÆ°ÁêÜ
let taskStatus = {
    'fetch_eastmoney_history_market_data': { status: 'waiting', progress: 0 },
    'crawl_llm_insight': { status: 'waiting', progress: 0 },
    'news_ai_summary': { status: 'waiting', progress: 0 }
};

// ‰ªªÂä°ÊâßË°åÈòüÂàó
let taskQueue = [];
let isTaskRunning = false;

// Âà∑Êñ∞‰ªªÂä°Áä∂ÊÄÅ
function refreshTaskStatus() {
    updateTaskStatusDisplay();
    console.log("‰ªªÂä°Áä∂ÊÄÅÂ∑≤Âà∑Êñ∞");
}

// Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅÊòæÁ§∫
function updateTaskStatusDisplay() {
    let runningCount = 0;
    
    // Êõ¥Êñ∞ÊØè‰∏™‰ªªÂä°ÁöÑÁä∂ÊÄÅÊòæÁ§∫
    Object.keys(taskStatus).forEach((taskName, index) => {
        const task = taskStatus[taskName];
        const taskId = index + 1;
        
        // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†
        const statusElement = document.getElementById(`task${taskId}_status`);
        const progressElement = document.getElementById(`task${taskId}_progress`);
        const buttonElement = document.getElementById(`task${taskId}_btn`);
        const taskItem = document.querySelector(`#task${taskId}_btn`).closest('.task-item');
        
        if (statusElement && progressElement && buttonElement) {
            // ËÆæÁΩÆÁä∂ÊÄÅÂæΩÁ´†
            let badgeClass = 'bg-secondary';
            let statusText = 'Á≠âÂæÖ';
            
            switch(task.status) {
                case 'running':
                    badgeClass = 'bg-warning';
                    statusText = 'ËøêË°å‰∏≠';
                    runningCount++;
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>ÊâßË°å‰∏≠';
                    
                    // Ê∑ªÂä†ËøêË°å‰∏≠ÁöÑËßÜËßâÊïàÊûú
                    if (taskItem) {
                        taskItem.classList.add('task-running');
                    }
                    break;
                case 'completed':
                    badgeClass = 'bg-success';
                    statusText = 'Â∑≤ÂÆåÊàê';
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>ÊâßË°å';
                    
                    // ÁßªÈô§ËøêË°å‰∏≠ÁöÑËßÜËßâÊïàÊûúÂπ∂Ê∑ªÂä†ÊàêÂäüÊïàÊûú
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                        taskItem.classList.add('task-success');
                        // 3ÁßíÂêéÁßªÈô§ÊàêÂäüÊïàÊûú
                        setTimeout(() => {
                            taskItem.classList.remove('task-success');
                        }, 3000);
                    }
                    break;
                case 'error':
                    badgeClass = 'bg-danger';
                    statusText = 'ÈîôËØØ';
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>ÊâßË°å';
                    
                    // ÁßªÈô§ËøêË°å‰∏≠ÁöÑËßÜËßâÊïàÊûúÂπ∂Ê∑ªÂä†ÈîôËØØÊïàÊûú
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                        taskItem.classList.add('task-error');
                        // 3ÁßíÂêéÁßªÈô§ÈîôËØØÊïàÊûú
                        setTimeout(() => {
                            taskItem.classList.remove('task-error');
                        }, 3000);
                    }
                    break;
                default:
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="bi bi-play-fill me-1"></i>ÊâßË°å';
                    
                    // ÁßªÈô§ËøêË°å‰∏≠ÁöÑËßÜËßâÊïàÊûú
                    if (taskItem) {
                        taskItem.classList.remove('task-running');
                    }
            }
            
            statusElement.className = `badge ${badgeClass} rounded-pill px-3 py-1`;
            statusElement.textContent = statusText;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            progressElement.style.width = `${task.progress}%`;
            
            // ËÆæÁΩÆËøõÂ∫¶Êù°È¢úËâ≤
            if (task.status === 'running') {
                progressElement.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
            } else if (task.status === 'completed') {
                progressElement.className = 'progress-bar bg-success';
            } else if (task.status === 'error') {
                progressElement.className = 'progress-bar bg-danger';
            } else {
                progressElement.className = 'progress-bar';
            }
        }
    });
    
    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
    const runningCountElement = document.getElementById('running_count');
    if (runningCountElement) {
        runningCountElement.textContent = `${runningCount} ËøêË°å‰∏≠`;
    }
}

// ÊâßË°åÂçï‰∏™‰ªªÂä°
async function runTask(taskName) {
    // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ‰∏∫ËøêË°å‰∏≠
    taskStatus[taskName] = { status: 'running', progress: 0 };
    updateTaskStatusDisplay();
    
    try {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("Êú™ÁôªÂΩïÊàñ‰ºöËØùËøáÊúü");
            window.location.href = "/login?next=/admin/";
            return;
        }
        
        // Ë∞ÉÁî®ÂêéÁ´ØAPI
        const response = await fetch(`/admin/api/tasks/run/${taskName}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            taskStatus[taskName] = { status: 'completed', progress: 100 };
            console.log(`‰ªªÂä° "${getTaskDisplayName(taskName)}" ÊâßË°åÊàêÂäü`);
        } else {
            taskStatus[taskName] = { status: 'error', progress: 100 };
            console.error('‰ªªÂä°ÊâßË°åÂ§±Ë¥•:', result.message);
        }
    } catch (error) {
        taskStatus[taskName] = { status: 'error', progress: 100 };
        console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
    } finally {
        updateTaskStatusDisplay();
    }
}

// ÊâßË°åÊâÄÊúâ‰ªªÂä°ÔºàÊåâÈ°∫Â∫èÔºåÂ∏¶Âª∂ËøüÔºâ
async function runAllTasks() {
    if (isTaskRunning) {
        alert('Êúâ‰ªªÂä°Ê≠£Âú®ÊâßË°å‰∏≠ÔºåËØ∑Á≠âÂæÖÂÆåÊàêÂêéÂÜçÊâßË°åÂÖ®ÈÉ®‰ªªÂä°');
        return;
    }
    
    if (!confirm('Á°ÆÂÆöË¶ÅÊâßË°åÊâÄÊúâÂÆöÊó∂‰ªªÂä°ÂêóÔºüËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíüÊó∂Èó¥„ÄÇ')) {
        return;
    }
    
    isTaskRunning = true;
    
    try {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("Êú™ÁôªÂΩïÊàñ‰ºöËØùËøáÊúü");
            window.location.href = "/login?next=/admin/";
            return;
        }
        
        // Ë∞ÉÁî®ÂêéÁ´ØAPIÊâßË°åÊâÄÊúâ‰ªªÂä°
        const response = await fetch('/admin/api/tasks/run-all', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('ÊâÄÊúâ‰ªªÂä°ÊâßË°åÂÆåÊàê:', result);
            alert('ÊâÄÊúâÂÆöÊó∂‰ªªÂä°ÊâßË°åÂÆåÊàêÔºÅ');
            
            // Êõ¥Êñ∞ÊâÄÊúâ‰ªªÂä°Áä∂ÊÄÅ‰∏∫ÂÆåÊàê
            const tasks = ['fetch_eastmoney_history_market_data', 'crawl_llm_insight', 'news_ai_summary'];
            tasks.forEach(taskName => {
                taskStatus[taskName] = { status: 'completed', progress: 100 };
            });
            updateTaskStatusDisplay();
            
        } else {
            console.error('‰ªªÂä°ÊâßË°åÂ§±Ë¥•:', result.message);
            alert(`‰ªªÂä°ÊâßË°åÂ§±Ë¥•: ${result.message}`);
        }
        
    } catch (error) {
        console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
        alert('APIËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    } finally {
        isTaskRunning = false;
    }
}

// Â∏¶ËøõÂ∫¶ÊòæÁ§∫ÁöÑ‰ªªÂä°ÊâßË°å
async function runTaskWithProgress(taskName, startProgress, endProgress) {
    // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ‰∏∫ËøêË°å‰∏≠
    taskStatus[taskName] = { status: 'running', progress: startProgress };
    updateTaskStatusDisplay();
    
    try {
        await runTask(taskName);
        // ‰ªªÂä°ÂÆåÊàêÂêéËÆæÁΩÆËøõÂ∫¶Âà∞ÁªìÊùü‰ΩçÁΩÆ
        taskStatus[taskName].progress = endProgress;
    } catch (error) {
        // ‰ªªÂä°Â§±Ë¥•‰πüËÆæÁΩÆËøõÂ∫¶Âà∞ÁªìÊùü‰ΩçÁΩÆ
        taskStatus[taskName].progress = endProgress;
        throw error;
    }
    
    updateTaskStatusDisplay();
}

// Â∏¶ËøõÂ∫¶ÊòæÁ§∫ÁöÑÂª∂Ëøü
async function delayWithProgress(minSeconds, maxSeconds, startProgress, endProgress) {
    const delaySeconds = Math.floor(Math.random() * (maxSeconds - minSeconds + 1)) + minSeconds;
    const progressStep = (endProgress - startProgress) / delaySeconds;
    
    for (let i = 0; i < delaySeconds; i++) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        const currentProgress = startProgress + (i + 1) * progressStep;
        
        // Êõ¥Êñ∞ÊâÄÊúâ‰ªªÂä°ÁöÑËøõÂ∫¶ÊòæÁ§∫ÔºàÂª∂ËøüÊúüÈó¥Ôºâ
        Object.keys(taskStatus).forEach(taskName => {
            if (taskStatus[taskName].status === 'waiting') {
                taskStatus[taskName].progress = Math.min(currentProgress, endProgress);
            }
        });
        
        updateTaskStatusDisplay();
    }
}

// ÂÅúÊ≠¢ÊâÄÊúâ‰ªªÂä°
function stopAllTasks() {
    if (!isTaskRunning) {
        alert('ÂΩìÂâçÊ≤°ÊúâÊ≠£Âú®ËøêË°åÁöÑ‰ªªÂä°');
        return;
    }
    
    if (confirm('Á°ÆÂÆöË¶ÅÂÅúÊ≠¢ÊâÄÊúâÊ≠£Âú®ÊâßË°åÁöÑ‰ªªÂä°ÂêóÔºü')) {
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑÂÅúÊ≠¢ÈÄªËæë
        // ÁõÆÂâçÂè™ÊòØÈáçÁΩÆÁä∂ÊÄÅ
        Object.keys(taskStatus).forEach(taskName => {
            if (taskStatus[taskName].status === 'running') {
                taskStatus[taskName] = { status: 'waiting', progress: 0 };
            }
        });
        
        isTaskRunning = false;
        updateTaskStatusDisplay();
        alert('ÊâÄÊúâ‰ªªÂä°Â∑≤ÂÅúÊ≠¢');
    }
}

// Ëé∑Âèñ‰ªªÂä°ÊòæÁ§∫ÂêçÁß∞
function getTaskDisplayName(taskName) {
    const displayNames = {
        'fetch_eastmoney_history_market_data': 'Ëé∑Âèñ‰∏úÊñπË¥¢ÂØåÂéÜÂè≤Êï∞ÊçÆ',
        'crawl_llm_insight': 'LLMÊ¥ûÂØüÂàÜÊûê',
        'news_ai_summary': 'Êñ∞ÈóªAIÊëòË¶Å'
    };
    return displayNames[taskName] || taskName;
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰ªªÂä°Áä∂ÊÄÅÊòæÁ§∫
document.addEventListener('DOMContentLoaded', function() {
    updateTaskStatusDisplay();
});
</script>

<style>
/* Ëá™ÂÆö‰πâ‰ªªÂä°ÂàóË°®Ê†∑Âºè */
.task-item {
    transition: all 0.3s ease;
    position: relative;
}

.task-item:hover {
    background-color: rgba(59, 130, 246, 0.05);
    transform: translateY(-2px);
}

.task-item:hover .task-icon {
    transform: scale(1.1);
    transition: transform 0.3s ease;
}

.task-icon {
    transition: all 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.task-controls .btn {
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.task-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.task-progress {
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

.task-item:hover .task-progress {
    opacity: 1;
}

.task-stats {
    border-top: 1px solid rgba(0,0,0,0.05);
    background: linear-gradient(to right, #f8f9fa, #e9ecef);
}

/* ‰ªªÂä°Áä∂ÊÄÅÂæΩÁ´†Âä®Áîª */
.badge {
    transition: all 0.3s ease;
}

/* ËøõÂ∫¶Êù°Âä®Áîª */
.progress-bar {
    transition: width 0.6s ease;
}

/* ‰ªªÂä°ÊâßË°å‰∏≠ÁöÑËÑâÂÜ≤ÊïàÊûú */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.task-running .task-icon {
    animation: pulse 1.5s infinite;
}

/* ‰ªªÂä°ËøêË°åÊó∂ÁöÑËæπÊ°ÜÂä®Áîª */
.task-running {
    border-left: 3px solid #ffc107 !important;
    background: linear-gradient(to right, rgba(255, 193, 7, 0.1), transparent);
}

/* ‰ªªÂä°ÂÆåÊàêÊó∂ÁöÑÊàêÂäüÊïàÊûú */
@keyframes success-flash {
    0% { background-color: rgba(25, 135, 84, 0.2); }
    50% { background-color: rgba(25, 135, 84, 0.4); }
    100% { background-color: rgba(25, 135, 84, 0.2); }
}

.task-success {
    animation: success-flash 1s ease-in-out;
    border-left: 3px solid #198754 !important;
}

/* ‰ªªÂä°ÈîôËØØÊó∂ÁöÑÂ§±Ë¥•ÊïàÊûú */
@keyframes error-flash {
    0% { background-color: rgba(220, 53, 69, 0.2); }
    50% { background-color: rgba(220, 53, 69, 0.4); }
    100% { background-color: rgba(220, 53, 69, 0.2); }
}

.task-error {
    animation: error-flash 1s ease-in-out;
    border-left: 3px solid #dc3545 !important;
}

/* Âç°ÁâáÂ§¥ÈÉ®Ê†∑Âºè‰ºòÂåñ */
.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* ÊåâÈíÆÁªÑÊ†∑Âºè‰ºòÂåñ */
.btn-group-sm > .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* ‰ªªÂä°ÂàóË°®ÂàÜÈöîÁ∫ø‰ºòÂåñ */
.task-item:not(:last-child) {
    border-bottom: 1px solid rgba(0,0,0,0.05) !important;
}

/* ÂìçÂ∫îÂºè‰ºòÂåñ */
@media (max-width: 768px) {
    .task-controls {
        flex-direction: column;
        align-items: flex-end;
    }
    
    .task-controls .btn {
        margin-bottom: 0.5rem;
    }
    
    .task-stats .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .task-stats .d-flex > div {
        margin-bottom: 0.5rem;
    }
}
</style>