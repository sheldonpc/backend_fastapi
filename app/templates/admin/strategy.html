<style>
    :root {
        --primary-color: #3b82f6;
        --primary-gradient: linear-gradient(135deg, #3b82f6 0%, rgba(59, 130, 246, 0.8) 90%);
        --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        --border-color: #e2e8f0;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        margin: 0;
    }

    .container-fluid {
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: black;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card {
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        border: none;
        overflow: hidden;
    }

    .table-responsive {
        border-radius: 15px;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #334155;
        background-color: #f8fafc;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }

    .btn-success {
        background: var(--primary-gradient);
        border: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 500;
    }

    .badge.bg-success {
        background-color: #10b981 !important;
    }

    .badge.bg-secondary {
        background-color: #6b7280 !important;
    }

    .badge.bg-info {
        background-color: #3b82f6 !important;
    }

    .badge.bg-warning {
        background-color: #f59e0b !important;
    }

    .badge.bg-danger {
        background-color: #ef4444 !important;
    }

    .strategy-icon {
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(59, 130, 246, 0.1);
        color: var(--primary-color);
        margin-right: 0.5rem;
    }

    .strategy-name {
        font-weight: 600;
        color: #1f2937;
    }

    .strategy-intro {
        font-size: 0.85rem;
        color: #6b7280;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-bottom: 1px solid var(--border-color);
        border-radius: 15px 15px 0 0;
    }

    .form-control, .form-select {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    .form-label {
        font-weight: 600;
        color: #374151;
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: none;
        border-radius: 8px;
        font-weight: 500;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tag {
        background-color: rgba(59, 130, 246, 0.1);
        color: var(--primary-color);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .result-data-item {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .result-data-key {
        font-weight: 600;
        color: #374151;
    }

    .result-data-value {
        color: #6b7280;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #d1d5db;
    }

    .loading-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }

    .loading-state i {
        font-size: 2rem;
        margin-bottom: 1rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .strategy-intro {
            max-width: 200px;
        }
    }
</style>

<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-graph-up"></i>
            ç­–ç•¥ç®¡ç†
        </h1>
        <button class="btn btn-success" onclick="createNewStrategy()">
            <i class="bi bi-plus-circle me-2"></i>æ–°å¢ç­–ç•¥
        </button>
    </div>

    <!-- æ“ä½œæç¤º -->
    <div class="alert alert-info d-flex align-items-center" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <div>
            ğŸ’¡ å·²å‘å¸ƒçš„ç­–ç•¥ä¸å¯åˆ é™¤ï¼Œä½†å¯ä»¥ç¼–è¾‘ã€‚è‰ç¨¿çŠ¶æ€çš„ç­–ç•¥å¯ä»¥åˆ é™¤ã€‚
        </div>
    </div>

    <!-- ç­–ç•¥è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ç­–ç•¥åç§°</th>
                        <th>ç»„åˆ«</th>
                        <th>çŠ¶æ€</th>
                        <th>éš¾åº¦</th>
                        <th>é£é™©ç­‰çº§</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æµè§ˆé‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="strategiesTableBody">
                    <tr>
                        <td colspan="8" class="loading-state">
                            <i class="bi bi-arrow-clockwise"></i>
                            <div>åŠ è½½ä¸­...</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ç­–ç•¥è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="strategyDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="strategyDetailModalLabel">ç­–ç•¥è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>åŸºæœ¬ä¿¡æ¯</h6>
                        <table class="table table-sm">
                            <tr>
                                <td width="30%">ç­–ç•¥åç§°</td>
                                <td id="detail-name"></td>
                            </tr>
                            <tr>
                                <td>ç­–ç•¥ç»„åˆ«</td>
                                <td id="detail-group"></td>
                            </tr>
                            <tr>
                                <td>ç­–ç•¥ç®€ä»‹</td>
                                <td id="detail-intro"></td>
                            </tr>
                            <tr>
                                <td>éš¾åº¦</td>
                                <td id="detail-difficulty"></td>
                            </tr>
                            <tr>
                                <td>é£é™©ç­‰çº§</td>
                                <td id="detail-risk"></td>
                            </tr>
                            <tr>
                                <td>æŒä»“å‘¨æœŸ</td>
                                <td id="detail-period"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>ç­–ç•¥æŒ‡æ ‡</h6>
                        <table class="table table-sm">
                            <tr>
                                <td width="30%">é¢„æœŸæ”¶ç›Šç‡</td>
                                <td id="detail-return"></td>
                            </tr>
                            <tr>
                                <td>æœ€å¤§å›æ’¤</td>
                                <td id="detail-drawdown"></td>
                            </tr>
                            <tr>
                                <td>å¤æ™®æ¯”ç‡</td>
                                <td id="detail-sharpe"></td>
                            </tr>
                            <tr>
                                <td>èƒœç‡</td>
                                <td id="detail-winrate"></td>
                            </tr>
                            <tr>
                                <td>æµè§ˆé‡</td>
                                <td id="detail-views"></td>
                            </tr>
                            <tr>
                                <td>ç‚¹èµæ•°</td>
                                <td id="detail-likes"></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>é€‚ç”¨å¸‚åœºæ¡ä»¶</h6>
                        <div id="detail-conditions" class="tags-container"></div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>æ‰€éœ€æŠ€æœ¯æŒ‡æ ‡</h6>
                        <div id="detail-indicators" class="tags-container"></div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>ç­–ç•¥æ ‡ç­¾</h6>
                        <div id="detail-tags" class="tags-container"></div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>ç»“æœæ•°æ®</h6>
                        <div id="detail-result-data"></div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>ç»“æœå›¾ç‰‡</h6>
                        <div id="detail-result-pics" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘ç­–ç•¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="strategyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="strategyModalLabel">æ–°å¢ç­–ç•¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="strategyId"/>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ç­–ç•¥åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="strategyName" placeholder="è¯·è¾“å…¥ç­–ç•¥åç§°"
                                   required/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ç­–ç•¥ç»„åˆ« <span class="text-danger">*</span></label>
                            <select class="form-select" id="strategyGroup" required>
                                <option value="">è¯·é€‰æ‹©ç»„åˆ«</option>
                                <option value="è¶‹åŠ¿ç±»ç­–ç•¥">è¶‹åŠ¿ç±»ç­–ç•¥</option>
                                <option value="ä»·å€¼ç±»ç­–ç•¥">ä»·å€¼ç±»ç­–ç•¥</option>
                                <option value="æˆé•¿ç±»ç­–ç•¥">æˆé•¿ç±»ç­–ç•¥</option>
                                <option value="å…¶ä»–ç±»ç­–ç•¥">å…¶ä»–ç±»ç­–ç•¥</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ç­–ç•¥å›¾æ ‡</label>
                            <select class="form-select" id="strategyIcon">
                                <option value="bi-speedometer2">åŠ¨é‡ç­–ç•¥</option>
                                <option value="bi-arrow-left-right">å‡å€¼å›å½’</option>
                                <option value="bi-bar-chart-line">æŠ€æœ¯åˆ†æ</option>
                                <option value="bi-piggy-bank">ä»·å€¼æŠ•èµ„</option>
                                <option value="bi-graph-up-arrow">æˆé•¿æŠ•èµ„</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">çŠ¶æ€ <span class="text-danger">*</span></label>
                            <select class="form-select" id="strategyStatus" required>
                                <option value="draft">è‰ç¨¿</option>
                                <option value="published">å·²å‘å¸ƒ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç­–ç•¥ç®€ä»‹</label>
                    <textarea class="form-control" id="strategyIntroduction" rows="3"
                              placeholder="è¯·è¾“å…¥ç­–ç•¥ç®€ä»‹ï¼Œå»ºè®®150å­—ä»¥å†…..."></textarea>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">éš¾åº¦</label>
                            <select class="form-select" id="strategyDifficulty">
                                <option value="åˆçº§">åˆçº§</option>
                                <option value="ä¸­çº§">ä¸­çº§</option>
                                <option value="é«˜çº§">é«˜çº§</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">é£é™©ç­‰çº§</label>
                            <select class="form-select" id="strategyRisk">
                                <option value="ä½">ä½</option>
                                <option value="ä¸­">ä¸­</option>
                                <option value="é«˜">é«˜</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">æŒä»“å‘¨æœŸ</label>
                            <select class="form-select" id="strategyHoldingPeriod">
                                <option value="çŸ­æœŸ">çŸ­æœŸ</option>
                                <option value="ä¸­æœŸ">ä¸­æœŸ</option>
                                <option value="é•¿æœŸ">é•¿æœŸ</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">ç­–ç•¥ç‰ˆæœ¬</label>
                            <input type="text" class="form-control" id="strategyVersion" placeholder="ä¾‹å¦‚: v1.0"/>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">é¢„æœŸæ”¶ç›Šç‡ (%)</label>
                            <input type="number" class="form-control" id="strategyExpectedReturn"
                                   placeholder="ä¾‹å¦‚: 15.5" step="0.1"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">æœ€å¤§å›æ’¤ (%)</label>
                            <input type="number" class="form-control" id="strategyMaxDrawdown"
                                   placeholder="ä¾‹å¦‚: 20.5" step="0.1"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">å¤æ™®æ¯”ç‡</label>
                            <input type="number" class="form-control" id="strategySharpeRatio"
                                   placeholder="ä¾‹å¦‚: 1.5" step="0.01"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">èƒœç‡ (%)</label>
                            <input type="number" class="form-control" id="strategyWinRate"
                                   placeholder="ä¾‹å¦‚: 65" step="0.1"/>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">é€‚ç”¨å¸‚åœºæ¡ä»¶ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" class="form-control" id="strategyMarketConditions"
                           placeholder="ä¾‹å¦‚: ç‰›å¸‚,éœ‡è¡å¸‚"/>
                </div>

                <div class="mb-3">
                    <label class="form-label">æ‰€éœ€æŠ€æœ¯æŒ‡æ ‡ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" class="form-control" id="strategyRequiredIndicators"
                           placeholder="ä¾‹å¦‚: MACD,RSI,å¸ƒæ—å¸¦"/>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç­–ç•¥æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" class="form-control" id="strategyTags"
                           placeholder="ä¾‹å¦‚: è¶‹åŠ¿,é‡åŒ–,ä¸­é«˜é£é™©"/>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç­–ç•¥ä»£ç  <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="strategyCode" rows="8"
                              placeholder="è¯·è¾“å…¥ç­–ç•¥çš„Pythonä»£ç ..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç­–ç•¥è¯¦ç»†è¯´æ˜ <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="strategyDetail" rows="8"
                              placeholder="è¯·è¾“å…¥ç­–ç•¥çš„è¯¦ç»†è¯´æ˜ï¼Œæ”¯æŒMarkdown..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç»“æœå›¾ç‰‡URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea class="form-control" id="strategyResultPics" rows="3"
                              placeholder="è¯·è¾“å…¥ç»“æœå›¾ç‰‡URLï¼Œæ¯è¡Œä¸€ä¸ª..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">ç»“æœæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea class="form-control" id="strategyResultText" rows="3"
                              placeholder='ä¾‹å¦‚: {"å¹´åŒ–æ”¶ç›Šç‡": "18.7%", "å¤æ™®æ¯”ç‡": "1.42"}'></textarea>
                </div>
            </div>
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>-->
<!--                <button type="button" class="btn btn-primary" onclick="saveStrategy()">ä¿å­˜</button>-->
<!--            </div>-->
        </div>
    </div>
</div>

<!--<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
<script src="/static/js/jquery.min.js"></script>

<script>
    // å…¨å±€å˜é‡
    let strategies = [];

    function createNewStrategy() {
        window.location.href = "/admin/strategy/new";
    }

    // é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®
    document.addEventListener('DOMContentLoaded', function () {
        loadStrategies();
    });

    // åŠ è½½ç­–ç•¥åˆ—è¡¨
    // åŠ è½½ç­–ç•¥åˆ—è¡¨
    async function loadStrategies() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            window.location.href = "/login?next=/admin/strategy";
            return;
        }

        try {
            const res = await fetch("/admin/api/strategies", {
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            console.log("APIè¿”å›çš„æ•°æ®:", data); // æ·»åŠ è°ƒè¯•æ—¥å¿—
            strategies = data || []; // ç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°æ®ï¼Œè€Œä¸æ˜¯data.items

            renderStrategiesTable();

        } catch (err) {
            console.error("åŠ è½½ç­–ç•¥å¤±è´¥:", err);
            document.getElementById("strategiesTableBody").innerHTML = `
        <tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
    `;
        }
    }

    // æ¸²æŸ“ç­–ç•¥è¡¨æ ¼
    function renderStrategiesTable() {
        const tbody = document.getElementById("strategiesTableBody");
        if (strategies.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <div>æš‚æ— ç­–ç•¥æ•°æ®</div>
                </td>
            </tr>
            `;
            return;
        }

        tbody.innerHTML = strategies.map(strategy => {
            const statusBadge = strategy.publish
                ? '<span class="badge bg-success">å·²å‘å¸ƒ</span>'
                : '<span class="badge bg-secondary">è‰ç¨¿</span>';

            const difficultyBadge = getDifficultyBadge(strategy.difficulty);
            const riskBadge = getRiskBadge(strategy.risk_level);

            const deleteOnclick = strategy.publish ? '' : `deleteStrategy('${strategy.id}', '${escapeHtml(strategy.name)}')`;
            const deleteAttrs = strategy.publish ? 'disabled title="å·²å‘å¸ƒçš„ç­–ç•¥ä¸å¯åˆ é™¤"' : '';

            return `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="strategy-icon">
                        <i class="bi ${strategy.icon || 'bi-graph-up'}"></i>
                    </div>
                    <div>
                        <div class="strategy-name">${escapeHtml(strategy.name)}</div>
                        <div class="strategy-intro">${escapeHtml(strategy.introduction || '-')}</div>
                    </div>
                </div>
            </td>
            <td><span class="badge bg-info">${escapeHtml(strategy.group_name || '-')}</span></td>
            <td>${statusBadge}</td>
            <td>${difficultyBadge}</td>
            <td>${riskBadge}</td>
            <td>${formatDate(strategy.created_at)}</td>
            <td><span class="badge bg-primary">${strategy.view_count || 0} æ¬¡</span></td>
            <td>
                <button class="btn btn-sm btn-outline-info me-1"
                        onclick="viewStrategy('${strategy.id}')">æŸ¥çœ‹</button>
                <button class="btn btn-sm btn-outline-primary me-1"
                        onclick="editStrategy('${strategy.id}')">ç¼–è¾‘</button>
                <button class="btn btn-sm btn-outline-danger ${strategy.publish ? 'disabled' : ''}"
                        onclick="${deleteOnclick}"
                        ${deleteAttrs}>
                    åˆ é™¤
                </button>
            </td>
        </tr>
    `;
        }).join('');
    }

    // è·å–éš¾åº¦å¾½ç« 
    function getDifficultyBadge(difficulty) {
        switch (difficulty) {
            case 'åˆçº§':
                return '<span class="badge bg-success">åˆçº§</span>';
            case 'ä¸­çº§':
                return '<span class="badge bg-warning">ä¸­çº§</span>';
            case 'é«˜çº§':
                return '<span class="badge bg-danger">é«˜çº§</span>';
            default:
                return '<span class="badge bg-secondary">-</span>';
        }
    }

    // è·å–é£é™©ç­‰çº§å¾½ç« 
    function getRiskBadge(risk) {
        switch (risk) {
            case 'ä½':
                return '<span class="badge bg-success">ä½</span>';
            case 'ä¸­':
                return '<span class="badge bg-warning">ä¸­</span>';
            case 'é«˜':
                return '<span class="badge bg-danger">é«˜</span>';
            default:
                return '<span class="badge bg-secondary">-</span>';
        }
    }

    // æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…
    // æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…
    function viewStrategy(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        if (!strategy) return;

        // å¡«å……åŸºæœ¬ä¿¡æ¯
        document.getElementById("detail-name").textContent = strategy.name || '-';
        document.getElementById("detail-group").textContent = strategy.group_name || '-'; // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
        document.getElementById("detail-intro").textContent = strategy.introduction || '-';
        document.getElementById("detail-difficulty").textContent = strategy.difficulty || '-';
        document.getElementById("detail-risk").textContent = strategy.risk_level || '-';
        document.getElementById("detail-period").textContent = strategy.holding_period || '-';

        // å¡«å……æŒ‡æ ‡ä¿¡æ¯
        document.getElementById("detail-return").textContent = strategy.expected_return ? strategy.expected_return + '%' : '-';
        document.getElementById("detail-drawdown").textContent = strategy.max_drawdown ? strategy.max_drawdown + '%' : '-';
        document.getElementById("detail-sharpe").textContent = strategy.sharpe_ratio || '-';
        document.getElementById("detail-winrate").textContent = strategy.win_rate ? strategy.win_rate + '%' : '-';
        document.getElementById("detail-views").textContent = strategy.view_count || '0';
        document.getElementById("detail-likes").textContent = strategy.like_count || '0';

        // å¡«å……æ ‡ç­¾ä¿¡æ¯
        renderTags("detail-conditions", strategy.market_conditions);
        renderTags("detail-indicators", strategy.required_indicators);
        renderTags("detail-tags", strategy.tags);

        // å¡«å……ç»“æœæ•°æ®
        renderResultData("detail-result-data", strategy.result_text);

        // å¡«å……ç»“æœå›¾ç‰‡
        renderResultPics("detail-result-pics", strategy.result_pic);

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        new bootstrap.Modal(document.getElementById("strategyDetailModal")).show();
    }

    // æ¸²æŸ“æ ‡ç­¾
    function renderTags(containerId, tags) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!tags || !Array.isArray(tags) || tags.length === 0) {
            container.innerHTML = '<span class="text-muted">æ— </span>';
            return;
        }

        tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag';
            tagElement.textContent = tag;
            container.appendChild(tagElement);
        });
    }

    // æ¸²æŸ“ç»“æœæ•°æ®
    function renderResultData(containerId, resultData) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!resultData || typeof resultData !== 'object' || Object.keys(resultData).length === 0) {
            container.innerHTML = '<span class="text-muted">æ— </span>';
            return;
        }

        Object.entries(resultData).forEach(([key, value]) => {
            const dataElement = document.createElement('div');
            dataElement.className = 'result-data-item';
            dataElement.innerHTML = `
                <span class="result-data-key">${key}:</span>
                <span class="result-data-value">${value}</span>
            `;
            container.appendChild(dataElement);
        });
    }

    // æ¸²æŸ“ç»“æœå›¾ç‰‡
    function renderResultPics(containerId, pics) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!pics || !Array.isArray(pics) || pics.length === 0) {
            container.innerHTML = '<span class="text-muted">æ— </span>';
            return;
        }

        pics.forEach(pic => {
            const imgElement = document.createElement('img');
            imgElement.src = pic;
            imgElement.alt = 'ç»“æœå›¾ç‰‡';
            imgElement.className = 'img-thumbnail';
            imgElement.style.width = '150px';
            imgElement.style.height = '150px';
            imgElement.style.objectFit = 'cover';
            container.appendChild(imgElement);
        });
    }

    // ç¼–è¾‘ç­–ç•¥
    function editStrategy(strategyId) {
        const strategy = strategies.find(s => s.id === strategyId);
        if (!strategy) return;

        document.getElementById("strategyId").value = strategy.id;
        document.getElementById("strategyName").value = strategy.name || "";
        document.getElementById("strategyGroup").value = strategy.group_name || "";
        document.getElementById("strategyIcon").value = strategy.icon || "";
        document.getElementById("strategyStatus").value = strategy.publish ? "published" : "draft";
        document.getElementById("strategyIntroduction").value = strategy.introduction || "";
        document.getElementById("strategyDifficulty").value = strategy.difficulty || "åˆçº§";
        document.getElementById("strategyRisk").value = strategy.risk_level || "ä½";
        document.getElementById("strategyHoldingPeriod").value = strategy.holding_period || "çŸ­æœŸ";
        document.getElementById("strategyVersion").value = strategy.version || "";
        document.getElementById("strategyExpectedReturn").value = strategy.expected_return || "";
        document.getElementById("strategyMaxDrawdown").value = strategy.max_drawdown || "";
        document.getElementById("strategySharpeRatio").value = strategy.sharpe_ratio || "";
        document.getElementById("strategyWinRate").value = strategy.win_rate || "";
        document.getElementById("strategyMarketConditions").value =
            (strategy.market_conditions && Array.isArray(strategy.market_conditions))
                ? strategy.market_conditions.join(', ') : "";
        document.getElementById("strategyRequiredIndicators").value =
            (strategy.required_indicators && Array.isArray(strategy.required_indicators))
                ? strategy.required_indicators.join(', ') : "";
        document.getElementById("strategyTags").value =
            (strategy.tags && Array.isArray(strategy.tags))
                ? strategy.tags.join(', ') : "";
        document.getElementById("strategyCode").value = strategy.code || "";
        document.getElementById("strategyDetail").value = strategy.detail || "";
        document.getElementById("strategyResultPics").value =
            (strategy.result_pic && Array.isArray(strategy.result_pic))
                ? strategy.result_pic.join('\n') : "";
        document.getElementById("strategyResultText").value =
            (strategy.result_text && typeof strategy.result_text === 'object')
                ? JSON.stringify(strategy.result_text, null, 2) : "";

        document.getElementById("strategyModalLabel").textContent = "ç¼–è¾‘ç­–ç•¥";
        new bootstrap.Modal(document.getElementById("strategyModal")).show();
    }

    // ä¿å­˜ç­–ç•¥ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
    async function saveStrategy() {
        const token = localStorage.getItem("access_token");
        const strategyId = document.getElementById("strategyId").value;

        // æ”¶é›†è¡¨å•æ•°æ®
        const name = document.getElementById("strategyName").value.trim();
        const group_name = document.getElementById("strategyGroup").value.trim();
        const icon = document.getElementById("strategyIcon").value.trim();
        const status = document.getElementById("strategyStatus").value;
        const introduction = document.getElementById("strategyIntroduction").value.trim();
        const difficulty = document.getElementById("strategyDifficulty").value;
        const risk_level = document.getElementById("strategyRisk").value;
        const holding_period = document.getElementById("strategyHoldingPeriod").value;
        const version = document.getElementById("strategyVersion").value.trim();
        const expected_return = parseFloat(document.getElementById("strategyExpectedReturn").value) || 0;
        const max_drawdown = parseFloat(document.getElementById("strategyMaxDrawdown").value) || 0;
        const sharpe_ratio = parseFloat(document.getElementById("strategySharpeRatio").value) || 0;
        const win_rate = parseFloat(document.getElementById("strategyWinRate").value) || 0;

        const marketConditionsInput = document.getElementById("strategyMarketConditions").value.trim();
        const market_conditions = marketConditionsInput ? marketConditionsInput.split(',').map(c => c.trim()).filter(c => c) : [];

        const indicatorsInput = document.getElementById("strategyRequiredIndicators").value.trim();
        const required_indicators = indicatorsInput ? indicatorsInput.split(',').map(i => i.trim()).filter(i => i) : [];

        const tagsInput = document.getElementById("strategyTags").value.trim();
        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

        const code = document.getElementById("strategyCode").value.trim();
        const detail = document.getElementById("strategyDetail").value.trim();

        const picsInput = document.getElementById("strategyResultPics").value.trim();
        const result_pic = picsInput ? picsInput.split('\n').map(p => p.trim()).filter(p => p) : [];

        let result_text = {};
        try {
            const resultTextInput = document.getElementById("strategyResultText").value.trim();
            if (resultTextInput) {
                result_text = JSON.parse(resultTextInput);
            }
        } catch (e) {
            alert("ç»“æœæ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ ¼å¼");
            return;
        }

        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!name || !group_name || !code || !detail) {
            alert("ç­–ç•¥åç§°ã€ç»„åˆ«ã€ä»£ç å’Œè¯¦ç»†è¯´æ˜ä¸èƒ½ä¸ºç©º");
            return;
        }

        try {
            let url = "/admin/api/strategy";
            let method = "POST";
            let body = {
                name, group_name, icon, introduction, difficulty, risk_level,
                holding_period, version, expected_return, max_drawdown, sharpe_ratio,
                win_rate, market_conditions, required_indicators, tags, code, detail,
                result_pic, result_text, publish: status === 'published'
            };

            if (strategyId) {
                url += `/${strategyId}`;
                method = "PUT";
            }

            const res = await fetch(url, {
                method,
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.detail || `HTTP ${res.status}`);
            }

            alert(strategyId ? "ç­–ç•¥æ›´æ–°æˆåŠŸ" : "ç­–ç•¥åˆ›å»ºæˆåŠŸ");
            bootstrap.Modal.getInstance(document.getElementById("strategyModal")).hide();
            loadStrategies(); // åˆ·æ–°åˆ—è¡¨
        } catch (err) {
            console.error("ä¿å­˜ç­–ç•¥å¤±è´¥:", err);
            alert("æ“ä½œå¤±è´¥ï¼š" + err.message);
        }
    }

    // åˆ é™¤ç­–ç•¥
    async function deleteStrategy(strategyId, strategyName) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ç­–ç•¥ã€Œ${strategyName}ã€å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }

        const token = localStorage.getItem("access_token");

        try {
            const res = await fetch(`/admin/api/strategy/${strategyId}`, {
                method: 'DELETE',
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.detail || `HTTP ${res.status}`);
            }

            alert("ç­–ç•¥åˆ é™¤æˆåŠŸ");
            loadStrategies();
        } catch (err) {
            console.error(err);
            alert("åˆ é™¤å¤±è´¥ï¼š" + err.message);
        }
    }

    // å·¥å…·å‡½æ•°
    function formatDate(dateStr) {
        if (!dateStr) return '';

        // å¤„ç†ISOæ ¼å¼æ—¥æœŸå­—ç¬¦ä¸²
        let date;
        try {
            date = new Date(dateStr);
        } catch (e) {
            console.error("æ—¥æœŸæ ¼å¼é”™è¯¯:", e);
            return '';
        }

        if (isNaN(date)) return '';

        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(/\//g, '-');
    }
</script>