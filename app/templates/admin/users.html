<!-- users.html -->
<div class="container-fluid">
    <h2 class="mb-4">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>

    <!-- æ“ä½œåŒºï¼šæœç´¢ + ç­›é€‰ + æ–°å¢ + å¯¼å‡º -->
    <div class="row mb-3 g-2 align-items-end">
        <!-- æœç´¢æ¡† -->
        <div class="col-md-3">
            <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å/é‚®ç®±"/>
        </div>
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="active">å·²å¯ç”¨</option>
                <option value="disabled">å·²ç¦ç”¨</option>
            </select>
        </div>
        <!-- è§’è‰²ç­›é€‰ -->
        <div class="col-md-2">
            <select class="form-select" id="roleFilter">
                <option value="">æ‰€æœ‰è§’è‰²</option>
                <option value="user">æ™®é€šç”¨æˆ·</option>
                <option value="vip">VIPç”¨æˆ·</option>
                <option value="editor">ç¼–è¾‘</option>
            </select>
        </div>
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="col-md-5 text-end">
            <button class="btn btn-success me-2" onclick="window.UserManager.openCreateUserModal()">
                â• æ–°å¢ç”¨æˆ·
            </button>
            <button class="btn btn-outline-secondary me-2" onclick="window.UserManager.exportUsers()">
                ğŸ“¥ å¯¼å‡º Excel
            </button>
            <button class="btn btn-outline-primary" onclick="window.UserManager.applyFilter()">
                        ğŸ” æŸ¥è¯¢
                    </button>
        </div>
    </div>

    <!-- ç”¨æˆ·è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"/>
                        </th>
                        <th>ID</th>
                        <th>ç”¨æˆ·å</th>
                        <th>é‚®ç®±</th>
                        <th>è§’è‰²</th>
                        <th>çŠ¶æ€</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æœ€åç™»å½•</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <tr>
                        <td colspan="9" class="text-center py-4">åŠ è½½ä¸­...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <span id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 10 é¡µ</span>
        </div>
        <nav>
            <ul class="pagination mb-0" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </nav>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">æ–°å¢ç”¨æˆ·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId"/>
                <div class="mb-3">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="username" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" class="form-control" id="email" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">è§’è‰²</label>
                    <select class="form-select" id="role">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="vip">VIPç”¨æˆ·</option>
                        <option value="editor">ç¼–è¾‘</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                    <input type="password" class="form-control" id="password" placeholder="******"/>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="status" checked/>
                    <label class="form-check-label" for="status">å¯ç”¨è´¦æˆ·</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="window.UserManager.saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // æ—©æœŸåˆå§‹åŒ– - ç¡®ä¿UserManagerç«‹å³å¯ç”¨
    (function() {
        // åˆ›å»ºåŸºç¡€ç”¨æˆ·ç®¡ç†å™¨å¯¹è±¡
        window.UserManager = {
            isInitialized: false,
            initCallbacks: [],
            
            // æ·»åŠ åˆå§‹åŒ–å›è°ƒ
            onInit: function(callback) {
                if (this.isInitialized) {
                    callback();
                } else {
                    this.initCallbacks.push(callback);
                }
            },
            
            // è§¦å‘åˆå§‹åŒ–å›è°ƒ
            triggerInit: function() {
                this.isInitialized = true;
                this.initCallbacks.forEach(callback => callback());
                this.initCallbacks = [];
            }
        };
        
        // åˆ›å»ºå…¼å®¹çš„loadUserså‡½æ•°
        window.loadUsers = function(page = 1) {
            if (window.UserManager && window.UserManager.loadUsers) {
                return window.UserManager.loadUsers(page);
            } else {
                console.warn('UserManager not fully initialized yet, page:', page);
                // å»¶è¿Ÿé‡è¯•
                setTimeout(() => {
                    if (window.UserManager && window.UserManager.loadUsers) {
                        window.UserManager.loadUsers(page);
                    }
                }, 100);
            }
        };
        
        console.log('Early UserManager and loadUsers setup complete');
    })();
</script>

<script>
    // å®Œæ•´çš„ç”¨æˆ·ç®¡ç†å™¨å®ç°
    // æ‰©å±•ä¹‹å‰åˆ›å»ºçš„åŸºç¡€UserManagerå¯¹è±¡
    Object.assign(window.UserManager, {
        currentPage: 1,
        totalPages: 1,
        users: [],
        
        // åˆå§‹åŒ–å‡½æ•°
        init: function() {
            if (this.isInitialized) return;
            this.isInitialized = true;
            console.log('UserManager initialized');
            
            // è®¾ç½®é¡µé¢ç›‘å¬å™¨
            this.setupPageListener();
            
            // å¦‚æœé¡µé¢å½“å‰å¯è§ï¼Œç«‹å³åŠ è½½æ•°æ®
            this.checkAndLoadData();
        },
        
        // æ£€æŸ¥é¡µé¢æ˜¯å¦å¯è§å¹¶åŠ è½½æ•°æ®
        checkAndLoadData: function() {
            const usersDiv = document.getElementById('users');
            if (usersDiv && !usersDiv.classList.contains('d-none')) {
                console.log("ç”¨æˆ·é¡µé¢å·²æ¿€æ´»ï¼Œå¼€å§‹åŠ è½½æ•°æ®");
                this.loadUsers();
            }
        },
        
        // è®¾ç½®é¡µé¢ç›‘å¬å™¨
        setupPageListener: function() {
            const usersDiv = document.getElementById('users');
            if (!usersDiv) return;
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!usersDiv.classList.contains('d-none')) {
                            // é¡µé¢å˜ä¸ºå¯è§ï¼Œå»¶è¿ŸåŠ è½½æ•°æ®
                            console.log("æ£€æµ‹åˆ°ç”¨æˆ·é¡µé¢åˆ‡æ¢ï¼Œå‡†å¤‡åŠ è½½æ•°æ®");
                            setTimeout(() => this.loadUsers(), 100);
                        }
                    }
                });
            });
            
            observer.observe(usersDiv, {attributes: true});
        },

        // åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆå¸¦åˆ†é¡µã€ç­›é€‰ï¼‰
        loadUsers: async function(page = 1) {
            const token = localStorage.getItem("access_token");
            if (!token) {
                alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                window.location.href = "/login?next=/admin/";
                return;
            }

            // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            const searchInput = document.getElementById("searchInput");
            const statusFilter = document.getElementById("statusFilter");
            const roleFilter = document.getElementById("roleFilter");
            const usersTableBody = document.getElementById("usersTableBody");
            
            if (!searchInput || !statusFilter || !roleFilter || !usersTableBody) {
                console.error("ç”¨æˆ·ç®¡ç†é¡µé¢DOMå…ƒç´ æœªå®Œå…¨åŠ è½½ï¼Œç¨åé‡è¯•");
                setTimeout(() => this.loadUsers(page), 500);
                return;
            }

            const search = searchInput.value.trim();
            const status = statusFilter.value;
            const role = roleFilter.value;

            try {
                const params = new URLSearchParams({
                    page: page,
                    page_size: 10,
                    ...(search && {search}),
                    ...(status && {status}),
                    ...(role && {role})
                });

                const res = await fetch(`/admin/api/user-management?${params.toString()}`, {
                    headers: {"Authorization": "Bearer " + token}
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                this.users = data.items || [];
                this.currentPage = data.page || 1;
                this.totalPages = data.total_pages || 1;

                console.log("ç”¨æˆ·åˆ—è¡¨:", this.users); // æ·»åŠ è°ƒè¯•æ—¥å¿—

                this.renderUsersTable();
                this.renderPagination();
                this.updatePageInfo();

            } catch (err) {
                console.error("åŠ è½½ç”¨æˆ·å¤±è´¥:", err);
                if (usersTableBody) {
                    usersTableBody.innerHTML = `
                    <tr><td colspan="9" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
                `;
                }
            }
        },

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        renderUsersTable: function() {
            console.log("å¼€å§‹æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼ï¼Œç”¨æˆ·æ•°é‡:", this.users.length); // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log("ç”¨æˆ·æ•°æ®è¯¦æƒ…:", this.users); // æ·»åŠ è¯¦ç»†æ•°æ®æ—¥å¿—
            
            const tbody = document.getElementById("usersTableBody");
            if (!tbody) {
                console.error("æ‰¾ä¸åˆ°usersTableBodyå…ƒç´ ");
                return;
            }
            
            if (this.users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>`;
                return;
            }

            try {
                tbody.innerHTML = this.users.map(user => {
                    // å…¼å®¹ä¸åŒçš„çŠ¶æ€å­—æ®µå
                    const status = user.status || (user.is_active ? 'active' : 'disabled');
                    
                    console.log("æ¸²æŸ“ç”¨æˆ·:", user.username, "çŠ¶æ€:", status, "ID:", user.id); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    
                    return `
        <tr>
            <td><input type="checkbox" class="user-checkbox" value="${user.id}" /></td>
            <td>${user.id}</td>
            <td>${this.escapeHtml(user.username)}</td>
            <td>${this.escapeHtml(user.email)}</td>
            <td><span class="badge bg-secondary">${user.role}</span></td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           ${status === 'active' ? 'checked' : ''}
                           onchange="window.UserManager.toggleUserStatus(${user.id}, this)" />
                </div>
            </td>
            <td>${this.formatDate(user.created_at)}</td>
            <td>${user.last_login ? this.formatDate(user.last_login) : 'ä»æœªç™»å½•'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1"
                        onclick="window.UserManager.editUser(${user.id})">ç¼–è¾‘</button>
                <button class="btn btn-sm btn-outline-danger"
                        onclick="window.UserManager.deleteUser(${user.id})">åˆ é™¤</button>
            </td>
        </tr>
    `;
                }).join('');
                
                console.log("ç”¨æˆ·åˆ—è¡¨æ¸²æŸ“æˆåŠŸï¼Œå…±", this.users.length, "ä¸ªç”¨æˆ·"); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                console.log("è¡¨æ ¼HTMLå†…å®¹:", tbody.innerHTML); // æ·»åŠ è¡¨æ ¼å†…å®¹æ—¥å¿—
            } catch (error) {
                console.error("æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼æ—¶å‡ºé”™:", error);
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">æ¸²æŸ“å¤±è´¥: ${error.message}</td></tr>`;
            }
        },

        // æ¸²æŸ“åˆ†é¡µ
        renderPagination: function() {
            const pagination = document.getElementById("pagination");
            if (!pagination) {
                console.error("æ‰¾ä¸åˆ°paginationå…ƒç´ ");
                return;
            }
            
            pagination.innerHTML = '';

            // ä¸Šä¸€é¡µ
            const prevItem = document.createElement("li");
            prevItem.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
            prevItem.innerHTML = `<a class="page-link" href="#">Â«</a>`;
            prevItem.onclick = (e) => {
                e.preventDefault();
                if (this.currentPage > 1) this.loadUsers(this.currentPage - 1);
            };
            pagination.appendChild(prevItem);

            // é¡µç ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
            const startPage = Math.max(1, this.currentPage - 2);
            const endPage = Math.min(this.totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const item = document.createElement("li");
                item.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
                item.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                item.onclick = (e) => {
                    e.preventDefault();
                    this.loadUsers(i);
                };
                pagination.appendChild(item);
            }

            // ä¸‹ä¸€é¡µ
            const nextItem = document.createElement("li");
            nextItem.className = `page-item ${this.currentPage === this.totalPages ? 'disabled' : ''}`;
            nextItem.innerHTML = `<a class="page-link" href="#">Â»</a>`;
            nextItem.onclick = (e) => {
                e.preventDefault();
                if (this.currentPage < this.totalPages) this.loadUsers(this.currentPage + 1);
            };
            pagination.appendChild(nextItem);
        },

        // æ›´æ–°é¡µç ä¿¡æ¯
        updatePageInfo: function() {
            const pageInfo = document.getElementById("pageInfo");
            if (!pageInfo) {
                console.error("æ‰¾ä¸åˆ°pageInfoå…ƒç´ ");
                return;
            }
            pageInfo.textContent = `ç¬¬ ${this.currentPage} é¡µï¼Œå…± ${this.totalPages} é¡µ`;
        },

        // åº”ç”¨ç­›é€‰
        applyFilter: function() {
            this.loadUsers(1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        },

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        toggleSelectAll: function(checkbox) {
            document.querySelectorAll('.user-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        },

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        toggleUserStatus: async function(userId, checkbox) {
            const token = localStorage.getItem("access_token");
            const newStatus = checkbox.checked;

            try {
                const res = await fetch(`/admin/api/user-management/${userId}/status`, {
                    method: 'PATCH',
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({is_active: newStatus})
                });

                if (!res.ok) throw new Error("æ›´æ–°çŠ¶æ€å¤±è´¥");

                alert(`ç”¨æˆ·çŠ¶æ€å·²${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            } catch (err) {
                console.error(err);
                checkbox.checked = !checkbox.checked; // å›æ»š
                alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        },

        // ç¼–è¾‘ç”¨æˆ·
        editUser: function(userId) {
            const user = this.users.find(u => u.id === userId);
            if (!user) return;

            // å…¼å®¹ä¸åŒçš„çŠ¶æ€å­—æ®µå
            const status = user.status || (user.is_active ? 'active' : 'disabled');

            document.getElementById("userId").value = user.id;
            document.getElementById("username").value = user.username;
            document.getElementById("email").value = user.email;
            document.getElementById("role").value = user.role;
            document.getElementById("password").value = ""; // å¯†ç ç•™ç©º
            document.getElementById("status").checked = status === 'active';

            document.getElementById("userModalLabel").textContent = "ç¼–è¾‘ç”¨æˆ·";
            new bootstrap.Modal(document.getElementById("userModal")).show();
        },

        // æ‰“å¼€æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡†
        openCreateUserModal: function() {
            document.getElementById("userId").value = "";
            document.getElementById("username").value = "";
            document.getElementById("email").value = "";
            document.getElementById("role").value = "user";
            document.getElementById("password").value = "";
            document.getElementById("status").checked = true;

            document.getElementById("userModalLabel").textContent = "æ–°å¢ç”¨æˆ·";
            new bootstrap.Modal(document.getElementById("userModal")).show();
        },

        // ä¿å­˜ç”¨æˆ·ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        saveUser: async function() {
            const token = localStorage.getItem("access_token");
            const userId = document.getElementById("userId").value;
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const role = document.getElementById("role").value;
            const password = document.getElementById("password").value;
            const isActive = document.getElementById("status").checked;

            if (!username || !email) {
                alert("ç”¨æˆ·åå’Œé‚®ç®±ä¸èƒ½ä¸ºç©º");
                return;
            }

            try {
                let url = "/admin/api/user-management";
                let method = "POST";
                let body = {username, email, role, is_active: isActive};

                if (password) body.password = password;
                if (userId) {
                    url += `/${userId}`;
                    method = "PUT";
                }

                const res = await fetch(url, {
                    method,
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                alert(userId ? "ç”¨æˆ·æ›´æ–°æˆåŠŸ" : "ç”¨æˆ·åˆ›å»ºæˆåŠŸ");
                bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
                this.loadUsers(this.currentPage); // åˆ·æ–°å½“å‰é¡µ
            } catch (err) {
                console.error("ä¿å­˜ç”¨æˆ·å¤±è´¥:", err);
                alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–é‡è¯•");
            }
        },

        // åˆ é™¤ç”¨æˆ·
        deleteUser: async function(userId) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;

            const token = localStorage.getItem("access_token");

            try {
                const res = await fetch(`/admin/api/user-management/${userId}`, {
                    method: 'DELETE',
                    headers: {"Authorization": "Bearer " + token}
                });

                if (!res.ok) throw new Error("åˆ é™¤å¤±è´¥");

                alert("ç”¨æˆ·åˆ é™¤æˆåŠŸ");
                this.loadUsers(this.currentPage);
            } catch (err) {
                console.error(err);
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        },

        // å¯¼å‡ºç”¨æˆ·
        exportUsers: function() {
            const token = localStorage.getItem("access_token");
            const search = document.getElementById("searchInput").value.trim();
            const status = document.getElementById("statusFilter").value;
            const role = document.getElementById("roleFilter").value;

            const params = new URLSearchParams({
                ...(search && {search}),
                ...(status && {status}),
                ...(role && {role}),
                export: 'excel'
            });

            window.open(`/admin/api/user-management/export?${params.toString()}`, '_blank');
        },

        // å·¥å…·å‡½æ•°
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        formatDate: function(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '-');
        }
    });
    
    // åˆå§‹åŒ–UserManager
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing UserManager');
        window.UserManager.init();
    });
</script>