<!-- roles.html -->
<div class="container-fluid">
    <h2 class="mb-4">ğŸ›¡ï¸ è§’è‰²ç®¡ç†</h2>

    <!-- æ“ä½œåŒº -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-success" onclick="openCreateRoleModal()">
                â• æ–°å¢è§’è‰²
            </button>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">ğŸ’¡ ç®¡ç†å‘˜è§’è‰²ä¸å¯åˆ é™¤</small>
        </div>
    </div>

    <!-- è§’è‰²è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>è§’è‰²åç§°</th>
                            <th>æè¿°</th>
                            <th>æƒé™æ•°é‡</th>
                            <th>ä½¿ç”¨ç”¨æˆ·æ•°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rolesTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-4">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘è§’è‰²æ¨¡æ€æ¡† -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleModalLabel">æ–°å¢è§’è‰²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="roleId" />
                <div class="mb-3">
                    <label class="form-label">è§’è‰²åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="roleName" placeholder="å¦‚ï¼šå†…å®¹ç¼–è¾‘" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">è§’è‰²æè¿°</label>
                    <textarea class="form-control" id="roleDescription" rows="2" placeholder="æè¿°æ­¤è§’è‰²çš„ç”¨é€”"></textarea>
                </div>

                <hr />
                <h6>åˆ†é…æƒé™</h6>
                <small class="text-muted">å‹¾é€‰è¯¥è§’è‰²æ‹¥æœ‰çš„æƒé™</small>

                <!-- æƒé™åˆ†ç»„ -->
                <div class="accordion" id="permissionsAccordion">
                    <!-- ç”¨æˆ·ç®¡ç† -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUser">
                                ğŸ‘¥ ç”¨æˆ·ç®¡ç†
                            </button>
                        </h2>
                        <div id="collapseUser" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="user_view" id="perm_user_view" />
                                    <label class="form-check-label" for="perm_user_view">æŸ¥çœ‹ç”¨æˆ·</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="user_edit" id="perm_user_edit" />
                                    <label class="form-check-label" for="perm_user_edit">ç¼–è¾‘ç”¨æˆ·</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="user_delete" id="perm_user_delete" />
                                    <label class="form-check-label" for="perm_user_delete">åˆ é™¤ç”¨æˆ·</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="user_create" id="perm_user_create" />
                                    <label class="form-check-label" for="perm_user_create">åˆ›å»ºç”¨æˆ·</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ç« ç®¡ç† -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseArticle">
                                ğŸ“„ æ–‡ç« ç®¡ç†
                            </button>
                        </h2>
                        <div id="collapseArticle" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="article_view" id="perm_article_view" />
                                    <label class="form-check-label" for="perm_article_view">æŸ¥çœ‹æ–‡ç« </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="article_edit" id="perm_article_edit" />
                                    <label class="form-check-label" for="perm_article_edit">ç¼–è¾‘æ–‡ç« </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="article_delete" id="perm_article_delete" />
                                    <label class="form-check-label" for="perm_article_delete">åˆ é™¤æ–‡ç« </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="article_create" id="perm_article_create" />
                                    <label class="form-check-label" for="perm_article_create">åˆ›å»ºæ–‡ç« </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="article_publish" id="perm_article_publish" />
                                    <label class="form-check-label" for="perm_article_publish">å‘å¸ƒæ–‡ç« </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿè®¾ç½® -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystem">
                                âš™ï¸ ç³»ç»Ÿè®¾ç½®
                            </button>
                        </h2>
                        <div id="collapseSystem" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="system_config" id="perm_system_config" />
                                    <label class="form-check-label" for="perm_system_config">ç³»ç»Ÿé…ç½®</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="role_manage" id="perm_role_manage" />
                                    <label class="form-check-label" for="perm_role_manage">è§’è‰²ç®¡ç†</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input permission-checkbox" type="checkbox" value="log_view" id="perm_log_view" />
                                    <label class="form-check-label" for="perm_log_view">æŸ¥çœ‹æ—¥å¿—</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…¨é€‰/åé€‰ -->
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllPermissions(true)">
                        å…¨é€‰
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllPermissions(false)">
                        åé€‰
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveRole()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let roles = [];

// é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('roles').classList.contains('d-none') === false) {
        loadRoles();
    }
});

// ç›‘å¬å¯¼èˆªåˆ‡æ¢
const rolesObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const rolesDiv = document.getElementById('roles');
            if (rolesDiv && !rolesDiv.classList.contains('d-none')) {
                loadRoles();
            }
        }
    });
});
rolesObserver.observe(document.getElementById('roles'), { attributes: true });

// åŠ è½½è§’è‰²åˆ—è¡¨
async function loadRoles() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        window.location.href = "/login?next=/admin/";
        return;
    }

    try {
        const res = await fetch("/admin/api/roles", {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        roles = data.items || [];

        renderRolesTable();

    } catch (err) {
        console.error("åŠ è½½è§’è‰²å¤±è´¥:", err);
        document.getElementById("rolesTableBody").innerHTML = `
            <tr><td colspan="6" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
        `;
    }
}

// æ¸²æŸ“è§’è‰²è¡¨æ ¼
function renderRolesTable() {
    const tbody = document.getElementById("rolesTableBody");
    if (roles.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">æš‚æ— è§’è‰²æ•°æ®</td></tr>`;
        return;
    }

    tbody.innerHTML = roles.map(role => `
        <tr>
            <td><strong>${escapeHtml(role.name)}</strong></td>
            <td>${escapeHtml(role.description || '-')}</td>
            <td><span class="badge bg-primary">${role.permissions.length} é¡¹</span></td>
            <td><span class="badge bg-info">${role.user_count} äºº</span></td>
            <td>${formatDate(role.created_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1"
                        onclick="editRole(${role.id})">ç¼–è¾‘</button>
                <button class="btn btn-sm btn-outline-danger ${role.name === 'ç®¡ç†å‘˜' ? 'disabled' : ''}"
                        onclick="${role.name === 'ç®¡ç†å‘˜' ? '' : `deleteRole(${role.id}, '${escapeHtml(role.name)}')`}"
                        ${role.name === 'ç®¡ç†å‘˜' ? 'disabled title="ç®¡ç†å‘˜è§’è‰²ä¸å¯åˆ é™¤"' : ''}>
                    åˆ é™¤
                </button>
            </td>
        </tr>
    `).join('');
}

// æ‰“å¼€æ–°å¢è§’è‰²æ¨¡æ€æ¡†
function openCreateRoleModal() {
    document.getElementById("roleId").value = "";
    document.getElementById("roleName").value = "";
    document.getElementById("roleDescription").value = "";

    // æ¸…ç©ºæ‰€æœ‰æƒé™é€‰æ‹©
    document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);

    document.getElementById("roleModalLabel").textContent = "æ–°å¢è§’è‰²";
    new bootstrap.Modal(document.getElementById("roleModal")).show();
}

// ç¼–è¾‘è§’è‰²
function editRole(roleId) {
    const role = roles.find(r => r.id === roleId);
    if (!role) return;

    document.getElementById("roleId").value = role.id;
    document.getElementById("roleName").value = role.name;
    document.getElementById("roleDescription").value = role.description || "";

    // è®¾ç½®æƒé™
    const permissionSet = new Set(role.permissions);
    document.querySelectorAll('.permission-checkbox').forEach(cb => {
        cb.checked = permissionSet.has(cb.value);
    });

    document.getElementById("roleModalLabel").textContent = "ç¼–è¾‘è§’è‰²";
    new bootstrap.Modal(document.getElementById("roleModal")).show();
}

// ä¿å­˜è§’è‰²ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
async function saveRole() {
    const token = localStorage.getItem("access_token");
    const roleId = document.getElementById("roleId").value;
    const name = document.getElementById("roleName").value.trim();
    const description = document.getElementById("roleDescription").value.trim();

    if (!name) {
        alert("è§’è‰²åç§°ä¸èƒ½ä¸ºç©º");
        return;
    }

    // è·å–é€‰ä¸­çš„æƒé™
    const permissions = Array.from(document.querySelectorAll('.permission-checkbox:checked'))
        .map(cb => cb.value);

    try {
        let url = "/admin/api/roles";
        let method = "POST";
        let body = { name, description, permissions };

        if (roleId) {
            url += `/${roleId}`;
            method = "PUT";
        }

        const res = await fetch(url, {
            method,
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.detail || `HTTP ${res.status}`);
        }

        alert(roleId ? "è§’è‰²æ›´æ–°æˆåŠŸ" : "è§’è‰²åˆ›å»ºæˆåŠŸ");
        bootstrap.Modal.getInstance(document.getElementById("roleModal")).hide();
        loadRoles(); // åˆ·æ–°åˆ—è¡¨
    } catch (err) {
        console.error("ä¿å­˜è§’è‰²å¤±è´¥:", err);
        alert("æ“ä½œå¤±è´¥ï¼š" + err.message);
    }
}

// åˆ é™¤è§’è‰²
async function deleteRole(roleId, roleName) {
    if (roleName === "ç®¡ç†å‘˜") {
        alert("ç®¡ç†å‘˜è§’è‰²ä¸å¯åˆ é™¤");
        return;
    }

    if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²ã€Œ${roleName}ã€å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œä¸”ä¼šå½±å“ ${roles.find(r => r.id === roleId)?.user_count || 0} åç”¨æˆ·ï¼`)) {
        return;
    }

    const token = localStorage.getItem("access_token");

    try {
        const res = await fetch(`/admin/api/roles/${roleId}`, {
            method: 'DELETE',
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.detail || `HTTP ${res.status}`);
        }

        alert("è§’è‰²åˆ é™¤æˆåŠŸ");
        loadRoles();
    } catch (err) {
        console.error(err);
        alert("åˆ é™¤å¤±è´¥ï¼š" + err.message);
    }
}

// å…¨é€‰/åé€‰æƒé™
function selectAllPermissions(selectAll) {
    document.querySelectorAll('.permission-checkbox').forEach(cb => {
        cb.checked = selectAll;
    });
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(/\//g, '-');
}
</script>