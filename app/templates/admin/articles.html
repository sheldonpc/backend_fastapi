<div class="container-fluid">
    <h2 class="mb-4">ğŸ“„ æ–‡ç« ç®¡ç†</h2>

    <!-- æ“ä½œåŒº -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-success" onclick="createNewArticle()">
                â• æ–°å¢æ–‡ç« 
            </button>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">ğŸ’¡ å‘å¸ƒä¸­çš„æ–‡ç« ä¸å¯åˆ é™¤</small>
        </div>
    </div>

    <!-- æ–‡ç« è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>æ–‡ç« æ ‡é¢˜</th>
                        <th>ä½œè€…</th>
                        <th>çŠ¶æ€</th>
                        <th>åˆ†ç±»</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æµè§ˆé‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="articlesTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">åŠ è½½ä¸­...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘æ–‡ç« æ¨¡æ€æ¡† -->
<div class="modal fade" id="articleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="articleModalLabel">æ–°å¢æ–‡ç« </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="articleId"/>
                <div class="mb-3">
                    <label class="form-label">æ–‡ç« æ ‡é¢˜ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="articleTitle" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">ä½œè€… <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="articleAuthor" placeholder="è¯·è¾“å…¥ä½œè€…å§“å" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">åˆ†ç±» <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="articleCategory" placeholder="å¦‚ï¼šæŠ€æœ¯åˆ†äº«" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">çŠ¶æ€ <span class="text-danger">*</span></label>
                    <select class="form-select" id="articleStatus" required>
                        <option value="draft">è‰ç¨¿</option>
                        <option value="published">å·²å‘å¸ƒ</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" class="form-control" id="articleTags" placeholder="å¦‚ï¼šå‰ç«¯,JavaScript"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">æ–‡ç« å†…å®¹ <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="articleContent" rows="10"
                              placeholder="è¯·è¾“å…¥æ–‡ç« æ­£æ–‡ï¼Œæ”¯æŒMarkdown" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveArticle()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="/static/css/bootstrap.css">
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
    // æ–‡ç« ç®¡ç†å™¨å¯¹è±¡
    window.ArticleManager = {
        isInitialized: false,
        articles: [],
    
        // åˆå§‹åŒ–æ–‡ç« ç®¡ç†å™¨
        init: function() {
            if (this.isInitialized) return;
            
            console.log('åˆå§‹åŒ–æ–‡ç« ç®¡ç†å™¨...');
            this.isInitialized = true;
            
            // å¦‚æœé¡µé¢å½“å‰å¯è§ï¼Œç«‹å³åŠ è½½æ•°æ®
            if (this.isPageVisible()) {
                this.loadArticles();
            }
        },
    
        // æ£€æŸ¥æ–‡ç« é¡µé¢æ˜¯å¦å¯è§
        isPageVisible: function() {
            const articlesDiv = document.getElementById('articles');
            return articlesDiv && !articlesDiv.classList.contains('d-none');
        },
    
        // åŠ è½½æ–‡ç« åˆ—è¡¨
        loadArticles: async function() {
            const token = localStorage.getItem("access_token");
            if (!token) {
                alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                window.location.href = "/login?next=/admin/";
                return;
            }
    
            try {
                const res = await fetch("/admin/api/articles/", {
                    headers: {"Authorization": "Bearer " + token}
                });
    
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
                const data = await res.json();
                this.articles = data.items || [];
    
                this.renderArticlesTable();
    
            } catch (err) {
                console.error("åŠ è½½æ–‡ç« å¤±è´¥:", err);
                document.getElementById("articlesTableBody").innerHTML = `
                <tr><td colspan="7" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
            `;
            }
        },
    
        // æ¸²æŸ“æ–‡ç« è¡¨æ ¼
        renderArticlesTable: function() {
            const tbody = document.getElementById("articlesTableBody");
            if (this.articles.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">æš‚æ— æ–‡ç« æ•°æ®</td></tr>`;
                return;
            }
    
            tbody.innerHTML = this.articles.map(article => {
                const statusBadge = article.status === 'published'
                    ? '<span class="badge bg-success">å·²å‘å¸ƒ</span>'
                    : '<span class="badge bg-secondary">è‰ç¨¿</span>';
                const deleteOnclick = article.status === 'published' ? '' : `ArticleManager.deleteArticle('${article.id}', '${escapeHtml(article.title)}')`;
                const deleteAttrs = article.status === 'published' ? 'disabled title="å‘å¸ƒä¸­çš„æ–‡ç« ä¸å¯åˆ é™¤"' : '';
                return `
            <tr>
                <td><strong>${escapeHtml(article.title)}</strong></td>
                <td>${escapeHtml(article.author || '-')}</td>
                <td>${statusBadge}</td>
                <td><span class="badge bg-info">${escapeHtml(article.category || '-')}</span></td>
                <td>${formatDate(article.created_at)}</td>
                <td><span class="badge bg-primary">${article.views || 0} æ¬¡</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1"
                            onclick="ArticleManager.editArticle('${article.id}')">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-outline-danger ${article.status === 'published' ? 'disabled' : ''}"
                            onclick="${deleteOnclick}"
                            ${deleteAttrs}>
                        åˆ é™¤
                    </button>
                </td>
            </tr>
        `;
            }).join('');
        },
    
        // ç¼–è¾‘æ–‡ç« 
        editArticle: function(articleId) {
            const article = this.articles.find(a => a.id === articleId);
            if (!article) return;
    
            document.getElementById("articleId").value = article.id;
            document.getElementById("articleTitle").value = article.title;
            document.getElementById("articleAuthor").value = article.author || "";
            document.getElementById("articleCategory").value = article.category || "";
            document.getElementById("articleStatus").value = article.status || "draft";
            document.getElementById("articleTags").value = article.tags ? article.tags.join(', ') : "";
            document.getElementById("articleContent").value = article.content || "";
    
            document.getElementById("articleModalLabel").textContent = "ç¼–è¾‘æ–‡ç« ";
            new bootstrap.Modal(document.getElementById("articleModal")).show();
        },
    
        // ä¿å­˜æ–‡ç« ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        saveArticle: async function() {
            const token = localStorage.getItem("access_token");
            const articleId = document.getElementById("articleId").value;
            const title = document.getElementById("articleTitle").value.trim();
            const author = document.getElementById("articleAuthor").value.trim();
            const category = document.getElementById("articleCategory").value.trim();
            const status = document.getElementById("articleStatus").value;
            const tagsInput = document.getElementById("articleTags").value.trim();
            const content = document.getElementById("articleContent").value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
            if (!title || !author || !category || !content) {
                alert("æ ‡é¢˜ã€ä½œè€…ã€åˆ†ç±»å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
                return;
            }
    
            try {
                let url = "/admin/api/articles";
                let method = "POST";
                let body = {title, author, category, status, tags, content};
    
                if (articleId) {
                    url += `/${articleId}`;
                    method = "PUT";
                }
    
                const res = await fetch(url, {
                    method,
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });
    
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.detail || `HTTP ${res.status}`);
                }
    
                alert(articleId ? "æ–‡ç« æ›´æ–°æˆåŠŸ" : "æ–‡ç« åˆ›å»ºæˆåŠŸ");
                bootstrap.Modal.getInstance(document.getElementById("articleModal")).hide();
                this.loadArticles(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                console.error("ä¿å­˜æ–‡ç« å¤±è´¥:", err);
                alert("æ“ä½œå¤±è´¥ï¼š" + err.message);
            }
        },
    
        // åˆ é™¤æ–‡ç« 
        deleteArticle: async function(articleId, articleTitle) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ç« ã€Œ${articleTitle}ã€å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
    
            const token = localStorage.getItem("access_token");
    
            try {
                const res = await fetch(`/admin/api/articles/${articleId}`, {
                    method: 'DELETE',
                    headers: {"Authorization": "Bearer " + token}
                });
    
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.detail || `HTTP ${res.status}`);
                }
    
                alert("æ–‡ç« åˆ é™¤æˆåŠŸ");
                this.loadArticles();
            } catch (err) {
                console.error(err);
                alert("åˆ é™¤å¤±è´¥ï¼š" + err.message);
            }
        }
    };
    
    // å…¼å®¹å‡½æ•°ï¼Œç”¨äºå¤„ç†ArticleManageræœªå®Œå…¨åˆå§‹åŒ–çš„æƒ…å†µ
    window.loadArticles = function() {
        if (window.ArticleManager && window.ArticleManager.isInitialized) {
            window.ArticleManager.loadArticles();
        } else {
            console.log('æ–‡ç« ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–ï¼Œå»¶è¿ŸåŠ è½½...');
            setTimeout(() => {
                if (window.ArticleManager && window.ArticleManager.isInitialized) {
                    window.ArticleManager.loadArticles();
                } else {
                    console.log('æ–‡ç« ç®¡ç†å™¨ä»æœªåˆå§‹åŒ–ï¼Œç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ...');
                }
            }, 500);
        }
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²åŠ è½½
        setTimeout(() => {
            if (window.ArticleManager) {
                window.ArticleManager.init();
            }
        }, 100);
    });
    
    // ç›‘å¬å¯¼èˆªåˆ‡æ¢
    const articlesObserver = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (window.ArticleManager && window.ArticleManager.isPageVisible()) {
                    window.ArticleManager.loadArticles();
                }
            }
        });
    });
    
    // ç­‰å¾…DOMåŠ è½½å®Œæˆåè®¾ç½®è§‚å¯Ÿå™¨
    document.addEventListener('DOMContentLoaded', function() {
        const articlesDiv = document.getElementById('articles');
        if (articlesDiv) {
            articlesObserver.observe(articlesDiv, {attributes: true});
        }
    });
    
    // å…¨å±€å‡½æ•°ï¼Œç”¨äºæŒ‰é’®ç‚¹å‡»
    function createNewArticle() {
        window.location.href = "/admin/articles/new";
    }
    
    function editArticle(articleId) {
        if (window.ArticleManager) {
            window.ArticleManager.editArticle(articleId);
        }
    }
    
    function saveArticle() {
        if (window.ArticleManager) {
            window.ArticleManager.saveArticle();
        }
    }
    
    function deleteArticle(articleId, articleTitle) {
        if (window.ArticleManager) {
            window.ArticleManager.deleteArticle(articleId, articleTitle);
        }
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(/\//g, '-');
    }
</script>