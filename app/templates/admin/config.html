<!-- config.html -->
<div class="container-fluid">
    <h2 class="mb-4">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>

    <!-- æ“ä½œåŒº -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-success" onclick="openEditConfigModal()">
                âœï¸ ç¼–è¾‘é…ç½®
            </button>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">ğŸ’¡ é…ç½®å˜æ›´åéœ€é‡å¯åº”ç”¨ç”Ÿæ•ˆ</small>
        </div>
    </div>

    <!-- é…ç½®è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>é…ç½®é”®</th>
                            <th>å½“å‰å€¼</th>
                            <th>æè¿°</th>
                            <th>åˆ†ç»„</th>
                            <th>æœ€åæ›´æ–°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="configTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-4">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘é…ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configModalLabel">ç¼–è¾‘ç³»ç»Ÿé…ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="configKey" />
                <div class="mb-3">
                    <label class="form-label">é…ç½®é”® <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="configKeyInput" placeholder="å¦‚ï¼šsite_title" readonly />
                </div>
                <div class="mb-3">
                    <label class="form-label">é…ç½®å€¼ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="configValue" placeholder="è¯·è¾“å…¥é…ç½®å€¼" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-control" id="configDescription" rows="2" placeholder="é…ç½®ç”¨é€”æè¿°"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">åˆ†ç»„</label>
                    <select class="form-select" id="configGroup">
                        <option value="site">ç½‘ç«™ä¿¡æ¯</option>
                        <option value="seo">SEOè®¾ç½®</option>
                        <option value="email">é‚®ä»¶é…ç½®</option>
                        <option value="cache">ç¼“å­˜è®¾ç½®</option>
                    </select>
                </div>

                <hr />
                <h6>é…ç½®åˆ†ç»„è¯¦æƒ…</h6>
                <small class="text-muted">æ ¹æ®åˆ†ç»„é€‰æ‹©é€‚ç”¨é…ç½®</small>

                <!-- åˆ†ç»„è¯¦æƒ… -->
                <div class="accordion" id="configAccordion">
                    <!-- ç½‘ç«™ä¿¡æ¯ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSite">
                                ğŸŒ ç½‘ç«™ä¿¡æ¯
                            </button>
                        </h2>
                        <div id="collapseSite" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <p>site_title: ç«™ç‚¹æ ‡é¢˜</p>
                                <p>site_description: ç«™ç‚¹æè¿°</p>
                                <p>site_logo: Logo URL</p>
                            </div>
                        </div>
                    </div>

                    <!-- SEOè®¾ç½® -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeo">
                                ğŸ” SEOè®¾ç½®
                            </button>
                        </h2>
                        <div id="collapseSeo" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p>seo_keywords: å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</p>
                                <p>seo_meta: Metaæè¿°</p>
                            </div>
                        </div>
                    </div>

                    <!-- é‚®ä»¶é…ç½® -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmail">
                                ğŸ“§ é‚®ä»¶é…ç½®
                            </button>
                        </h2>
                        <div id="collapseEmail" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p>email_smtp_host: SMTPä¸»æœº</p>
                                <p>email_smtp_port: SMTPç«¯å£</p>
                                <p>email_username: ç”¨æˆ·å</p>
                                <p>email_password: å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰</p>
                            </div>
                        </div>
                    </div>

                    <!-- ç¼“å­˜è®¾ç½® -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCache">
                                ğŸ—„ï¸ ç¼“å­˜è®¾ç½®
                            </button>
                        </h2>
                        <div id="collapseCache" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p>cache_enabled: å¯ç”¨ç¼“å­˜ (true/false)</p>
                                <p>cache_redis_host: Redisä¸»æœº</p>
                                <p>cache_ttl: ç¼“å­˜TTLï¼ˆç§’ï¼‰</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let configs = [];

// é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('config').classList.contains('d-none') === false) {
        loadConfigs();
    }
});

// ç›‘å¬å¯¼èˆªåˆ‡æ¢
const configObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const configDiv = document.getElementById('config');
            if (configDiv && !configDiv.classList.contains('d-none')) {
                loadConfigs();
            }
        }
    });
});
configObserver.observe(document.getElementById('config'), { attributes: true });

// åŠ è½½é…ç½®åˆ—è¡¨
async function loadConfigs() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        window.location.href = "/login?next=/admin/";
        return;
    }

    try {
        const res = await fetch("/admin/api/config", {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        configs = data.items || [];

        renderConfigsTable();

    } catch (err) {
        console.error("åŠ è½½é…ç½®å¤±è´¥:", err);
        document.getElementById("configTableBody").innerHTML = `
            <tr><td colspan="6" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
        `;
    }
}

// æ¸²æŸ“é…ç½®è¡¨æ ¼
function renderConfigsTable() {
    const tbody = document.getElementById("configTableBody");
    if (configs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">æš‚æ— é…ç½®æ•°æ®</td></tr>`;
        return;
    }

    tbody.innerHTML = configs.map(config => `
        <tr>
            <td><strong>${escapeHtml(config.key)}</strong></td>
            <td>${escapeHtml(config.value || '-')}</td>
            <td>${escapeHtml(config.description || '-')}</td>
            <td><span class="badge bg-info">${escapeHtml(config.group || '-')}</span></td>
            <td>${formatDate(config.updated_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary"
                        onclick="editConfig('${config.id}')">ç¼–è¾‘</button>
            </td>
        </tr>
    `).join('');
}

// æ‰“å¼€ç¼–è¾‘é…ç½®æ¨¡æ€æ¡†
function openEditConfigModal() {
    // é»˜è®¤æ–°å¢æ¨¡å¼ï¼Œæ¸…ç©ºè¡¨å•
    document.getElementById("configKey").value = "";
    document.getElementById("configKeyInput").value = "";
    document.getElementById("configValue").value = "";
    document.getElementById("configDescription").value = "";
    document.getElementById("configGroup").value = "site";
    document.getElementById("configModalLabel").textContent = "æ–°å¢é…ç½®";
    new bootstrap.Modal(document.getElementById("configModal")).show();
}

// ç¼–è¾‘é…ç½®
function editConfig(configId) {
    const config = configs.find(c => c.id === configId);
    if (!config) return;

    document.getElementById("configKey").value = config.id;
    document.getElementById("configKeyInput").value = config.key;
    document.getElementById("configValue").value = config.value || "";
    document.getElementById("configDescription").value = config.description || "";
    document.getElementById("configGroup").value = config.group || "site";
    document.getElementById("configModalLabel").textContent = "ç¼–è¾‘é…ç½®";
    new bootstrap.Modal(document.getElementById("configModal")).show();
}

// ä¿å­˜é…ç½®ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
async function saveConfig() {
    const token = localStorage.getItem("access_token");
    const configId = document.getElementById("configKey").value;
    const key = document.getElementById("configKeyInput").value.trim();
    const value = document.getElementById("configValue").value.trim();
    const description = document.getElementById("configDescription").value.trim();
    const group = document.getElementById("configGroup").value;

    if (!key || !value) {
        alert("é…ç½®é”®å’Œå€¼ä¸èƒ½ä¸ºç©º");
        return;
    }

    try {
        let url = "/admin/api/config";
        let method = "POST";
        let body = { key, value, description, group };

        if (configId) {
            url += `/${configId}`;
            method = "PUT";
            body = { ...body, key }; // PUTæ—¶keyä¸å¯å˜ï¼Œä½†åŒ…å«ä»¥é˜²
        }

        const res = await fetch(url, {
            method,
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.detail || `HTTP ${res.status}`);
        }

        alert(configId ? "é…ç½®æ›´æ–°æˆåŠŸ" : "é…ç½®åˆ›å»ºæˆåŠŸ");
        bootstrap.Modal.getInstance(document.getElementById("configModal")).hide();
        loadConfigs(); // åˆ·æ–°åˆ—è¡¨
    } catch (err) {
        console.error("ä¿å­˜é…ç½®å¤±è´¥:", err);
        alert("æ“ä½œå¤±è´¥ï¼š" + err.message);
    }
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(/\//g, '-');
}
</script>