<!-- users.html -->
<div class="container-fluid">
    <h2 class="mb-4">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>

    <!-- æ“ä½œåŒºï¼šæœç´¢ + ç­›é€‰ + æ–°å¢ + å¯¼å‡º -->
    <div class="row mb-3 g-2 align-items-end">
        <!-- æœç´¢æ¡† -->
        <div class="col-md-3">
            <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å/é‚®ç®±"/>
        </div>
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="active">å·²å¯ç”¨</option>
                <option value="disabled">å·²ç¦ç”¨</option>
            </select>
        </div>
        <!-- è§’è‰²ç­›é€‰ -->
        <div class="col-md-2">
            <select class="form-select" id="roleFilter">
                <option value="">æ‰€æœ‰è§’è‰²</option>
                <option value="user">æ™®é€šç”¨æˆ·</option>
                <option value="vip">VIPç”¨æˆ·</option>
                <option value="editor">ç¼–è¾‘</option>
            </select>
        </div>
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="col-md-5 text-end">
            <button class="btn btn-success me-2" onclick="openCreateUserModal()">
                â• æ–°å¢ç”¨æˆ·
            </button>
            <button class="btn btn-outline-secondary me-2" onclick="exportUsers()">
                ğŸ“¥ å¯¼å‡º Excel
            </button>
            <button class="btn btn-outline-primary" onclick="applyFilter()">
                ğŸ” æŸ¥è¯¢
            </button>
        </div>
    </div>

    <!-- ç”¨æˆ·è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"/>
                        </th>
                        <th>ID</th>
                        <th>ç”¨æˆ·å</th>
                        <th>é‚®ç®±</th>
                        <th>è§’è‰²</th>
                        <th>çŠ¶æ€</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æœ€åç™»å½•</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <tr>
                        <td colspan="9" class="text-center py-4">åŠ è½½ä¸­...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <span id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 10 é¡µ</span>
        </div>
        <nav>
            <ul class="pagination mb-0" id="pagination">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </nav>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">æ–°å¢ç”¨æˆ·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId"/>
                <div class="mb-3">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="username" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" class="form-control" id="email" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">è§’è‰²</label>
                    <select class="form-select" id="role">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="vip">VIPç”¨æˆ·</option>
                        <option value="editor">ç¼–è¾‘</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                    <input type="password" class="form-control" id="password" placeholder="******"/>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="status" checked/>
                    <label class="form-check-label" for="status">å¯ç”¨è´¦æˆ·</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    let totalPages = 1;
    let users = [];

    // é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('users').classList.contains('d-none') === false) {
            loadUsers();
        }
    });

    // ç›‘å¬å¯¼èˆªåˆ‡æ¢
    const usersObserver = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const usersDiv = document.getElementById('users');
                if (usersDiv && !usersDiv.classList.contains('d-none')) {
                    loadUsers();
                }
            }
        });
    });
    usersObserver.observe(document.getElementById('users'), {attributes: true});

    // åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆå¸¦åˆ†é¡µã€ç­›é€‰ï¼‰
    async function loadUsers(page = 1) {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            window.location.href = "/login?next=/admin/";
            return;
        }

        const search = document.getElementById("searchInput").value.trim();
        const status = document.getElementById("statusFilter").value;
        const role = document.getElementById("roleFilter").value;

        try {
            const params = new URLSearchParams({
                page: page,
                page_size: 10,
                ...(search && {search}),
                ...(status && {status}),
                ...(role && {role})
            });

            const res = await fetch(`/admin/api/users?${params.toString()}`, {
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            users = data.items || [];
            currentPage = data.page || 1;
            totalPages = data.total_pages || 1;

            renderUsersTable();
            renderPagination();
            updatePageInfo();

        } catch (err) {
            console.error("åŠ è½½ç”¨æˆ·å¤±è´¥:", err);
            document.getElementById("usersTableBody").innerHTML = `
            <tr><td colspan="9" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>
        `;
        }
    }

    // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
    function renderUsersTable() {
        const tbody = document.getElementById("usersTableBody");
        if (users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>`;
            return;
        }

        tbody.innerHTML = users.map(user => `
        <tr>
            <td><input type="checkbox" class="user-checkbox" value="${user.id}" /></td>
            <td>${user.id}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${escapeHtml(user.email)}</td>
            <td><span class="badge bg-secondary">${user.role}</span></td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           ${user.status === 'active' ? 'checked' : ''}
                           onchange="toggleUserStatus(${user.id}, this)" />
                </div>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>${user.last_login ? formatDate(user.last_login) : 'ä»æœªç™»å½•'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1"
                        onclick="editUser(${user.id})">ç¼–è¾‘</button>
                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteUser(${user.id})">åˆ é™¤</button>
            </td>
        </tr>
    `).join('');
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = '';

        // ä¸Šä¸€é¡µ
        const prevItem = document.createElement("li");
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#">Â«</a>`;
        prevItem.onclick = (e) => {
            e.preventDefault();
            if (currentPage > 1) loadUsers(currentPage - 1);
        };
        pagination.appendChild(prevItem);

        // é¡µç ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);

        for (let i = startPage; i <= endPage; i++) {
            const item = document.createElement("li");
            item.className = `page-item ${i === currentPage ? 'active' : ''}`;
            item.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            item.onclick = (e) => {
                e.preventDefault();
                loadUsers(i);
            };
            pagination.appendChild(item);
        }

        // ä¸‹ä¸€é¡µ
        const nextItem = document.createElement("li");
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#">Â»</a>`;
        nextItem.onclick = (e) => {
            e.preventDefault();
            if (currentPage < totalPages) loadUsers(currentPage + 1);
        };
        pagination.appendChild(nextItem);
    }

    // æ›´æ–°é¡µç ä¿¡æ¯
    function updatePageInfo() {
        document.getElementById("pageInfo").textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
    }

    // åº”ç”¨ç­›é€‰
    function applyFilter() {
        loadUsers(1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.user-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
    async function toggleUserStatus(userId, checkbox) {
        const token = localStorage.getItem("access_token");
        const newStatus = checkbox.checked ? 'active' : 'disabled';

        try {
            const res = await fetch(`/admin/api/users/${userId}/status`, {
                method: 'PATCH',
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({status: newStatus})
            });

            if (!res.ok) throw new Error("æ›´æ–°çŠ¶æ€å¤±è´¥");

            alert(`ç”¨æˆ·çŠ¶æ€å·²${newStatus === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        } catch (err) {
            console.error(err);
            checkbox.checked = !checkbox.checked; // å›æ»š
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }

    // ç¼–è¾‘ç”¨æˆ·
    function editUser(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;

        document.getElementById("userId").value = user.id;
        document.getElementById("username").value = user.username;
        document.getElementById("email").value = user.email;
        document.getElementById("role").value = user.role;
        document.getElementById("password").value = ""; // å¯†ç ç•™ç©º
        document.getElementById("status").checked = user.status === 'active';

        document.getElementById("userModalLabel").textContent = "ç¼–è¾‘ç”¨æˆ·";
        new bootstrap.Modal(document.getElementById("userModal")).show();
    }

    // æ‰“å¼€æ–°å¢ç”¨æˆ·æ¨¡æ€æ¡†
    function openCreateUserModal() {
        document.getElementById("userId").value = "";
        document.getElementById("username").value = "";
        document.getElementById("email").value = "";
        document.getElementById("role").value = "user";
        document.getElementById("password").value = "";
        document.getElementById("status").checked = true;

        document.getElementById("userModalLabel").textContent = "æ–°å¢ç”¨æˆ·";
        new bootstrap.Modal(document.getElementById("userModal")).show();
    }

    // ä¿å­˜ç”¨æˆ·ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
    async function saveUser() {
        const token = localStorage.getItem("access_token");
        const userId = document.getElementById("userId").value;
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const role = document.getElementById("role").value;
        const password = document.getElementById("password").value;
        const status = document.getElementById("status").checked ? 'active' : 'disabled';

        if (!username || !email) {
            alert("ç”¨æˆ·åå’Œé‚®ç®±ä¸èƒ½ä¸ºç©º");
            return;
        }

        try {
            let url = "/admin/api/users";
            let method = "POST";
            let body = {username, email, role, status};

            if (password) body.password = password;
            if (userId) {
                url += `/${userId}`;
                method = "PUT";
            }

            const res = await fetch(url, {
                method,
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            alert(userId ? "ç”¨æˆ·æ›´æ–°æˆåŠŸ" : "ç”¨æˆ·åˆ›å»ºæˆåŠŸ");
            bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
            loadUsers(currentPage); // åˆ·æ–°å½“å‰é¡µ
        } catch (err) {
            console.error("ä¿å­˜ç”¨æˆ·å¤±è´¥:", err);
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–é‡è¯•");
        }
    }

    // åˆ é™¤ç”¨æˆ·
    async function deleteUser(userId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;

        const token = localStorage.getItem("access_token");

        try {
            const res = await fetch(`/admin/api/users/${userId}`, {
                method: 'DELETE',
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) throw new Error("åˆ é™¤å¤±è´¥");

            alert("ç”¨æˆ·åˆ é™¤æˆåŠŸ");
            loadUsers(currentPage);
        } catch (err) {
            console.error(err);
            alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }

    // å¯¼å‡ºç”¨æˆ·
    function exportUsers() {
        const token = localStorage.getItem("access_token");
        const search = document.getElementById("searchInput").value.trim();
        const status = document.getElementById("statusFilter").value;
        const role = document.getElementById("roleFilter").value;

        const params = new URLSearchParams({
            ...(search && {search}),
            ...(status && {status}),
            ...(role && {role}),
            export: 'excel'
        });

        window.open(`/admin/api/users/export?${params.toString()}`, '_blank');
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(/\//g, '-');
    }
</script>