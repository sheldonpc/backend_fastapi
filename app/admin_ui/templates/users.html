<!-- users.html -->
<div class="container-fluid">
    <h2 class="mb-4">👥 用户管理</h2>

    <!-- 操作区：搜索 + 筛选 + 新增 + 导出 -->
    <div class="row mb-3 g-2 align-items-end">
        <!-- 搜索框 -->
        <div class="col-md-3">
            <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名/邮箱"/>
        </div>
        <!-- 状态筛选 -->
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">所有状态</option>
                <option value="active">已启用</option>
                <option value="disabled">已禁用</option>
            </select>
        </div>
        <!-- 角色筛选 -->
        <div class="col-md-2">
            <select class="form-select" id="roleFilter">
                <option value="">所有角色</option>
                <option value="user">普通用户</option>
                <option value="vip">VIP用户</option>
                <option value="editor">编辑</option>
            </select>
        </div>
        <!-- 操作按钮 -->
        <div class="col-md-5 text-end">
            <button class="btn btn-success me-2" onclick="openCreateUserModal()">
                ➕ 新增用户
            </button>
            <button class="btn btn-outline-secondary me-2" onclick="exportUsers()">
                📥 导出 Excel
            </button>
            <button class="btn btn-outline-primary" onclick="applyFilter()">
                🔍 查询
            </button>
        </div>
    </div>

    <!-- 用户表格 -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"/>
                        </th>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>注册时间</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <tr>
                        <td colspan="9" class="text-center py-4">加载中...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分页控件 -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <span id="pageInfo">第 1 页，共 10 页</span>
        </div>
        <nav>
            <ul class="pagination mb-0" id="pagination">
                <!-- 动态生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 新增/编辑用户模态框 -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">新增用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId"/>
                <div class="mb-3">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-control" id="username" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">邮箱</label>
                    <input type="email" class="form-control" id="email" required/>
                </div>
                <div class="mb-3">
                    <label class="form-label">角色</label>
                    <select class="form-select" id="role">
                        <option value="user">普通用户</option>
                        <option value="vip">VIP用户</option>
                        <option value="editor">编辑</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">密码（留空则不修改）</label>
                    <input type="password" class="form-control" id="password" placeholder="******"/>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="status" checked/>
                    <label class="form-check-label" for="status">启用账户</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let currentPage = 1;
    let totalPages = 1;
    let users = [];

    // 页面激活时加载数据
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('users').classList.contains('d-none') === false) {
            loadUsers();
        }
    });

    // 监听导航切换
    const usersObserver = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const usersDiv = document.getElementById('users');
                if (usersDiv && !usersDiv.classList.contains('d-none')) {
                    loadUsers();
                }
            }
        });
    });
    usersObserver.observe(document.getElementById('users'), {attributes: true});

    // 加载用户数据（带分页、筛选）
    async function loadUsers(page = 1) {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("登录已过期，请重新登录");
            window.location.href = "/login?next=/admin/";
            return;
        }

        const search = document.getElementById("searchInput").value.trim();
        const status = document.getElementById("statusFilter").value;
        const role = document.getElementById("roleFilter").value;

        try {
            const params = new URLSearchParams({
                page: page,
                page_size: 10,
                ...(search && {search}),
                ...(status && {status}),
                ...(role && {role})
            });

            const res = await fetch(`/admin/api/users?${params.toString()}`, {
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            users = data.items || [];
            currentPage = data.page || 1;
            totalPages = data.total_pages || 1;

            renderUsersTable();
            renderPagination();
            updatePageInfo();

        } catch (err) {
            console.error("加载用户失败:", err);
            document.getElementById("usersTableBody").innerHTML = `
            <tr><td colspan="9" class="text-center text-danger">加载失败，请重试</td></tr>
        `;
        }
    }

    // 渲染用户表格
    function renderUsersTable() {
        const tbody = document.getElementById("usersTableBody");
        if (users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center">暂无用户数据</td></tr>`;
            return;
        }

        tbody.innerHTML = users.map(user => `
        <tr>
            <td><input type="checkbox" class="user-checkbox" value="${user.id}" /></td>
            <td>${user.id}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${escapeHtml(user.email)}</td>
            <td><span class="badge bg-secondary">${user.role}</span></td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox"
                           ${user.status === 'active' ? 'checked' : ''}
                           onchange="toggleUserStatus(${user.id}, this)" />
                </div>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>${user.last_login ? formatDate(user.last_login) : '从未登录'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1"
                        onclick="editUser(${user.id})">编辑</button>
                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteUser(${user.id})">删除</button>
            </td>
        </tr>
    `).join('');
    }

    // 渲染分页
    function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = '';

        // 上一页
        const prevItem = document.createElement("li");
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#">«</a>`;
        prevItem.onclick = (e) => {
            e.preventDefault();
            if (currentPage > 1) loadUsers(currentPage - 1);
        };
        pagination.appendChild(prevItem);

        // 页码（最多显示5个）
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);

        for (let i = startPage; i <= endPage; i++) {
            const item = document.createElement("li");
            item.className = `page-item ${i === currentPage ? 'active' : ''}`;
            item.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            item.onclick = (e) => {
                e.preventDefault();
                loadUsers(i);
            };
            pagination.appendChild(item);
        }

        // 下一页
        const nextItem = document.createElement("li");
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#">»</a>`;
        nextItem.onclick = (e) => {
            e.preventDefault();
            if (currentPage < totalPages) loadUsers(currentPage + 1);
        };
        pagination.appendChild(nextItem);
    }

    // 更新页码信息
    function updatePageInfo() {
        document.getElementById("pageInfo").textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
    }

    // 应用筛选
    function applyFilter() {
        loadUsers(1); // 重置到第一页
    }

    // 全选/取消全选
    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.user-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // 切换用户状态
    async function toggleUserStatus(userId, checkbox) {
        const token = localStorage.getItem("access_token");
        const newStatus = checkbox.checked ? 'active' : 'disabled';

        try {
            const res = await fetch(`/admin/api/users/${userId}/status`, {
                method: 'PATCH',
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({status: newStatus})
            });

            if (!res.ok) throw new Error("更新状态失败");

            alert(`用户状态已${newStatus === 'active' ? '启用' : '禁用'}`);
        } catch (err) {
            console.error(err);
            checkbox.checked = !checkbox.checked; // 回滚
            alert("操作失败，请重试");
        }
    }

    // 编辑用户
    function editUser(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;

        document.getElementById("userId").value = user.id;
        document.getElementById("username").value = user.username;
        document.getElementById("email").value = user.email;
        document.getElementById("role").value = user.role;
        document.getElementById("password").value = ""; // 密码留空
        document.getElementById("status").checked = user.status === 'active';

        document.getElementById("userModalLabel").textContent = "编辑用户";
        new bootstrap.Modal(document.getElementById("userModal")).show();
    }

    // 打开新增用户模态框
    function openCreateUserModal() {
        document.getElementById("userId").value = "";
        document.getElementById("username").value = "";
        document.getElementById("email").value = "";
        document.getElementById("role").value = "user";
        document.getElementById("password").value = "";
        document.getElementById("status").checked = true;

        document.getElementById("userModalLabel").textContent = "新增用户";
        new bootstrap.Modal(document.getElementById("userModal")).show();
    }

    // 保存用户（新增或编辑）
    async function saveUser() {
        const token = localStorage.getItem("access_token");
        const userId = document.getElementById("userId").value;
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const role = document.getElementById("role").value;
        const password = document.getElementById("password").value;
        const status = document.getElementById("status").checked ? 'active' : 'disabled';

        if (!username || !email) {
            alert("用户名和邮箱不能为空");
            return;
        }

        try {
            let url = "/admin/api/users";
            let method = "POST";
            let body = {username, email, role, status};

            if (password) body.password = password;
            if (userId) {
                url += `/${userId}`;
                method = "PUT";
            }

            const res = await fetch(url, {
                method,
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            alert(userId ? "用户更新成功" : "用户创建成功");
            bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
            loadUsers(currentPage); // 刷新当前页
        } catch (err) {
            console.error("保存用户失败:", err);
            alert("操作失败，请检查输入或重试");
        }
    }

    // 删除用户
    async function deleteUser(userId) {
        if (!confirm("确定要删除此用户吗？此操作不可恢复！")) return;

        const token = localStorage.getItem("access_token");

        try {
            const res = await fetch(`/admin/api/users/${userId}`, {
                method: 'DELETE',
                headers: {"Authorization": "Bearer " + token}
            });

            if (!res.ok) throw new Error("删除失败");

            alert("用户删除成功");
            loadUsers(currentPage);
        } catch (err) {
            console.error(err);
            alert("删除失败，请重试");
        }
    }

    // 导出用户
    function exportUsers() {
        const token = localStorage.getItem("access_token");
        const search = document.getElementById("searchInput").value.trim();
        const status = document.getElementById("statusFilter").value;
        const role = document.getElementById("roleFilter").value;

        const params = new URLSearchParams({
            ...(search && {search}),
            ...(status && {status}),
            ...(role && {role}),
            export: 'excel'
        });

        window.open(`/admin/api/users/export?${params.toString()}`, '_blank');
    }

    // 工具函数
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return isNaN(date) ? '' : date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).replace(/\//g, '-');
    }
</script>